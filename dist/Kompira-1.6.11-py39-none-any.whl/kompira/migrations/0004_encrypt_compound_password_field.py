# Generated by Django 3.0.5 on 2021-01-06 09:49

import logging
from django.db import migrations

logger = logging.getLogger('kompira')

#
# Ver1.6.2 以前で StringData のパスワードフィールド (Array/Dictionary) があれば、EncryptedStringData に移行する
# ただしすでにパスワードフィールドが上書きされていれば（空でなければ）無視する
#
def migrate_compound_password_field(apps, schema_editor):
    from kompira.models.core import StringData

    # Array<Password>/Dictionary<Password> フィールドの StringData -> EncryptedStringData 移行
    qs = StringData.objects.filter(field__type__in=('Array<Password>', 'Dictionary<Password>'))
    for entry in qs.distinct('field'):
        if entry.field.type == 'Array<Password>':
            value = list(qs.filter(field=entry.field).values_list('value', flat=True).order_by('id'))
        elif entry.field.type == 'Dictionary<Password>':
            value = dict(qs.filter(field=entry.field).values_list('key', 'value').order_by('id'))
        else:
            logger.error("migrate_compound_password_field: unexpected field type: %s", entry.field)
            continue
        if entry.field.value:
            logger.warning("migrate_compound_password_field: field overwritten already: %s", entry.field)
            continue
        entry.field.value = value
    qs.delete()


class Migration(migrations.Migration):

    dependencies = [
        ('kompira', '0003_filedata'),
    ]

    operations = [
        migrations.RunPython(migrate_compound_password_field)
    ]
