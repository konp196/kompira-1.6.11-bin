==============
Kompira の監視
==============

:著者: Kompira 開発チーム

.. highlight:: none


はじめに
========

このドキュメントでは、Zabbix などの監視システムを用いて Kompira の状態を監視する方法について説明します。

Zabbix での監視
===============

Zabbix で Kompira の動作中のプロセス数や対応中インシデントの数などを取得する方法について説明します。

Zabbix の監視方法は様々なものがありますが、ここでは Zabbix Agent の「UserParameter」 機能を用いた監視と、
「外部スクリプト」による監視の方法について説明します。

※ このドキュメントでは Zabbix 2.4 を用いた監視方法について紹介します。

準備
----

kompira_jq.sh
.............

いずれの監視方法でも、Kompira が提供するスクリプト ``kompira_jq.sh`` を利用します。

なお、「外部スクリプト」による監視の場合は Zabbix サーバ上で、「UserParameter」
による監視の場合は Zabbix Agent をインストールした Kompira サーバ上で、
``kompira_jq.sh`` を実行します。

``kompira_jq.sh`` は内部で curl コマンドおよび jq コマンドを利用していますので、
これらが利用できるよう監視方法に合わせて Zabbix サーバまたは Kompira サーバに、
必要なパッケージをインストールしておいてください。

※ CentOS 環境では jq は EPEL リポジトリから、AWS 環境では amzn-main リポジトリ
からインストールできます。

.. note::

    Kompira 1.4.6 以降に付属する kompira_jq.sh は REST-API 対応版になったため、
    旧バージョンに付属するものとオプション指定方法などで互換性がありません。


Kompira サーバのホスト設定
..........................

いずれの監視方法でも Kompira サーバに対してアクセスを行なうため、Kompira サーバの
URL と REST API トークンを Zabbix の「マクロ」として登録しておく必要があります。

Zabbix 上で Kompira サーバの「ホスト設定」→「マクロ」設定画面で、
以下のマクロ名で REST API トークンを設定してください。

+--------------------------+---------------------------+
| Macro                    | Value                     |
+==========================+===========================+
| ``{$KOMPIRA_URL}``       | Kompira サーバの URL      |
+--------------------------+---------------------------+
| ``{$KOMPIRA_TOKEN}``     | REST API トークン         |
+--------------------------+---------------------------+


UserParameter による監視
------------------------

こちらは Zabbix Agent が Zabbix サーバから指定された項目に対して事前に設定された
コマンドを実行することで、監視項目の値を収集する方法になります。

Zabbix Agent の設定
...................

Zabbix Agent をインストールした Kompira サーバ上に、UserParameter の設定ファイルを準備する必要があります。
``/etc/zabbix/zabbix_agentd.d`` に :download:`userparameter_kompira.conf` をコピーしてください。

設定ファイルが準備できたら Zabbix Agent を再起動してください。 ::

    $ sudo service zabbix-agent restart
    Shutting down Zabbix agent:                                [  OK  ]
    Starting Zabbix agent:                                     [  OK  ]


Zabbix Server の設定
....................

Zabbix Server には UserParameter を利用した監視項目を設定する必要がありますが、
:download:`zbx_kompira_basic_templates.xml` をインポートすることで標準的な監視項目をすぐに利用できます。

`Template Kompira Server` という名前のテンプレートが作成されますので、
監視したい Kompira サーバにこのテンプレートを適用してください。


監視項目
........

標準で以下の監視項目を利用可能です。

+----------------------------------------------------+------------------------------------+
| Name                                               | 概要                               |
+====================================================+====================================+
| Kompira active incidents                           | アクティブなインシデント数         |
+----------------------------------------------------+------------------------------------+
| Kompira active processes                           | アクティブなプロセス数             |
+----------------------------------------------------+------------------------------------+
| Kompira active schedulers                          | アクティブなスケジュール数         |
+----------------------------------------------------+------------------------------------+
| Kompira active tasks                               | アクティブなタスク数               |
+----------------------------------------------------+------------------------------------+
| Kompira jobflows                                   | ジョブフロー総数                   |
+----------------------------------------------------+------------------------------------+
| Kompira license remain_days                        | ライセンスの残り日数               |
+----------------------------------------------------+------------------------------------+
| Kompira objects                                    | Kompira オブジェクト総数           |
+----------------------------------------------------+------------------------------------+
| Memory usage of kompirad process                   | メモリ使用量(kompirad)             |
+----------------------------------------------------+------------------------------------+
| Memory usage of kompira_jobmngrd process           | メモリ使用量(kompira_jobmngrd)     |
+----------------------------------------------------+------------------------------------+
| Number of kompirad process                         | プロセス数(kompirad)               |
+----------------------------------------------------+------------------------------------+
| Number of kompira_jobmngrd process                 | プロセス数(kompira_jobmngrd)       |
+----------------------------------------------------+------------------------------------+



外部スクリプトによる監視
------------------------

こちらは Zabbix サーバ上で外部のスクリプトを実行して、監視項目の値を収集する
方法になります。

まず、Kompira が提供するスクリプト ``/opt/kompira/bin/kompira_jq.sh`` を、
Zabbix サーバ上の外部スクリプトを配置するディレクトリにコピーしておいてください。
デフォルトでは ``/usr/lib/zabbix/externalscripts`` になります。

プロセス数
..........

外部スクリプト ``kompira_jq.sh`` を用いてプロセス数を監視する場合、以下のような設定で Item を作成してください。

+-----------------------+-------------------------------------------------------------------------+
| Name                  | ``Kompira processes``                                                   |
+-----------------------+-------------------------------------------------------------------------+
| Type                  | External check                                                          |
+-----------------------+-------------------------------------------------------------------------+
| Key                   | ``kompira_jq.sh[-s,{$KOMPIRA_URL},-t,{$KOMPIRA_TOKEN},-ac,/process]``   |
+-----------------------+-------------------------------------------------------------------------+
| Type of information   | Numeric (unsigned)                                                      |
+-----------------------+-------------------------------------------------------------------------+
| Data type             | Decimal                                                                 |
+-----------------------+-------------------------------------------------------------------------+


インシデント数
..............

外部スクリプト ``kompira_jq.sh`` を用いてインシデント数を監視する場合、以下のような設定で Item を作成してください。

+-----------------------+-------------------------------------------------------------------------+
| Name                  | ``Kompira incidents``                                                   |
+-----------------------+-------------------------------------------------------------------------+
| Type                  | External check                                                          |
+-----------------------+-------------------------------------------------------------------------+
| Key                   | ``kompira_jq.sh[-s,{$KOMPIRA_URL},-t,{$KOMPIRA_TOKEN},-ac,/incident]``  |
+-----------------------+-------------------------------------------------------------------------+
| Type of information   | Numeric (unsigned)                                                      |
+-----------------------+-------------------------------------------------------------------------+
| Data type             | Decimal                                                                 |
+-----------------------+-------------------------------------------------------------------------+


