
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>1. 管理ガイド &#8212; Kompira 1.6.11 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="2. 操作ガイド" href="usage.html" />
    <link rel="prev" title="Kompira 1.6.11 ドキュメント" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="usage.html" title="2. 操作ガイド"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="index.html" title="Kompira 1.6.11 ドキュメント"
             accesskey="P">前へ</a> |</li>
<li class="nav-item nav-item-0"><a href="index.html">Kompira 1.6.11 ドキュメント</a> [<a href="../en/admin.html">en</a>|<a href="./kompira.pdf" target="_blank">pdf</a>] &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">1. </span>管理ガイド</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="id1">
<h1><span class="section-number">1. </span>管理ガイド<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">著者<span class="colon">:</span></dt>
<dd class="field-odd"><p>Kompira 開発チーム</p>
</dd>
</dl>
<section id="admin-introduction">
<span id="id2"></span><h2><span class="section-number">1.1. </span>はじめに<a class="headerlink" href="#admin-introduction" title="この見出しへのパーマリンク">¶</a></h2>
<p>このマニュアルでは、Kompiraを管理するための情報について記述します。</p>
<p>インストール、アップデート、Kompira全体の設定、ログなどについて知りたい場合には本マニュアルを参照してください。</p>
<p>本マニュアルでは、Linux上でのコマンド実行プロンプトとして一般ユーザーの場合は <code class="docutils literal notranslate"><span class="pre">$</span></code>、ルート権限ユーザーの場合は <code class="docutils literal notranslate"><span class="pre">#</span></code> を表記します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo &#39;一般ユーザーでコマンド実行&#39;
# echo &#39;ルート権限ユーザーでコマンド実行&#39;
</pre></div>
</div>
</section>
<section id="kompira">
<span id="package"></span><h2><span class="section-number">1.2. </span>Kompiraパッケージ管理<a class="headerlink" href="#kompira" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompira関連パッケージのインストールとアップデートについて説明します。</p>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<p>本節ではKompiraパッケージを単一のサーバ上で動作させる場合についてのみ説明をしています。
Kompiraを冗長構成で動作させたい場合は <a class="reference internal" href="#ha"><span class="std std-ref">冗長構成管理</span></a> を参照してください。</p>
</div>
<section id="package-kind">
<span id="id3"></span><h3><span class="section-number">1.2.1. </span>インストールパッケージの種類<a class="headerlink" href="#package-kind" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraには以下に示す種類のパッケージが存在しています。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>パッケージ名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Kompiraパッケージ</p></td>
<td><p>Kompiraの本体にあたるパッケージです。
Kompiraのコア機能群、ジョブマネージャ、
イベント送信スクリプトを含みます。</p></td>
</tr>
<tr class="row-odd"><td><p>ジョブマネージャパッケージ</p></td>
<td><p>ジョブマネージャとイベント送信スクリプトを含む
パッケージです。</p></td>
</tr>
<tr class="row-even"><td><p>イベント送信パッケージ</p></td>
<td><p>イベント送信スクリプトを含むパッケージです。</p></td>
</tr>
</tbody>
</table>
<p>Kompiraを初めてお使いになる場合は、まずKompiraパッケージのインストールから始めてみましょう。</p>
<p>ジョブマネージャパッケージはKompiraパッケージをインストールしたサーバ以外にもジョブマネージャプロセスを起動させたい場合に使用します。</p>
<p>イベント送信パッケージは別サーバからKompiraに対してイベントを送信させたい場合に使用します。
イベント送信を利用したシステム間の連携については <a class="reference internal" href="coordination.html"><span class="doc">他システムとの連携</span></a> を参照してください。</p>
</section>
<section id="package-install-sh">
<span id="id4"></span><h3><span class="section-number">1.2.2. </span>インストールスクリプト<a class="headerlink" href="#package-install-sh" title="この見出しへのパーマリンク">¶</a></h3>
<p>install.shを用いることで、Kompiraの各種パッケージのインストールを行うことができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>install.sh [options]
</pre></div>
</div>
<p>インストール処理にはKompiraで使用するミドルウェアのインストール、データベースの構築、プロセスの自動起動設定が含まれます。</p>
<p>install.shはコマンドの成功・失敗に関わらず <em>install.&lt;プロセス番号&gt;.log</em> という名称のログファイルを作成します。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>Red Hat にインストールする場合は、事前にサブスクリプションを登録しておく必要があります。</p>
</div>
<section id="id5">
<h4><span class="section-number">1.2.2.1. </span>制限<a class="headerlink" href="#id5" title="この見出しへのパーマリンク">¶</a></h4>
<p>install.sh は RHEL/CentOS でのインストールのみサポートしています。</p>
<p>install.sh では外部から Kompira で使用する各種ミドルウェアをダウンロードします。
インターネットに接続可能な環境で実行してください。</p>
<p>プロキシ経由でインターネットに接続する環境の場合は以下のように --proxy オプションを付けて install.sh を実行してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ./install.sh --proxy proxy:3128
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>オプションに渡す &quot;proxy&quot; や &quot;3128&quot; の部分は導入環境のプロキシサーバ
のホスト名（またはIPアドレス）やポート番号に合わせてください。</p>
</div>
<p>認証付きプロキシサーバの場合は、以下のように &quot;user&quot; にユーザー名を、&quot;password&quot; にパスワードを指定して install.sh を実行してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ./install.sh --proxy user:password@proxy:3128
</pre></div>
</div>
</section>
<section id="id6">
<h4><span class="section-number">1.2.2.2. </span>コマンドラインオプション<a class="headerlink" href="#id6" title="この見出しへのパーマリンク">¶</a></h4>
<p>install.shに指定可能なオプションは以下の通りです。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--https</span></code></p></td>
<td><p>Kompira サーバに対するアクセスをHTTPSのみに制限します（Kompira v1.5.0 からデフォルト）。
HTTPでアクセスすると自動的にHTTPSにリダイレクトされるようになります。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--no-https</span></code></p></td>
<td><p>Kompira サーバに対する HTTP アクセスを許容します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--amqps</span></code></p></td>
<td><p>Kompira サーバに対する AMQP のアクセスを SSL で保護します（Kompira v1.6.8 からデフォルト）。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--amqps-verify</span></code></p></td>
<td><p>Kompira サーバに対する AMQP のアクセスを SSL で保護します (SSL証明書の検証を伴います)。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--no-ampqs</span></code></p></td>
<td><p>Kompira サーバに対する AMQP のアクセスを SSL で保護しません。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--allow-insecure-amqp</span></code></p></td>
<td><p>Kompira サーバに対する外部からの非 SSL での AMQP アクセスを許可します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--backup</span></code></p></td>
<td><p>データベースのバックアップ取得およびリストア処理を指示します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--no-backup</span></code></p></td>
<td><p>データベースのバックアップ取得およびリストア処理をスキップします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--backup-process</span></code></p></td>
<td><p>データベースのバックアップ取得時にプロセスオブジェクトを含めるようにします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--no-backup-process</span></code></p></td>
<td><p>データベースのバックアップ取得時にプロセスオブジェクトを含めないようにします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--rhui</span></code></p></td>
<td><p>RHUI モードでインストールします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--rhel-option-repo</span> <span class="pre">&lt;repo&gt;</span></code></p></td>
<td><p>RHEL レポジトリを指定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--skip-python3-install</span></code></p></td>
<td><p>Python3 のインストールをスキップします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--skip-cluster-start</span></code></p></td>
<td><p>冗長構成時の更新インストールで冗長構成の起動 (pcs cluster start)をスキップします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--skip-rabbitmq-update</span></code></p></td>
<td><p>rabbitmq-server のアップデートをスキップします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--skip-postgresql-update</span></code></p></td>
<td><p>postgresql のアップデートをスキップします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--rabbitmq-version</span> <span class="pre">&lt;ver&gt;</span></code></p></td>
<td><p>インストールする rabbitmq-server バージョンを指定します。(3.10.* など)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--postgresql-version</span> <span class="pre">&lt;ver&gt;</span></code></p></td>
<td><p>インストールする postgresql バージョンを指定します。(16 や 16.4 や 16.* など)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--initdata</span></code></p></td>
<td><p>明示的にデータベースを初期化します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--initfile</span></code></p></td>
<td><p>明示的に添付ファイルの保存先を初期化します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--secret-key</span> <span class="pre">&lt;secret-key&gt;</span></code></p></td>
<td><p>パスワードフィールドの暗号化用キー文字列を指定します。(キーは8文字以上)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--force</span></code></p></td>
<td><p>Kompira のメジャーバージョンが異なっていても強制的にインストールを試行します。
また既存データベースがあるときに削除確認をせず、データベース初期化してインストールを試行します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--proxy</span> <span class="pre">&lt;proxy&gt;</span></code></p></td>
<td><p>プロキシサーバのURLを指定してインストールを行います。
ここで指定したプロキシサーバは Kompira サービスの環境変数として設定され、
ジョブフローから外部 HTTP アクセスするときにも適用されます。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--temp-proxy</span> <span class="pre">&lt;proxy&gt;</span></code></p></td>
<td><p>インストール時だけ適用するプロキシサーバのURLを指定してインストールを行います。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--noproxy</span> <span class="pre">&lt;hosts&gt;</span></code></p></td>
<td><p>プロキシサーバの対象から除外するホストをコンマ区切りのリストで指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--temp-noproxy</span> <span class="pre">&lt;hosts&gt;</span></code></p></td>
<td><p>インストール時のみのプロキシの除外設定を指定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--locale-lang</span> <span class="pre">&lt;LANG&gt;</span></code></p></td>
<td><p>ロケールを指定してインストールを行ないます。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--locale-timezone</span> <span class="pre">&lt;ZONENAME&gt;</span></code></p></td>
<td><p>タイムゾーンを指定してインストールを行ないます。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--jobmngr</span> <span class="pre">&lt;kompira_ip&gt;</span></code></p></td>
<td><p>ジョブマネージャパッケージのインストール、アップデートを行います。
Kompiraパッケージをインストールしたサーバを示すホスト名もしくはIPアドレスを指定する必要があります。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--sendevt</span> <span class="pre">&lt;kompira_ip&gt;</span></code></p></td>
<td><p>イベント送信パッケージのインストール、アップデートを行います。
Kompiraパッケージをインストールしたサーバを示すホスト名もしくはIPアドレスを指定する必要があります。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--with-rpm</span> <span class="pre">&lt;rpms&gt;</span></code></p></td>
<td><p>追加でインストールする RPM パッケージを指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--with-whl</span> <span class="pre">&lt;wheels&gt;</span></code></p></td>
<td><p>追加でインストールする wheel パッケージを指定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--with-gdb</span></code></p></td>
<td><p>Kompiraのデバッグに必要なツール類をインストールします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--offline</span></code></p></td>
<td><p>kompira-extra パッケージを利用してオフラインモードでインストールします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--extra</span></code></p></td>
<td><p>オフラインインストール用の kompira-extra パッケージを作成します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--extra-without-ha</span></code></p></td>
<td><p>冗長構成用の HA パッケージは含まない kompira-extra パッケージを作成します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--install-only</span></code></p></td>
<td><p>パッケージのインストールのみ行い、完了後の各種デーモンサービスの起動は行いません。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--dry-run</span></code></p></td>
<td><p>ドライランモードで実行します。パラメータチェックのみで、実際のセットアップは行いません。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--help</span></code></p></td>
<td><p>ヘルプメッセージを表示します。</p></td>
</tr>
</tbody>
</table>
<p>jobmngr, sendevt オプションは排他です。</p>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.2 で追加: </span>--extra および --secret-key オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.4 で追加: </span>--extra-without-ha オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.6 で追加: </span>--skip-cluster-start オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.7 で追加: </span>--install-only オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.8 で追加: </span>--amqps, --amqps-verify, --no-ampqs および --allow-insecure-amqp オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.8.post2 で追加: </span>--skip-rabbitmq-update および --rabbitmq-version オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.10 で追加: </span>--backup, --no-backup-process, --skip-postgresql-update および --postgresql-version オプションが追加されました。</p>
</div>
</section>
</section>
<section id="package-kompira">
<span id="id7"></span><h3><span class="section-number">1.2.3. </span>Kompiraパッケージ<a class="headerlink" href="#package-kompira" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraの本体にあたるパッケージのインストール・アップデートについて記述します。</p>
<section id="package-kompira-install">
<span id="id8"></span><h4><span class="section-number">1.2.3.1. </span>インストール<a class="headerlink" href="#package-kompira-install" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompiraパッケージを展開し、install.shを実行します。
&lt;version&gt;はKompiraのバージョン番号に置き換えてください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh
[2020-09-17 02:00:24] ****: ****************************************************************
[2020-09-17 02:00:24] ****: Kompira-1.6.0:
[2020-09-17 02:00:24] ****: Start: Install the Kompira
[2020-09-17 02:00:24] ****:
[2020-09-17 02:00:24] INFO:     SYSTEM                   = CENT
[2020-09-17 02:00:24] INFO:     SYSTEM_NAME              = cent8
[2020-09-17 02:00:24] INFO:     SYSTEM_RELEASE           = CentOS Linux release 8.2.2004 (Core)
[2020-09-17 02:00:24] INFO:     SYSTEM_RELEASEVER        = 8.2.2004
[2020-09-17 02:00:24] INFO:     PLATFORM_PYTHON          = /usr/libexec/platform-python
[2020-09-17 02:00:24] INFO:     PYTHON                   = /bin/python3.6

...

[2020-09-17 02:02:46] ****: ----------------------------------------------------------------
[2020-09-17 02:02:46] ****: Test access to kompira.
[2020-09-17 02:02:46] ****:
[2020-09-17 02:02:48] INFO: Access succeeded:   &lt;div class=&quot;brand-version&quot;&gt;1.6.0&lt;/div&gt;
[2020-09-17 02:02:48] ****:
[2020-09-17 02:02:48] ****: Finish: Install the Kompira (status=0)
[2020-09-17 02:02:48] ****: ****************************************************************
</pre></div>
</div>
<p>インストーラは自動でKompiraパッケージのインストール処理を行います。
「Finish: Install the Kompira (status=0)」という表示があれば、正常に完了しています。</p>
<p>インストールが完了したら以下のURLに対してWebブラウザからKompiraサーバにアクセスし、
ログイン画面が表示されることを確認してください。</p>
<p>この際、サーバ証明書の警告が表示されます。この警告を表示されなくなるようにするためには、
Kompira サーバ用のSSL証明書を取得し、Kompiraサーバ上のApacheへのインストールを行ってください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>https://&lt;Hostname or ipaddress of Kompira server&gt;/
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>HTTP でアクセスする場合は --no-https オプションを付けてインストールする必要があります。</p>
</div>
<p>Webブラウザでの操作方法については、操作ガイドマニュアルを参照してください。</p>
</section>
<section id="package-kompira-update">
<span id="id9"></span><h4><span class="section-number">1.2.3.2. </span>アップデート<a class="headerlink" href="#package-kompira-update" title="この見出しへのパーマリンク">¶</a></h4>
<p>既にKompiraパッケージがインストールされている場合に、アップデートを行う方法について説明します。</p>
<p>Kompiraのバージョン番号形式は次のように定められています。</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1.&lt;major-version&gt;.&lt;minor-version&gt;
</pre></div>
</div>
</div></blockquote>
<p>マイナーバージョン番号のみが変更されるアップデートをマイナーアップデート、
メジャーバージョン番号が変更されるアップデートをメジャーアップデートと呼びます。</p>
<p>例えばバージョン1.5.0から1.5.2へのアップデートはマイナーアップデート、
バージョン1.4.10から1.5.0へのアップデートはメジャーアップデートとなります。</p>
<p>メジャーアップデートはアーキテクチャ構成やDBスキーマの定義変更を含む可能性のある
アップデートであるため、マイナーアップデートとは異なる作業が必要となる場合があります。</p>
<p>アップデートの際は、現在使用しているKompiraバージョンとアップデートするKompiraバージョンを確認の上で作業を行ってください。</p>
<p><strong>マイナーアップデート</strong></p>
<blockquote>
<div><p>マイナーアップデートの場合は、オプション無しで install.sh を起動します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh
[2020-09-17 22:56:32] ****: ****************************************************************
[2020-09-17 22:56:32] ****: Kompira-1.6.0:
[2020-09-17 22:56:32] ****: Start: Install the Kompira
[2020-09-17 22:56:32] ****:
[2020-09-17 22:56:32] INFO:     SYSTEM                   = CENT
[2020-09-17 22:56:32] INFO:     SYSTEM_NAME              = cent8
[2020-09-17 22:56:32] INFO:     SYSTEM_RELEASE           = CentOS Linux release 8.2.2004 (Core)
[2020-09-17 22:56:33] INFO:     SYSTEM_RELEASEVER        = 8.2.2004
[2020-09-17 22:56:33] INFO:     PLATFORM_PYTHON          = /usr/libexec/platform-python
[2020-09-17 22:56:33] INFO:     PYTHON                   = /bin/python3.6

...

[2020-09-17 22:57:00] ****: ----------------------------------------------------------------
[2020-09-17 22:57:00] ****: Check version of Kompira installed.
[2020-09-17 22:57:00] ****:
[2020-09-17 22:57:00] INFO: VERSION=1.6.0b4 [pip=/opt/kompira/bin/pip]
[2020-09-17 22:57:00] INFO: A compatible version is installed.

...

[2020-09-17 22:58:18] ****: ----------------------------------------------------------------
[2020-09-17 22:58:18] ****: Test access to kompira.
[2020-09-17 22:58:18] ****:
[2020-09-17 22:58:19] INFO: Access succeeded:   &lt;div class=&quot;brand-version&quot;&gt;1.6.0&lt;/div&gt;
[2020-09-17 22:58:19] ****:
[2020-09-17 22:58:19] ****: Finish: Install the Kompira (status=0)
[2020-09-17 22:58:19] ****: ****************************************************************
</pre></div>
</div>
<p>インストーラは自動でKompiraパッケージのアップデート処理を行います。
「Finish: Install the Kompira (status=0)」という表示があれば、正常に完了しています。</p>
<p>アップデートが完了したらWebブラウザからKompiraにログインし、
Kompiraのバージョン番号表記が更新されていることを確認してください。</p>
</div></blockquote>
<p><strong>メジャーアップデート</strong></p>
<blockquote>
<div><p>メジャーアップデートの場合は以下の手順でアップデートを行います。</p>
<ul class="simple">
<li><p>export_dataコマンドでKompiraに保存されているデータを取り出す</p></li>
<li><p>install.shコマンドで --initdata オプションを付けてデータベース初期化モードで Kompira をインストールする</p></li>
<li><p>import_dataコマンドで最初に取り出したデータをKompiraに保存する</p></li>
</ul>
<p>install.shコマンドを実行する時点で、既存のデータベースが初期化されることに注意してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd kompira-&lt;version&gt;-bin
$ /opt/kompira/bin/manage.py export_data --owner-mode --virtual-mode / &gt; backup.json
# ./install.sh --force --initdata
$ /opt/kompira/bin/manage.py import_data --owner-mode --overwrite-mode backup.json
[2018-04-09 21:44:15,936:30953:MainProcess] INFO: import data: start...
[2018-04-09 21:44:16,010:30953:MainProcess] INFO: import object: imported &quot;system/types/TypeObject&quot; to &quot;/system/types/TypeObject&quot; (updated)
[2018-04-09 21:44:16,022:30953:MainProcess] INFO: import object: imported &quot;system/types/Directory&quot; to &quot;/system/types/Directory&quot; (updated)
[2018-04-09 21:44:16,033:30953:MainProcess] INFO: import object: imported &quot;system&quot; to &quot;/system&quot; (updated)

...

[2018-04-09 21:44:22,126:30953:MainProcess] INFO: import fields: /user/data: []
[2018-04-09 21:44:22,164:30953:MainProcess] INFO: import fields: /user/data/nodes: []
[2018-04-09 21:44:22,202:30953:MainProcess] INFO: import fields: /user/data/accounts: []
[2018-04-09 21:44:22,218:30953:MainProcess] INFO: import data: finished (created=0, updated=59, skipped=0, error=0, warning=0)
</pre></div>
</div>
<p>install.shを実行する際は、データベースを初期化するために --initdata オプションと --force オプションを指定します。</p>
<p>import_dataの処理が完了したらWebブラウザからKompiraにログインし、
Kompiraのバージョン番号表記が更新されていること、既存のKompira上で作成していたKompiraオブジェクトが
存在することを確認してください。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>Ver.1.5以前からVer1.6へアップデートする場合、上記の手順でアップデートすることはできません。以前のバージョンのKompiraを一度削除してから、
改めて、Ver1.6を新規インストールしてください。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>Ver.1.5以前のKompiraからVer1.6へアップデートする場合、完全な互換性は保証されませんので、移行したジョブフローやライブラリオブジェクトが
そのままでは動作しない可能性があります。必要に応じて、個々のジョブフローやライブラリを修正した上で、それらの動作確認を実施してください。</p>
</div>
</div></blockquote>
</section>
<section id="postgresql">
<h4><span class="section-number">1.2.3.3. </span>PostgreSQL のアップグレード<a class="headerlink" href="#postgresql" title="この見出しへのパーマリンク">¶</a></h4>
<p>Ver.1.6.0 から Ver.1.6.9 までは PostgreSQL 12 を固定的にインストールしていましたが、PostgreSQL 12 は 2024/11 に EOL を迎えました。
そこで、Ver.1.6.10 以降の Kompira では PostgreSQL 13 以上のインストールに対応するようになりました。</p>
<ul class="simple">
<li><p>Kompira を新規インストールする場合は、その時点の Kompira が対応している最新の PostgreSQL をインストールします。</p></li>
<li><p>Kompira をアップデートする場合は、既存の PostgreSQL のメジャーバージョンを保持します。ただし PostgreSQL のマイナーアップデートは実施されます。</p></li>
</ul>
<p>いずれの場合でも、install.sh の <code class="docutils literal notranslate"><span class="pre">--postgresql-version</span></code> オプションでインストールする PostgreSQL のバージョンを指定することができます。</p>
<ul class="simple">
<li><p>install.sh に <code class="docutils literal notranslate"><span class="pre">--postgresql-version=16</span></code> や <code class="docutils literal notranslate"><span class="pre">--postgresql-version=16.*</span></code> と指定すると、指定したメジャーバージョンの最新版をインストールします。</p></li>
<li><p>install.sh に <code class="docutils literal notranslate"><span class="pre">--postgresql-version=16.4</span></code> などと指定すると、特定のバージョンをインストールします。</p></li>
</ul>
<p>Kompira のアップデート時にバージョンを指定して PostgreSQL をインストールするときに、例えば 12.17 から 17.0 など、メジャーバージョンが上がる場合を PostgreSQL のアップグレードと言います。
install.sh は PostgreSQL のアップグレードを検出すると、以下のようなメッセージを表示して実際にアップグレードを実行するか確認します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ./install.sh --postgresql-version=17

    ...

[2024-10-29 12:00:00] ****: ----------------------------------------------------------------
[2024-10-29 12:00:00] ****: Check current PostgreSQL and Kompira database existence.
[2024-10-29 12:00:00] ****:
[2024-10-29 12:00:00] INFO: CUR_PG_BINDIR=/usr/pgsql-12/bin
[2024-10-29 12:00:00] INFO: CUR_PG_DATADIR=/var/lib/pgsql/12/data
[2024-10-29 12:00:00] INFO: CUR_PG_SERVICE=postgresql-12
[2024-10-29 12:00:00] INFO: CUR_PG_VERSION=12.17
[2024-10-29 12:00:00] INFO: CUR_PG_MAJVER=12
[2024-10-29 12:00:00] INFO: Check free space for PostgreSQL migration
[2024-10-29 12:00:00] INFO: Data used:       152,856 KiB (/var/lib/pgsql/12/data)
[2024-10-29 12:00:00] INFO: Free space:    9,344,912 KiB (/var/lib/pgsql)
[2024-10-29 12:00:00] INFO: Free space rate: 6113.54% (OK)
[2024-10-29 12:00:00] WARN: PostgreSQL migration (12-&gt;17) detected, Are you sure?

MIGRATE POSTGRESQL 12 TO 17 AND CONTINUE INSTALLATION? (yes/No)
</pre></div>
</div>
<p>PostgreSQL のアップグレードを実施してインストールを継続する場合は <code class="docutils literal notranslate"><span class="pre">y</span></code> を入力してください。 <code class="docutils literal notranslate"><span class="pre">n</span></code> を入力するとインストールを中止します。
なお、install.sh に <code class="docutils literal notranslate"><span class="pre">--force</span></code> オプションを付けている場合は、この確認は行われずアップグレードとインストールを継続します。</p>
<p>PostgreSQL のアップグレードを実施する場合、install.sh 内部で PostgreSQL の pg_upgrade ユーティリティを実行して全てのデータを新しいバージョンに移行します。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>pg_upgrade はサーバ内で全てのデータをコピーすることになるため、データベースクラスタが利用しているデータ量と同程度の空き容量が必要になることに注意してください。</p>
</div>
<p>上のメッセージに既存のデータベースクラスタのデータ量と、新しいバージョンのデータベースクラスタを作成する場所の空き容量を表示しています。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2024-10-29 12:00:00] INFO: Data used:       152,856 KiB (/var/lib/pgsql/12/data)
[2024-10-29 12:00:00] INFO: Free space:    9,344,912 KiB (/var/lib/pgsql)
[2024-10-29 12:00:00] INFO: Free space rate: 6113.54% (OK)
</pre></div>
</div>
<p>上の例では十分な空き容量があることが分かります。空き容量が少ない場合は、アップグレードを実施する前に空き容量を確保することを検討してください。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>install.sh は PostgreSQL のアップグレード時に空き容量のチェックを行ないます。
既存データベースクラスタのデータ量に対して 120% に相当する空き容量が確認できない場合は、インストールを中止します。</p>
</div>
<p><strong>冗長構成における PostgreSQL のアップグレード</strong></p>
<p>冗長構成で PostgreSQL のアップグレードを実施する場合は、両系停止アップデート手順を基本とした専用の手順となります。
詳細は <a class="reference internal" href="#ha-update-with-pg-upgrade"><span class="std std-ref">PostgreSQL アップグレードを伴う両系停止アップデート手順</span></a> を参照してください。</p>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.10 で追加: </span>PostgreSQL 13 以上のインストールに対応しました。アップデート時の PostgreSQL のアップグレードに対応しました。</p>
</div>
</section>
</section>
<section id="package-jobmngr">
<span id="id10"></span><h3><span class="section-number">1.2.4. </span>ジョブマネージャパッケージ<a class="headerlink" href="#package-jobmngr" title="この見出しへのパーマリンク">¶</a></h3>
<p>ジョブマネージャとイベント送信スクリプトを含むパッケージのインストール・アップデートについて記述します。</p>
<section id="package-jobmngr-install">
<span id="id11"></span><h4><span class="section-number">1.2.4.1. </span>インストール<a class="headerlink" href="#package-jobmngr-install" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompiraパッケージを展開し、install.shを実行します。
ジョブマネージャはKompira本体と通信を行うため、Kompiraパッケージをインストールしたサーバのホスト名、もしくはIPアドレスをinstall.shの引数に指定する必要があります。</p>
<p>&lt;version&gt;はKompiraのバージョン番号に置き換えてください。</p>
<p>&lt;kompira_ip&gt;はKompiraサーバのホスト名、もしくはIPアドレスです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh --jobmngr &lt;kompira_ip&gt;
[2020-09-18 00:42:54] ****: ****************************************************************
[2020-09-18 00:42:54] ****: Kompira-1.6.0:
[2020-09-18 00:42:54] ****: Start: Install the Kompira
[2020-09-18 00:42:54] ****:
[2020-09-18 00:42:54] INFO:     SYSTEM                   = CENT
[2020-09-18 00:42:54] INFO:     SYSTEM_NAME              = cent8
[2020-09-18 00:42:54] INFO:     SYSTEM_RELEASE           = CentOS Linux release 8.2.2004 (Core)
[2020-09-18 00:42:54] INFO:     SYSTEM_RELEASEVER        = 8.2.2004
[2020-09-18 00:42:54] INFO:     PLATFORM_PYTHON          = /usr/libexec/platform-python

...

[2020-09-18 00:43:24] ****: ----------------------------------------------------------------
[2020-09-18 00:43:24] ****: Setup kompira-jobmngrd.
[2020-09-18 00:43:24] ****:

...

[2020-09-18 00:43:24] VERBOSE: run: systemctl restart kompira_jobmngrd
[2020-09-18 00:43:24] ****:
[2020-09-18 00:43:24] ****: Finish: Install the Kompira (status=0)
[2020-09-18 00:43:24] ****: ****************************************************************
</pre></div>
</div>
<p>インストーラは自動でジョブマネージャパッケージの新規インストール処理を行います。
「Finish: Install the Kompira (status=0)」という表示があれば、正常に完了しています。</p>
<p>ジョブマネージャプロセスが正しく起動しているかの確認方法については、<a class="reference internal" href="#process-jobmngr"><span class="std std-ref">Kompiraジョブマネージャの起動・停止・状態確認</span></a> を参照してください。</p>
<p>また、Kompira本体がジョブマネージャと正しく通信できているかどうかについては、Kompiraの「管理領域設定ページ」から確認することができます。
WebブラウザからKompiraにログインし、「設定」→「管理領域設定」→「default」ページを表示してください。
「ジョブマネージャ状態」の欄にジョブマネージャパッケージをインストールしたサーバのホスト名が表示されていれば、正常に通信できています。</p>
<p>なお、install.sh に --amqps-verify オプションを付けた場合は、インストール途中に指定した Kompira サーバから SSL 証明書を scp でコピーするため、以下のようにパスワードの入力が求められます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: Start copying the SSL/CA certificates from the kompira server with scp.
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: PLEASE ENTER THE PASSWORD OF THE REMOTE KOMPIRA SERVER (&lt;kompira_ip&gt;) FOR SCP.
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] VERBOSE: run: scp -q -p -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@&lt;kompira_ip&gt;:/opt/kompira/ssl/certs/{kompira-bundle-ca.crt,amqp-client-kompira{.crt,.key}} /opt/kompira/ssl/certs/
root@&lt;kompira_ip&gt;&#39;s password:

...
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>install.sh に --amqps-verify オプションを付けた場合は、Kompira サーバから SSL 証明書を scp でコピーするようになりました。</p>
</div>
</section>
<section id="package-jobmngr-update">
<span id="id12"></span><h4><span class="section-number">1.2.4.2. </span>アップデート<a class="headerlink" href="#package-jobmngr-update" title="この見出しへのパーマリンク">¶</a></h4>
<p>インストールと同様の手順を実行することで、ジョブマネージャパッケージのアップデートを行うことができます。</p>
</section>
</section>
<section id="package-sendevt">
<span id="id13"></span><h3><span class="section-number">1.2.5. </span>イベント送信パッケージ<a class="headerlink" href="#package-sendevt" title="この見出しへのパーマリンク">¶</a></h3>
<p>イベント送信スクリプトを含むパッケージのインストール・アップデートについて記述します。</p>
<p>イベント送信パッケージは、LinuxおよびWindowsへのインストールに対応しています。</p>
<section id="rhel-centos">
<span id="package-sendevt-install-linux"></span><h4><span class="section-number">1.2.5.1. </span>RHEL/CentOS へのインストール<a class="headerlink" href="#rhel-centos" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompiraパッケージを展開し、install.shを実行します。</p>
<p>イベント送信スクリプトはKompira本体にデータを送信するため、
Kompiraパッケージをインストールしたサーバのホスト名、もしくはIPアドレスをinstall.shの引数に指定する必要があります。</p>
<p>&lt;version&gt;はKompiraのバージョン番号に置き換えてください。
&lt;kompira_ip&gt;はKompiraサーバのホスト名、もしくはIPアドレスです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh --sendevt &lt;kompira_ip&gt;
[2023-01-16 18:33:50] ****: ****************************************************************
[2023-01-16 18:33:50] ****: Kompira-1.6.8:
[2023-01-16 18:33:50] ****: Start: Install the Kompira
[2023-01-16 18:33:50] ****:
[2023-01-16 18:33:50] INFO:     SYSTEM                   = CENT
[2023-01-16 18:33:50] INFO:     SYSTEM_NAME              = cent7
[2023-01-16 18:33:50] INFO:     SYSTEM_RELEASE           = CentOS Linux release 7.7.1908 (Core)
[2023-01-16 18:33:50] INFO:     SYSTEM_RELEASEVER        = 7.7.1908
[2023-01-16 18:33:50] INFO:     PLATFORM_PYTHON          = /usr/libexec/platform-python
[2023-01-16 18:33:50] INFO:     PYTHON                   = /usr/bin/python
[2023-01-16 18:33:50] INFO:     SYSTEMD                  = true
[2023-01-16 18:33:50] INFO:     TMPDIR                   = /root/kompira-1.6.8-bin/.tmp.install-20230116-1833.rQ8X
[2023-01-16 18:33:50] INFO:     LOCALE_LANG              = ja_JP.UTF-8
[2023-01-16 18:33:50] INFO:     PATH                     = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
[2023-01-16 18:33:50] INFO:     HTTPS_MODE               = true
[2023-01-16 18:33:50] INFO:     AMQPS_MODE               = true

...

[2023-01-16 18:35:04] VERBOSE: run: chown :kompira /opt/kompira/ssl/certs/kompira-bundle-ca.crt /opt/kompira/ssl/certs/amqp-client-kompira.crt /opt/kompira/ssl/certs/amqp-client-kompira.key
[2023-01-16 18:35:04] ****: ----------------------------------------------------------------
[2023-01-16 18:35:04] ****: Setup kompira common files.
[2023-01-16 18:35:04] ****:
[2023-01-16 18:35:04] INFO: Create log directory: /var/log/kompira
[2023-01-16 18:35:04] VERBOSE: run: install -g kompira -m 775 -d /var/log/kompira
[2023-01-16 18:35:04] VERBOSE: run: find /var/log/kompira -type f -user root ! -name audit-* -exec chown kompira:kompira {} ;
[2023-01-16 18:35:04] INFO: Create kompira.conf
[2023-01-16 18:35:04] VERBOSE: run: install -m 644 /root/kompira-1.6.8-bin/.tmp.install-20230116-1833.rQ8X/kompira.conf /opt/kompira/kompira.conf
[2023-01-16 18:35:04] ****:
[2023-01-16 18:35:04] ****: Finish: Install the Kompira (status=0)
[2023-01-16 18:35:04] ****: ****************************************************************
</pre></div>
</div>
<p>「Finish: Install the Kompira (status=0)」という表示があれば、正常に完了しています。</p>
<p>インストールが完了すると、/opt/kompira/bin以下にkompira_sendevtコマンドが配置された状態となります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/kompira_sendevt --version
kompira_sendevt (Kompira version 1.6.8)
</pre></div>
</div>
<p>なお、install.sh に --amqps-verify オプションを付けた場合は、インストール途中に指定した Kompira サーバから SSL 証明書を scp でコピーするため、以下のようにパスワードの入力が求められます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: Start copying the SSL/CA certificates from the kompira server with scp.
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: PLEASE ENTER THE PASSWORD OF THE REMOTE KOMPIRA SERVER (&lt;kompira_ip&gt;) FOR SCP.
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] VERBOSE: run: scp -q -p -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@&lt;kompira_ip&gt;:/opt/kompira/ssl/certs/{kompira-bundle-ca.crt,amqp-client-kompira{.crt,.key}} /opt/kompira/ssl/certs/
root@&lt;kompira_ip&gt;&#39;s password:

...
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>install.sh に --amqps-verify オプションを付けた場合は、Kompira サーバから SSL 証明書を scp でコピーするようになりました。</p>
</div>
</section>
<section id="windows">
<span id="package-sendevt-install-windows"></span><h4><span class="section-number">1.2.5.2. </span>Windowsへのインストール<a class="headerlink" href="#windows" title="この見出しへのパーマリンク">¶</a></h4>
<ol class="arabic">
<li><p><strong>Python のインストール</strong></p>
<blockquote>
<div><p>Python 3.6 を Windows にインストールします。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.python.org/downloads/">https://www.python.org/downloads/</a></p></li>
</ul>
<p>上記の公式ダウンロードサイトから最新の Python 3.6 のインストーラをダウンロードして、
対象の Windows にインストールしてください。</p>
<p>インストールが完了したら、コマンドラインから Python が起動できるように、環境変数のパスを追加しておきます。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>パス</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files\Python36</span></code></p></td>
<td><p>Python のコマンドが含まれるフォルダ</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files\Python36\Scripts</span></code></p></td>
<td><p>pip コマンドなどが格納されるフォルダ</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p><strong>Kompira 用 Python 仮想環境 (venv) の作成</strong></p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">C:\Kompira</span></code> に Kompira 用の独立した Python 仮想環境 (venv) を作成します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; python -m venv C:\Kompira
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>ログファイル出力先ディレクトリの作成</strong></p>
<blockquote>
<div><p>ログファイルの出力先としてディレクトリ <code class="docutils literal notranslate"><span class="pre">C:\Kompira\Log</span></code> を作成します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; mkdir C:\Kompira\Log
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>kompira_sendevt パッケージのインストール</strong></p>
<blockquote>
<div><p>Kompira パッケージを Windows 上にダウンロードして展開したら、
dist ディレクトリに含まれる Kompira_sendevt-&lt;version&gt;-py3-none-any.whl を
仮想環境の pip コマンドでインストールします。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; C:\Kompira\Scripts\pip.exe install Kompira_sendevt-1.6.0-py3-none-any.whl
Processing c:\users\kompira\documents\kompira-package\kompira_sendevt-1.6.0-py3-none-any.whl
Collecting amqp~=2.6.1 (from Kompira-sendevt==1.6.8)

...

Installing collected packages: amqp, decorator, Kompira-sendevt
Successfully installed Kompira-sendevt-1.6.8 amqp-2.6.1 vine-1.3.0
</pre></div>
</div>
<p>以上でイベント送信パッケージのインストールは完了です。
kompira_sendevt コマンドは <code class="docutils literal notranslate"><span class="pre">C:\Kompira\Scripts</span></code> にインストールされますので、
次のように kompira_sendevt コマンドを実行してみてください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; C:\Kompira\Scripts\kompira_sendevt.exe --version
kompira_sendevt (Kompira version 1.6.8)
</pre></div>
</div>
<p>正しくインストールされていれば、バージョン番号が出力されます。</p>
<p><code class="docutils literal notranslate"><span class="pre">C:\Kompira\Scripts</span></code> も環境変数のパスに追加すれば、パスを省略して実行できます。</p>
</div></blockquote>
</li>
<li><p><strong>Kompira サーバから SSL 証明書ファイルの取得</strong></p>
<blockquote>
<div><p>インストール時に --amqps-verify オプションを付けるなどして、SSL 証明書の検証が有効になっている Kompira サーバに kompira_sendevt でメッセージを送信するためにはその Kompira サーバが発行した SSL 証明書が必要になります。
kompira_sendevt で SSL 証明書を用いて接続するためには、Kompira サーバから以下のファイルを取得して <code class="docutils literal notranslate"><span class="pre">C:\Kompira\SSL\Certs</span></code> ディレクトリに配置してください。</p>
<ul class="simple">
<li><p>/opt/kompira/ssl/certs/kompira-bundle-ca.crt</p></li>
<li><p>/opt/kompira/ssl/certs/amqp-client-kompira.crt</p></li>
<li><p>/opt/kompira/ssl/certs/amqp-client-kompira.key</p></li>
</ul>
<p>例えば scp コマンドが利用できる Windows であれば、以下のように Kompira サーバからファイル転送してください。<code class="docutils literal notranslate"><span class="pre">&lt;kompira_ip&gt;</span></code> の部分は Kompira サーバのアドレスを指定してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; mkdir C:\Kompira\SSL\Certs
C:\&gt; scp root@&lt;kompira_ip&gt;:/opt/kompira/ssl/certs/{kompira-bundle-ca.crt,amqp-client-kompira{.crt,.key}} C:\Kompira\SSL\Certs
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>設定ファイル kompira.conf の作成</strong></p>
<blockquote>
<div><p>kompira_sendevt が読み込む設定ファイルを <code class="docutils literal notranslate"><span class="pre">C:\Kompira\kompira.conf</span></code> に作成してください。
Windows 環境におけるデフォルト設定を以下に示しますが、<code class="docutils literal notranslate"><span class="pre">&lt;kompira_ip&gt;</span></code> の部分は Kompira サーバのアドレスを指定してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[kompira]
site_id         = 1

[logging]
logdir          = C:\Kompira\Log

[amqp-connection]
server          = &lt;kompira_ip&gt;
port            = 5671
ssl             = true
ssl_verify      = false
ssl_cacertfile  =
ssl_certfile    =
ssl_keyfile     =

[event]
channel         = /system/channels/Alert

[agent]
name            = default
</pre></div>
</div>
<p>Kompira サーバから取得した SSL 証明書を用いる場合は、以下の部分を書き換えてください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ssl_verify      = true
ssl_cacertfile  = C:\Kompira\SSL\Certs\kompira-bundle-ca.crt
ssl_certfile    = C:\Kompira\SSL\Certs\amqp-client-kompira.crt
ssl_keyfile     = C:\Kompira\SSL\Certs\amqp-client-kompira.key
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</section>
<section id="package-sendevt-update">
<span id="id14"></span><h4><span class="section-number">1.2.5.3. </span>アップデート<a class="headerlink" href="#package-sendevt-update" title="この見出しへのパーマリンク">¶</a></h4>
<p>インストールと同様の手順を実行することで、イベント送信パッケージのアップデートを行うことができます。</p>
</section>
</section>
<section id="offline-install">
<span id="id15"></span><h3><span class="section-number">1.2.6. </span>オフラインインストール<a class="headerlink" href="#offline-install" title="この見出しへのパーマリンク">¶</a></h3>
<p>オフラインインストールを行なうには以下のステップを踏む必要があります。</p>
<ul class="simple">
<li><p>インターネット接続環境での kompira-extra パッケージの作成</p></li>
<li><p>kompira-extra パッケージを利用したオフラインインストール</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>ただし、すべての環境で動作確認できているわけではないので、問題があればご報告ください。</p>
</div>
<section id="kompira-extra">
<h4><span class="section-number">1.2.6.1. </span>インターネット接続環境での kompira-extra パッケージの作成<a class="headerlink" href="#kompira-extra" title="この見出しへのパーマリンク">¶</a></h4>
<p>kompira-extra パッケージを作成するには、以下の条件を満たすサーバ上で実施する必要があります。</p>
<ul class="simple">
<li><p>オフラインインストールする対象と同じ構成のサーバ（少なくとも OS とバージョンは合わせてください）</p></li>
<li><p>インターネットに接続できるサーバ（必要であればproxyを指定してください）</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>RHEL では必要に応じてサブスクリプションを登録しておいてください。</p>
</div>
<p><strong>install.sh を用いた kompira-extra パッケージの作成</strong></p>
<p>kompira パッケージに含まれる install.sh に <code class="docutils literal notranslate"><span class="pre">--extra</span></code> オプションを付与して実行してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh --extra
[2021-11-04 20:56:38] ****: ****************************************************************
[2021-11-04 20:56:38] ****: Kompira-1.6.3:
[2021-11-04 20:56:38] ****: Start: Install the Kompira
[2021-11-04 20:56:38] ****:
[2021-11-04 20:56:38] INFO:     SYSTEM                   = CENT
[2021-11-04 20:56:38] INFO:     SYSTEM_NAME              = cent8
[2021-11-04 20:56:38] INFO:     SYSTEM_RELEASE           = CentOS Linux release 8.2.2004 (Core)
[2021-11-04 20:56:38] INFO:     SYSTEM_RELEASEVER        = 8.2.2004
[2021-11-04 20:56:38] INFO:     PLATFORM_PYTHON          = /usr/libexec/platform-python
[2021-11-04 20:56:38] INFO:     PYTHON                   =
[2021-11-04 20:56:38] INFO:     SYSTEMD                  = true
[2021-11-04 20:56:38] INFO:     TMPDIR                   = /root/kompira-1.6.3-bin/.tmp.install-20211104-2056.P3fx
[2021-11-04 20:56:38] INFO:     LOCALE_LANG              = ja_JP.UTF-8
[2021-11-04 20:56:38] INFO:     PATH                     = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
[2021-11-04 20:56:38] INFO:     HTTPS_MODE               = true
[2021-11-04 20:56:38] INFO:     FORCE_MODE               = false
[2021-11-04 20:56:38] INFO:     BACKUP_MODE              = true
[2021-11-04 20:56:38] INFO:     BACKUP_PROCESS           = false
[2021-11-04 20:56:38] INFO:     INITDATA_MODE            = false
[2021-11-04 20:56:38] INFO:     INITFILE_MODE            = false
[2021-11-04 20:56:38] INFO:     OFFLINE_MODE             = false
[2021-11-04 20:56:38] INFO:     JOBMNGR_MODE             = false
[2021-11-04 20:56:38] INFO:     SENDEVT_MODE             = false
[2021-11-04 20:56:38] INFO:     PROXY_URL                =
[2021-11-04 20:56:38] INFO:     NO_PROXY                 = localhost,127.0.0.1
[2021-11-04 20:56:38] INFO:     KOMPIRA_SERVER           = localhost
[2021-11-04 20:56:38] INFO:     DRY_RUN                  = false
[2021-11-04 20:56:38] ****: ----------------------------------------------------------------

...

opt/kompira/extra/1.6.3/cent8/wheelhouse/PyYAML-5.3.1-cp36-cp36m-linux_x86_64.whl
opt/kompira/extra/1.6.3/cent8/wheelhouse/pykerberos-1.2.1-cp36-cp36m-linux_x86_64.whl
opt/kompira/extra/1.6.3/cent8/wheelhouse/future-0.18.2-py3-none-any.whl
opt/kompira/extra/1.6.3/cent8/wheelhouse/PTable-0.9.2-py3-none-any.whl
[2021-11-04 21:08:58] ****:
[2021-11-04 21:08:58] ****: Finish: Install the Kompira (status=0)
[2021-11-04 21:08:58] ****: ****************************************************************
</pre></div>
</div>
<p><strong>kompira-extra パッケージの確認</strong></p>
<p>問題がなければ、10～20分程度で <code class="docutils literal notranslate"><span class="pre">kompira-extra-</span></code> で始まるパッケージファイルが生成されますので確認してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ls -lh kompira-extra-*.tar.gz
-rw-r--r--. 1 root root 290M Nov  4 21:08 kompira-extra-1.6.3.cent8.tar.gz
</pre></div>
</div>
</section>
<section id="id16">
<h4><span class="section-number">1.2.6.2. </span>kompira-extra パッケージを利用したオフラインインストール<a class="headerlink" href="#id16" title="この見出しへのパーマリンク">¶</a></h4>
<p><strong>kompira, kompira-extra パッケージの準備</strong></p>
<p>オフラインインストールを実施したいサーバに、kompira パッケージと上で作成した kompira-extra パッケージを配置してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ls -l kompira-*
-rw-r--r--. 1 root root   7555278 Nov  4 21:11 kompira-1.6.3-bin.tar.gz
-rw-r--r--. 1 root root 303772888 Nov  4 21:12 kompira-extra-1.6.3.cent8.tar.gz
</pre></div>
</div>
<p><strong>kompira-extra パッケージの展開</strong></p>
<p>root 権限で kompira-extra パッケージをルートディレクトリ配下に展開してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># tar zxf kompira-extra-1.6.3.cent8.tar.gz -C /
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/opt/kompira/extra/1.6.x/${OS}/</span></code> 配下にオフラインインストールに必要な各種パッケージが展開されていることを確認してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls -l /opt/kompira/extra/1.6.3/*
total 40
drwxr-xr-x. 3 root root 24576 Nov  4 21:08 packages
drwxr-xr-x. 2 root root     6 Nov  4 20:57 pip
drwxr-xr-x. 2 root root  8192 Nov  4 21:08 wheelhouse
</pre></div>
</div>
<p><strong>kompira オフラインインストールの実施</strong></p>
<p>kompira パッケージを展開して install.sh に <code class="docutils literal notranslate"><span class="pre">--offline</span></code> オプションを付けて実行してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh --offline
[2021-11-04 21:14:37] ****: ****************************************************************
[2021-11-04 21:14:37] ****: Kompira-1.6.3:
[2021-11-04 21:14:37] ****: Start: Install the Kompira (offline-mode)
[2021-11-04 21:14:37] ****:
[2021-11-04 21:14:37] INFO:     SYSTEM                   = CENT
[2021-11-04 21:14:37] INFO:     SYSTEM_NAME              = cent8
[2021-11-04 21:14:37] INFO:     SYSTEM_RELEASE           = CentOS Linux release 8.2.2004 (Core)
[2021-11-04 21:14:37] INFO:     SYSTEM_RELEASEVER        = 8.2.2004
[2021-11-04 21:14:37] INFO:     PLATFORM_PYTHON          = /usr/libexec/platform-python
[2021-11-04 21:14:37] INFO:     PYTHON                   =
[2021-11-04 21:14:37] INFO:     SYSTEMD                  = true
[2021-11-04 21:14:37] INFO:     TMPDIR                   = /root/kompira-1.6.3-bin/.tmp.install-20211104-2114.7XV8
[2021-11-04 21:14:37] INFO:     LOCALE_LANG              = ja_JP.UTF-8
[2021-11-04 21:14:37] INFO:     PATH                     = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
[2021-11-04 21:14:37] INFO:     HTTPS_MODE               = true
[2021-11-04 21:14:37] INFO:     FORCE_MODE               = false
[2021-11-04 21:14:37] INFO:     BACKUP_MODE              = true
[2021-11-04 21:14:37] INFO:     BACKUP_PROCESS           = false
[2021-11-04 21:14:37] INFO:     INITDATA_MODE            = false
[2021-11-04 21:14:37] INFO:     INITFILE_MODE            = false
[2021-11-04 21:14:37] INFO:     OFFLINE_MODE             = true
[2021-11-04 21:14:37] INFO:     JOBMNGR_MODE             = false
[2021-11-04 21:14:37] INFO:     SENDEVT_MODE             = false
[2021-11-04 21:14:37] INFO:     PROXY_URL                =
[2021-11-04 21:14:37] INFO:     NO_PROXY                 = localhost,127.0.0.1
[2021-11-04 21:14:37] INFO:     KOMPIRA_SERVER           = localhost
[2021-11-04 21:14:37] INFO:     DRY_RUN                  = false
[2021-11-04 21:14:37] ****: ----------------------------------------------------------------

...

[2021-11-04 21:15:25] ****: ----------------------------------------------------------------
[2021-11-04 21:15:25] ****: Test access to kompira.
[2021-11-04 21:15:25] ****:
[2021-11-04 21:15:26] INFO: Access succeeded:   &lt;div class=&quot;brand-version&quot;&gt;1.6.3&lt;/div&gt;
[2021-11-04 21:15:26] ****:
[2021-11-04 21:15:26] ****: Finish: Install the Kompira (offline-mode) (status=0)
[2021-11-04 21:15:26] ****: ****************************************************************
</pre></div>
</div>
</section>
</section>
</section>
<section id="process">
<span id="id17"></span><h2><span class="section-number">1.3. </span>Kompiraプロセス管理<a class="headerlink" href="#process" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompiraシステムは複数のプロセスが協調動作することにより成り立っています。
以下ではKompiraを構成するプロセスについての情報を記述します。</p>
<section id="process-architecture">
<span id="id18"></span><h3><span class="section-number">1.3.1. </span>Kompiraのプロセス構成<a class="headerlink" href="#process-architecture" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraシステムを構成するプロセスは、以下のようになっています。</p>
<dl>
<dt><strong>Kompiraデーモン (kompirad)</strong></dt><dd><p>Kompiraジョブフローを実行、管理するためのデーモンプロセスです。</p>
<p>Kompiraジョブマネージャに対してリモートコマンドの実行指示を出し、
結果を受け取ります。</p>
</dd>
<dt><strong>Kompiraジョブマネージャ (kompira_jobmngrd)</strong></dt><dd><p>Kompiraデーモンから指示されたリモートコマンドを実行するためのデーモ
ンプロセスです。</p>
<p>Kompiraデーモンからリモートコマンドの指示を受信すると、Kompiraジョブマネージャは
接続種別で指定されたプロトコルでリモートホストへ接続し、コマンドを実行します。
コマンドの実行結果はKompiraデーモンに送信されます。</p>
</dd>
</dl>
<p>その他、Kompiraシステムに必要なプロセスには、Apache(httpd)、
PostgreSQL(postgresql)、RabbitMQ(rabbitmq-server) があります。</p>
<p>これらの各プロセスは、マシン起動時に自動的に起動するようにinstall.shに
よって設定されます。</p>
</section>
<section id="process-daemon">
<span id="id19"></span><h3><span class="section-number">1.3.2. </span>Kompiraデーモンの起動・停止・状態確認<a class="headerlink" href="#process-daemon" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraデーモンの起動・停止は、ルート権限で行ってください。
起動後の実効ユーザーは自動的にkompiraに変更されます。</p>
<section id="rhel-centos-7-8">
<h4><span class="section-number">1.3.2.1. </span>RHEL/CentOS 7/8 系の場合<a class="headerlink" href="#rhel-centos-7-8" title="この見出しへのパーマリンク">¶</a></h4>
<p>RHEL/CentOS 7/8 系での Kompira デーモンの起動は以下のコマンドによって行います。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># systemctl start kompirad
</pre></div>
</div>
<p>停止には以下のコマンドを実行します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># systemctl stop kompirad
</pre></div>
</div>
<p>systemctl status コマンドで、Kompiraデーモンの状態を確認することができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ systemctl status kompirad.service
* kompirad.service - Kompira-daemon
   Loaded: loaded (/usr/lib/systemd/system/kompirad.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2018-07-05 16:33:02 JST; 2h 20min ago
  Process: 5277 ExecStartPre=/opt/kompira/bin/prestart_kompirad.sh (code=exited, status=0/SUCCESS)
 Main PID: 5368 (kompirad)
   CGroup: /system.slice/kompirad.service
           `-5368 /opt/kompira/bin/python3.6 /opt/kompira/bin/kompirad

 Jul 05 16:32:32 kompira-install-test3.dev.fixpoint.co.jp systemd[1]: Starting Kompira-daemon...
 Jul 05 16:33:02 kompira-install-test3.dev.fixpoint.co.jp systemd[1]: Started Kompira-daemon.
</pre></div>
</div>
<p>起動している時は Active: の欄が <strong>active (running)</strong>、停止している時は <strong>inactive (dead)</strong> と表示されます。</p>
</section>
</section>
<section id="process-jobmngr">
<span id="id20"></span><h3><span class="section-number">1.3.3. </span>Kompiraジョブマネージャの起動・停止・状態確認<a class="headerlink" href="#process-jobmngr" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraジョブマネージャの起動・停止もKompiraデーモンと同様にルート権限で行ってください。
起動後の実効ユーザーは自動的にkompiraに変更されます。</p>
<section id="id21">
<h4><span class="section-number">1.3.3.1. </span>RHEL/CentOS 7/8 系の場合<a class="headerlink" href="#id21" title="この見出しへのパーマリンク">¶</a></h4>
<p>RHEL/CentOS 7/8 系での Kompiraジョブマネージャの起動は以下のコマンドによって行います。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># systemctl start kompira_jobmngrd.service
</pre></div>
</div>
<p>停止には以下のコマンドを実行します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># systemctl stop kompira_jobmngrd.service
</pre></div>
</div>
<p>statusコマンドでKompiraジョブマネージャの状態を確認することができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ systemctl status kompira_jobmngrd.service
* kompira_jobmngrd.service - Kompira-jobmanager
   Loaded: loaded (/usr/lib/systemd/system/kompira_jobmngrd.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2018-07-05 16:32:22 JST; 2h 25min ago
 Main PID: 5164 (kompira_jobmngr)
   CGroup: /system.slice/kompira_jobmngrd.service
           |-5164 /opt/kompira/bin/python3.6 /opt/kompira/bin/kompira_jobmngrd
           `-5197 /opt/kompira/bin/python3.6 /opt/kompira/bin/kompira_jobmngrd

 Jul 05 16:32:22 kompira-install-test3.dev.fixpoint.co.jp systemd[1]: Started Kompira-jobmanager.
 Jul 05 16:32:22 kompira-install-test3.dev.fixpoint.co.jp systemd[1]: Starting Kompira-jobmanager...
</pre></div>
</div>
<p>起動している時は Active: の欄が <strong>active (running)</strong>、停止している時は <strong>inactive (dead)</strong> と表示されます。</p>
</section>
</section>
<section id="process-port">
<span id="id22"></span><h3><span class="section-number">1.3.4. </span>Kompira使用ポート一覧<a class="headerlink" href="#process-port" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraパッケージをインストールしたサーバ上では、以下に挙げるポートに外部から接続可能である必要があります。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ポート番号</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>80/TCP</p></td>
<td><p>HTTP (HTTPSからのみブラウザアクセスする場合は不要)</p></td>
</tr>
<tr class="row-odd"><td><p>443/TCP</p></td>
<td><p>HTTPS (HTTPからのみブラウザアクセスする場合は不要)</p></td>
</tr>
<tr class="row-even"><td><p>5671/TCP</p></td>
<td><p>AMQPS (外部の kompira_jobmngrd や kompira_sendevt から AMQPS 接続を許可しない場合は不要)</p></td>
</tr>
<tr class="row-odd"><td><p>5672/TCP</p></td>
<td><p>AMQP (外部の kompira_jobmngrd や kompira_sendevt から AMQP 接続を許可しない場合は不要)</p></td>
</tr>
</tbody>
</table>
<p>その他、httpd サーバと Kompira エンジンの RPC 用にループバックIFで 5593/TCP のポートを使用します。
（こちらは外部から接続可能にする必要はありません）</p>
<p>また、冗長構成を構築する場合は、各ノード間（ハートビート用の内部IFを用いる場合はその内部IF間）で以下のポートを用いた通信を行なえる必要があります。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ポート番号</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2224/TCP</p></td>
<td><p>pcs (冗長構成ミドルウェア)</p></td>
</tr>
<tr class="row-odd"><td><p>4369/TCP</p></td>
<td><p>epmd (Erlang port mapper daemon)</p></td>
</tr>
<tr class="row-even"><td><p>5405/UDP</p></td>
<td><p>corosync (ハートビートに使用)</p></td>
</tr>
<tr class="row-odd"><td><p>5432/TCP</p></td>
<td><p>PostgreSQL (レプリケーションに使用)</p></td>
</tr>
<tr class="row-even"><td><p>25672/TCP</p></td>
<td><p>RabbitMQ Server (ノード間通信に使用)</p></td>
</tr>
</tbody>
</table>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.4 で変更: </span>rsyncd は使用しなくなったため、ポート番号一覧から削除しました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.8 で追加: </span>AMQPS に対応したため、ポート一覧に 5671/TCP を追加しました。</p>
</div>
</section>
</section>
<section id="node">
<span id="id23"></span><h2><span class="section-number">1.4. </span>ノードの設定<a class="headerlink" href="#node" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompira では以下の種類のノードに対して、リモートジョブを実行することができます。</p>
<ul class="simple">
<li><p>ローカルノード</p></li>
<li><p>SSH ノード</p></li>
<li><p>Windows ノード</p></li>
<li><p>ネットワーク機器ノード</p></li>
</ul>
<p>ノードの種類ごとに指定する接続種別や、事前にノード側に必要な設定が異なります。</p>
<p>接続種別の指定方法については <a class="reference internal" href="reference.html#control-variables"><span class="std std-ref">制御変数</span></a> を参照してください。</p>
<section id="node-local">
<span id="id24"></span><h3><span class="section-number">1.4.1. </span>ローカルノードの設定<a class="headerlink" href="#node-local" title="この見出しへのパーマリンク">¶</a></h3>
<p>ローカルノードに対する接続種別は以下の1種類です。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接続種別</p></th>
<th class="head"><p>プロトコル</p></th>
<th class="head"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">local</span></code></p></td>
<td><p>ローカル実行</p></td>
<td><p>kompira_jobmngrd が動作しているノード上でジョブを直接実行します</p></td>
</tr>
</tbody>
</table>
<p>Kompira においてリモートノードを明示的に指定していない場合、ローカルノード上でジョブを直接実行します。
ここでのローカルノードとは kompira_jobmngrd サービスが動作しているノードを示します。</p>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.6 で追加: </span>ローカルノードについての説明を追加しました。</p>
</div>
</section>
<section id="ssh">
<span id="node-ssh"></span><h3><span class="section-number">1.4.2. </span>SSH ノードの設定<a class="headerlink" href="#ssh" title="この見出しへのパーマリンク">¶</a></h3>
<p>SSH ノードに対する接続種別は以下の1種類です。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接続種別</p></th>
<th class="head"><p>プロトコル</p></th>
<th class="head"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ssh</span></code></p></td>
<td><p>SSH</p></td>
<td><p>SSH v2 のみに対応</p></td>
</tr>
</tbody>
</table>
<p>Kompira から SSH ノードに対してコマンド実行を行う場合、sshバージョン2でログインできる状態である必要があります。
最近の Linux などであればインストールした時点で ssh ログインできる状態になっているため、特に設定する必要はありません。
それ以外の対象ノードで ssh ログインを有効にする方法については、各システムのマニュアル等を参考にして設定してください。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>サポートしているSSH のバージョンは v2 のみとなっています。v1 には対応しておりません。</p>
</div>
</section>
<section id="node-winrs">
<span id="id25"></span><h3><span class="section-number">1.4.3. </span>Windows ノードの設定<a class="headerlink" href="#node-winrs" title="この見出しへのパーマリンク">¶</a></h3>
<p>Windows ノードに対しては、以下の4種類の接続種別が選べます。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接続種別</p></th>
<th class="head"><p>プロトコル</p></th>
<th class="head"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">windows/https</span></code></p></td>
<td><p>WS-Man HTTPS</p></td>
<td><p>サーバ側に SSL 証明書の導入が必要</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">windows/https-ignore-validation</span></code></p></td>
<td><p>WS-Man HTTPS (サーバ証明書の検証エラー無視)</p></td>
<td><p>自己署名証明書が利用可能</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">windows/http</span></code></p></td>
<td><p>WS-Man HTTP (メッセージ暗号化あり)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">windows/http-unencrypted</span></code></p></td>
<td><p>WS-Man HTTP (メッセージ暗号化なし)</p></td>
<td><p>（非推奨）サーバ側で非暗号化通信の許可が必要</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>互換性のため従来の接続種別 <code class="docutils literal notranslate"><span class="pre">winrs</span></code> も利用できます。ただし、この場合はポート番号が指定されているかどうかで、利用するプロトコルが切り替わります。ポート番号として 5986 または 443 が指定されている場合は HTTPS が、5985 または 80 が指定されている場合は HTTP が利用されます。ポート番号が省略されている場合は HTTPS 接続を試みます。</p>
</div>
<p>Kompira から Windows ノードに対してコマンド実行を行う場合、事前に Windows ノード側にて WinRM の設定が必要となります。
なお、対応している WinRM のバージョンは 1.1, 2.0, 3.0 になります。</p>
<section id="winrm">
<h4><span class="section-number">1.4.3.1. </span>WinRM のリモート管理を有効にする<a class="headerlink" href="#winrm" title="この見出しへのパーマリンク">¶</a></h4>
<p>WinRM を有効にするため、Windows のコマンドプロンプトを「管理者として実行」して、
<code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">quickconfig</span></code> （または <code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">qc</span></code>）と実行してください。
「変更しますか [y/n]?」と表示されたら <code class="docutils literal notranslate"><span class="pre">y</span></code> と答えてください。
なおこの操作は最初に1回行っておけば、2回目以降は不要です。</p>
<p>以下は Windows 7 で実行した場合の例ですが、
Windows のバージョンやその時点での設定状況によって表示される内容の詳細は異なります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt;winrm quickconfig
WinRM はこのコンピューター上で要求を受信するように設定されていません。
次の変更を行う必要があります:

WinRM サービスの種類を遅延自動開始に設定します。
WinRM サービスを開始します。
ローカル ユーザーにリモートで管理権限を付与するよう LocalAccountTokenFilterPolicy を構成してください。

変更しますか [y/n]? y

WinRM は要求を受信するように更新されました。

WinRM サービスの種類を正しく変更できました。
WinRM サービスが開始されました。
ローカル ユーザーにリモートで管理権限を付与するよう LocalAccountTokenFilterPolicy を構成しました。
WinRM は、管理用にこのコンピューターへのリモート アクセスを許可するように設定されていません。
次の変更を行う必要があります:

このコンピューター上のあらゆる IP への WS-Man 要求を受け付けるため、HTTP://* 上に WinRM リスナーを作成します。
WinRM ファイアウォールの例外を有効にします。

変更しますか [y/n]? y

WinRM はリモート管理用に更新されました。

このコンピューター上のあらゆる IP への WS-Man 要求を受け付けるため、HTTP://* 上に WinRM リスナーを作成しました。
WinRM ファイアウォールの例外を有効にしました。
</pre></div>
</div>
</section>
<section id="id26">
<h4><span class="section-number">1.4.3.2. </span>WinRM の接続設定を変更する<a class="headerlink" href="#id26" title="この見出しへのパーマリンク">¶</a></h4>
<p>接続方式としては HTTPS 接続が最も安全ですが、Windows ノードに SSL 証明書を導入しておく必要があります。
ここでは詳細な手順は示しませんが、Microsoft のサポートページなどを参考にしてみてください。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/ja-jp/search/?terms=winrm%20https">https://docs.microsoft.com/ja-jp/search/?terms=winrm%20https</a></p></li>
</ul>
<p>非推奨ですが、メッセージ暗号化なしの HTTP 接続を行なう場合は、WinRM で非暗号化通信を許可しておく必要があります。
管理者として実行したコマンドプロンプトから以下のコマンドを実行することで、非暗号化通信を許可することができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; winrm set winrm/config/service @{AllowUnencrypted=&quot;true&quot;}
</pre></div>
</div>
<p>HTTP 接続でメッセージ暗号化ありの場合、メッセージ暗号化無しに比べると速度低下が見られる場合があります。速度低下が問題になる場合は、リスクを理解したうえで非暗号化通信の利用を検討してください。</p>
<p>WinRM は標準では  Administrators グループに所属する特権ユーザだけが接続できます。非特権ユーザとして接続する場合は追加の設定が必要になりますので、以下のいずれかを試してみてください。</p>
<ul>
<li><p>当該ユーザを &quot;Remote Management Users&quot; グループに所属させる。</p></li>
<li><p>管理者として実行したコマンドプロンプトから以下のコマンドを実行して、当該ユーザあるいは所属グループのいずれかに読み込み権限と実行権限を与える。</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; winrm configSDDL default
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.4.10 で変更: </span>Kompira Ver.1.4.10 以降では、デフォルトでNTLM認証に対応したため、BASIC認証の許可設定は不要となりました。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.4 で変更: </span>HTTP 接続の WinRM においてメッセージ暗号化に対応したため、非暗号化通信の許可設定は必須ではなくなりました。あわせて、非暗号化通信の通信許可は非推奨となりました。</p>
</div>
</section>
<section id="id27">
<h4><span class="section-number">1.4.3.3. </span>ジョブフローでの動作確認<a class="headerlink" href="#id27" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompira で以下のようなジョブフローを作成・実行して windows ノードへのコマンド制御ができるか確認してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[__host__ = &#39;&lt;Windowsサーバのアドレス&gt;&#39;,
 __user__ = &#39;&lt;Windowsユーザー名&gt;&#39;,
 __password__ = &#39;&lt;Windowsユーザーパスワード&gt;&#39;,
 __conntype__ = &#39;windows/http&#39;]
-&gt; [&#39;ver&#39;]
-&gt; print($RESULT)
</pre></div>
</div>
<p>ジョブフロープロセスのコンソールにWindowsのバージョン番号が表示されれば成功です。</p>
<p>なお WinRM 2.0 以降ではデフォルトで TCP ポート 5985 番を利用しますが、
Windows Server 2008 などの WinRM 1.1 では利用するポート番号が 80 となっていますので、
その際はポート番号の設定 <code class="docutils literal notranslate"><span class="pre">__port__</span> <span class="pre">=</span> <span class="pre">80</span></code> を追加するようにしてください。</p>
<p>うまく接続できない場合は、ファイアウォールで TCP ポート 5985 番（や 80番）が
通過できない設定になっていないか、ログインアカウントの設定が正しいかなどを確認してください。</p>
</section>
</section>
<section id="node-device">
<span id="id28"></span><h3><span class="section-number">1.4.4. </span>ネットワーク機器ノードの設定<a class="headerlink" href="#node-device" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompira からネットワーク機器ノードに対してコマンド実行を行う場合、ネットワーク機器によっては事前に SSH または TELNET によるログインを有効化する必要があります。各機器で SSH や TELNET ログインを有効にする方法については、各機器のマニュアル等を参考にして設定してください。</p>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.4 で追加: </span>ネットワーク機器ノードとのリモート連携に対応しました。</p>
</div>
<section id="id29">
<h4><span class="section-number">1.4.4.1. </span>対応機種一覧<a class="headerlink" href="#id29" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompira v1.6.4 時点では以下のネットワーク機器（接続プロトコル）とのリモート連携に対応しています。</p>
<ul class="simple">
<li><p>Cisco IOS (SSH, TELNET)</p></li>
<li><p>Cisco ASA (SSH)</p></li>
<li><p>Yamaha (SSH, TELNET)</p></li>
<li><p>Juniper ScreenOS (SSH)</p></li>
<li><p>HP Procurve (SSH)</p></li>
</ul>
<p>各機器ごとに指定できる接続種別と動作確認を行なった機種を以下に示します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ネットワーク機器</p></th>
<th class="head"><p>接続種別</p></th>
<th class="head"><p>プロトコル</p></th>
<th class="head"><p>動作確認機種</p></th>
<th class="head"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="2"><p>Cisco IOS</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cisco_ios/ssh</span></code></p></td>
<td><p>SSH</p></td>
<td><p>Cisco 892J, Cisco CSR1000V</p></td>
<td><p>PUT/GET に対応</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cisco_ios/telnet</span></code></p></td>
<td><p>TELNET</p></td>
<td><p>Cisco 892J, Cisco CSR1000V</p></td>
<td><p>PUT/GET に対応</p></td>
</tr>
<tr class="row-even"><td><p>Cisco ASA</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cisco_asa/ssh</span></code></p></td>
<td><p>SSH</p></td>
<td><p>Cisco ASA5505</p></td>
<td><p>PUT/GET に対応</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>Yamaha</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">yamaha/ssh</span></code></p></td>
<td><p>SSH</p></td>
<td><p>Yamaha RTX1200</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">yamaha/telnet</span></code></p></td>
<td><p>TELNET</p></td>
<td><p>Yamaha RTX1200</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Juniper ScreenOS</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">juniper_screenos/ssh</span></code></p></td>
<td><p>SSH</p></td>
<td><p>Juniper SSG5</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>HP ProCurve</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">hp_procurve/ssh</span></code></p></td>
<td><p>SSH</p></td>
<td><p>ProCurve 2510G</p></td>
<td></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>ノード種別として上記以外の機種も選択できるようになっていますが、弊社では動作確認はできていません。</p>
</div>
</section>
<section id="id30">
<h4><span class="section-number">1.4.4.2. </span>ネットワーク機器連携での制限事項<a class="headerlink" href="#id30" title="この見出しへのパーマリンク">¶</a></h4>
<p>ネットワーク機器との連携においては、リモートジョブの全ての機能に対応しているわけではありません。以下のような制限事項がありますのでご注意ください。</p>
<ul class="simple">
<li><p>コマンドジョブではコマンドの成否は判別できません。ログイン成功した場合は、実際のコマンド成否にかかわらず $STATUS は常に 0 になります。エラー判定が必要な場合は、標準出力にエラーメッセージが含まれていないか、などをジョブフローで判定する必要があります。</p></li>
<li><p>標準エラー出力には対応していません。内部的には PTY モード (<code class="docutils literal notranslate"><span class="pre">__use_pty__=true</span></code>) と同様になっており、出力はすべて標準出力として取得されます。</p></li>
<li><p>制御変数によるシェルの指定や実行ディレクトリの指定には対応していません。</p></li>
<li><p>スクリプトジョブ、再起動ジョブには対応していません。</p></li>
<li><p>一部の機種では PUT/GET によるファイル転送に対応していますが、単一ファイルの転送のみが可能です。ワイルドカードの指定や再帰的なファイル転送には対応していません。</p></li>
</ul>
</section>
<section id="id31">
<h4><span class="section-number">1.4.4.3. </span>動作確認を行なった機種情報<a class="headerlink" href="#id31" title="この見出しへのパーマリンク">¶</a></h4>
<p>弊社で動作確認を行なった各機器のバージョン情報を以下に示します。</p>
<p>Cisco 892J:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Cisco IOS Software, C890 Software (C890-UNIVERSALK9-M), Version 15.0(1)M3, RELEASE SOFTWARE (fc2)
Technical Support: http://www.cisco.com/techsupport
Copyright (c) 1986-2010 by Cisco Systems, Inc.
Compiled Sun 18-Jul-10 08:34 by prod_rel_team
ROM: System Bootstrap, Version 12.4(22r)YB3, RELEASE SOFTWARE (fc1)
</pre></div>
</div>
<p>Cisco CSR1000V:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Cisco IOS XE Software, Version 03.11.00.S - Standard Support Release
Cisco IOS Software, CSR1000V Software (X86_64_LINUX_IOSD-UNIVERSALK9-M), Version 15.4(1)S, RELEASE SOFTWARE (fc2)
Technical Support: http://www.cisco.com/techsupport
Copyright (c) 1986-2013 by Cisco Systems, Inc.
Compiled Tue 19-Nov-13 21:00 by mcpre
</pre></div>
</div>
<p>Cisco ASA5505:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Cisco Adaptive Security Appliance Software Version 8.4(4)3
Device Manager Version 6.4(9)
Compiled on Wed 11-Jul-12 10:25 by builders
System image file is &quot;disk0:/asa844-3-k8.bin&quot;
Config file at boot was &quot;startup-config&quot;
</pre></div>
</div>
<p>Yamaha RTX1200:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RTX1200 BootROM Ver.1.01
RTX1200 Rev.10.01.78 (Wed Nov 13 16:29:42 2019)
</pre></div>
</div>
<p>Juniper SSG5:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Product Name: SSG5-Serial
Serial Number: XXXXXXXXXXXXXXXX, Control Number: 00000000
Hardware Version: 0710(0)-(00), FPGA checksum: 00000000, VLAN1 IP (0.0.0.0)
Flash Type: Samsung
Software Version: 6.2.0r8-cu1.0, Type: Firewall+VPN
Feature: AV-K
Compiled by build_master at: Thu Nov 18 01:29:55 PST 2010
</pre></div>
</div>
<p>ProCurve 2510G:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Image stamp:    /sw/code/build/cod(cod11)
                Nov 17 2009 16:55:04
                Y.11.16
                43
Boot Image:     Primary
</pre></div>
</div>
</section>
</section>
</section>
<section id="file">
<span id="id32"></span><h2><span class="section-number">1.5. </span>Kompiraの設定とログファイル<a class="headerlink" href="#file" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompiraが標準で使用するサーバ上のディレクトリおよび設定ファイルについて記述します。</p>
<section id="file-hierarchy">
<span id="id33"></span><h3><span class="section-number">1.5.1. </span>Kompira標準ディレクトリ<a class="headerlink" href="#file-hierarchy" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraが標準で使用するサーバ上のディレクトリおよび設定ファイルの一覧を以下に示します。</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td colspan="2"><p>パス</p></td>
<td><p>説明</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>/opt/kompira/</p></td>
<td><p>bin/</p></td>
<td><p>Kompiraコマンド実行ファイル用
ディレクトリ</p></td>
</tr>
<tr class="row-odd"><td><p>kompira.conf</p></td>
<td><p>Kompira設定ファイル</p></td>
</tr>
<tr class="row-even"><td><p>/var/log/kompira/</p></td>
<td></td>
<td><p>エンジンやジョブマネージャの
ログファイル用ディレクトリ</p></td>
</tr>
<tr class="row-odd"><td rowspan="4"><p>/var/opt/kompira/</p></td>
<td></td>
<td><p>Kompiraの各種可変ファイル用
ディレクトリ</p></td>
</tr>
<tr class="row-even"><td><p>kompira.lic</p></td>
<td><p>Kompiraのライセンスファイル</p></td>
</tr>
<tr class="row-odd"><td><p>html/</p></td>
<td><p>オンラインヘルプのHTMLファイル群</p></td>
</tr>
<tr class="row-even"><td><p>repository/</p></td>
<td><p>リポジトリ連携のための
作業用ディレクトリ</p></td>
</tr>
<tr class="row-odd"><td><p>/etc/httpd/conf.d/</p></td>
<td><p>kompira.conf</p></td>
<td><p>Apache設定ファイル</p></td>
</tr>
</tbody>
</table>
<div class="deprecated">
<p><span class="versionmodified deprecated">バージョン 1.6.4 で非推奨: </span>添付ファイルはデータベース上に保存されるように変更されたため、/var/opt/kompira/upload ディレクトリは廃止されました。</p>
</div>
</section>
<section id="file-log">
<span id="id34"></span><h3><span class="section-number">1.5.2. </span>Kompiraログ<a class="headerlink" href="#file-log" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompira 自体のログファイルは、標準で以下のディレクトリ下に作成されます。</p>
<ul class="simple">
<li><p>/var/log/kompira/</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>Windows 環境ではログファイルは標準でディレクトリ <code class="docutils literal notranslate"><span class="pre">C:\Kompira\Log</span></code> の下に作成されます。</p>
</div>
<p>作成されるログファイルごとに、標準のログローテート設定と記録される内容は以下のようになっています。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ログファイル</p></th>
<th class="head"><p>ログローテート設定</p></th>
<th class="head"><p>内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>kompira.log</p></td>
<td><p>固定 (daily rotate 7)</p></td>
<td><p>リクエスト関連のログ出力 (httpdによる出力)</p></td>
</tr>
<tr class="row-odd"><td><p>kompirad.log</p></td>
<td><p>固定 (daily rotate 7)</p></td>
<td><p>Kompiraデーモンのログ出力</p></td>
</tr>
<tr class="row-even"><td><p>process.log</p></td>
<td><p>固定 (daily rotate 無制限)</p></td>
<td><p>Kompiraジョブフロープロセスのログ出力</p></td>
</tr>
<tr class="row-odd"><td><p>kompira_jobmngrd.log</p></td>
<td><p>kompira.conf (daily rotate 7)</p></td>
<td><p>Kompiraジョブマネージャのログ出力</p></td>
</tr>
<tr class="row-even"><td><p>kompira_sendevt.log</p></td>
<td><p>kompira.conf (1GB rotate 10)</p></td>
<td><p>イベント送信コマンドのログ出力</p></td>
</tr>
<tr class="row-odd"><td><p>audit-*.log</p></td>
<td><p>logrotate (daily rotate 365)</p></td>
<td><p>各種操作による監査ログ出力</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>ログファイルは自動的にローテートされ、古いログファイルは日付がファイル名に追加された上で保存されます。</p></li>
<li><p>上記ログファイルのうち、kompira_jobmngrd.log, kompira_sendevt.log は /opt/kompira/kompira.conf によりローテートの間隔やバックアップする世代数の設定を変更することができます。</p></li>
<li><p>audit-*.log については logrotate サービスによりログのローテートを行なっており、/etc/logrotate.d/kompira_audit でその設定を変更することができます。</p></li>
</ul>
<p>Kompira を構成する各種サービスは、以下のディレクトリにログを出力します。また、各サービスごとの標準のログローテートの設定も以下に示します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>サービス</p></th>
<th class="head"><p>ログ出力先</p></th>
<th class="head"><p>ログローテート設定</p></th>
<th class="head"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>httpd</p></td>
<td><p>/var/log/httpd/</p></td>
<td><p>logrotate (daily rotate 30)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>postgresql</p></td>
<td><p>/var/log/postgres/</p></td>
<td><p>logrotate (daily rotate 30)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>rabbitmq-server</p></td>
<td><p>/var/log/rabbitmq/</p></td>
<td><p>logrotate (weekly rotate 20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>pacemaker (1.x)</p></td>
<td><p>/var/log/</p></td>
<td><p>logrotate (weekly rotate 99)</p></td>
<td><p>冗長構成時のみ (RHEL7系)</p></td>
</tr>
<tr class="row-even"><td><p>pacemaker (2.x)</p></td>
<td><p>/var/log/pacemaker/</p></td>
<td><p>logrotate (weekly rotate 99)</p></td>
<td><p>冗長構成時のみ (RHEL8系)</p></td>
</tr>
<tr class="row-odd"><td><p>corosync</p></td>
<td><p>/var/log/cluster/</p></td>
<td><p>logrotate (daily rotate 31)</p></td>
<td><p>冗長構成時のみ</p></td>
</tr>
<tr class="row-even"><td><p>pcsd</p></td>
<td><p>/var/log/pcsd/</p></td>
<td><p>logrotate (weekly rotate 5)</p></td>
<td><p>冗長構成時のみ</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.3 で追加: </span>監査ログが追加されました。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>Windows 環境ではログファイルがデフォルトで <code class="docutils literal notranslate"><span class="pre">C:\Kompira\Log</span></code> に作成されるようになりました。</p>
</div>
</section>
<section id="file-settings">
<span id="id35"></span><h3><span class="section-number">1.5.3. </span>Kompira設定ファイル<a class="headerlink" href="#file-settings" title="この見出しへのパーマリンク">¶</a></h3>
<p>/opt/kompira/kompira.conf での設定項目は、次のとおりです。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>セクション名</p></th>
<th class="head"><p>項目名</p></th>
<th class="head"><p>デフォルト値</p></th>
<th class="head"><p>内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>kompira</p></td>
<td><p>site_id</p></td>
<td><p>1</p></td>
<td><p>本バージョンでは未使用</p></td>
</tr>
<tr class="row-odd"><td><p>logging</p></td>
<td colspan="3"><p>ログ出力関連の設定</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>loglevel</p></td>
<td><p>INFO</p></td>
<td><p>ログ出力レベルの設定
(DEBUG, INFO, WARNING, ERROR, CRITICAL)</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>logdir</p></td>
<td><p>/var/log/kompira</p></td>
<td><p>ログファイルのディレクトリ</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>logbackup</p></td>
<td><div class="line-block">
<div class="line">kompirad: 7</div>
<div class="line">kompira_jobmngrd: 7</div>
<div class="line">kompira_sendevt: 10</div>
</div>
</td>
<td><p>ログバックアップの世代数</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>logmaxsz</p></td>
<td><div class="line-block">
<div class="line">kompirad: 0</div>
<div class="line">kompira_jobmngrd: 0</div>
<div class="line">kompira_sendevt: 1024*1024*1024</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログファイルの最大サイズ(単位はbyte)</div>
<div class="line">0に設定すると日次ローテートとなる</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>amqp-connection</p></td>
<td colspan="3"><p>RabbitMQの接続情報関連の設定</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>server</p></td>
<td><p>localhost</p></td>
<td><p>接続ホスト名</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>port</p></td>
<td><p>(5671 or 5672)</p></td>
<td><p>接続ポート番号</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>user</p></td>
<td><p>(guest or kompira)</p></td>
<td><p>接続ユーザー名</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>password</p></td>
<td><p>(guest or kompira)</p></td>
<td><p>接続パスワード</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>ssl</p></td>
<td><p>(true or false)</p></td>
<td><p>SSLで接続するかどうか</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>ssl_verify</p></td>
<td><p>false</p></td>
<td><p>SSLでサーバ証明書を検証するかどうか</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>ssl_cacertfile</p></td>
<td></td>
<td><p>SSLでサーバ証明書を検証するCA証明書ファイル</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>ssl_certfile</p></td>
<td></td>
<td><p>SSL接続するときの証明書ファイル</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>ssl_keyfile</p></td>
<td></td>
<td><p>SSL接続するときの秘密鍵ファイル</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>heartbeat_interval</p></td>
<td><p>10</p></td>
<td><p>ハートビートの送信間隔 (単位は秒)</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>max_retry</p></td>
<td><p>3</p></td>
<td><p>接続断時に再接続する最大試行回数</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>retry_interval</p></td>
<td><p>30</p></td>
<td><p>接続断時に再接続する間隔 (単位は秒)</p></td>
</tr>
<tr class="row-odd"><td><p>agent</p></td>
<td colspan="3"><p>ジョブマネージャの動作に関する設定</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>name</p></td>
<td><p>default</p></td>
<td><p>ジョブマネージャの名称</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>pool_size</p></td>
<td><p>8</p></td>
<td><p>同時プロセスワーカー数 (1～80)</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>disable_cache</p></td>
<td><p>false</p></td>
<td><p>リモート接続キャッシュの無効化</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>cache_duration</p></td>
<td><p>300</p></td>
<td><p>リモート接続キャッシュの有効期限 (秒)</p></td>
</tr>
<tr class="row-even"><td><p>event</p></td>
<td colspan="3"><p>イベント送信の設定</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>channel</p></td>
<td><p>/system/channels/Alert</p></td>
<td><p>イベント送信先チャネルのKompira上のパス</p></td>
</tr>
</tbody>
</table>
<p>なお、Windows 環境では以下のようにデフォルト値が変化します。</p>
<ul class="simple">
<li><p>logdir: <code class="docutils literal notranslate"><span class="pre">C:\Kompira\Log</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>リモート接続キャッシュは、リモートコマンド実行時のリモート接続を再
利用することで、同一ノード、同一アカウントでの連続するリモートコマ
ンド実行の処理を高速化する機能です。</p>
<p>ただし、WinRS 接続では高速化の効果が得られないため、disable_cache
の設定にかかわらずリモート接続キャッシュは使用しません。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>logdir のデフォルト値が Windows 環境では <code class="docutils literal notranslate"><span class="pre">C:\Kompira\Log</span></code> に変更になりました。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>user のデフォルト値が guest or kompira になりました。
接続先ホスト名に localhost または 127.0.0.1 を指定している場合は guest に、それ以外の場合は kompira になります。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>password が指定されていないとき、デフォルト値として user と同じ文字列になるように変更されました。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>ssl のデフォルト値が true or false に変更になりました。
ssl が指定されていないとき、server が localhost の場合は false に、それ以外の場合は true になります。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>port のデフォルト値が 5671 or 5672 に変更になりました。
port が指定されていないとき、ssl が true の場合は 5671 に false の場合は 5672 になります。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.8 で追加: </span>新しい設定項目 ssl_verify, ssl_cacertfile, ssl_certfile, ssl_keyfile が追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.9.post4 で追加: </span>pool_size に指定できる値が 1 から 80 までという制限が加わりました。</p>
</div>
</section>
<section id="id36">
<h3><span class="section-number">1.5.4. </span>Kompira画像ファイル<a class="headerlink" href="#id36" title="この見出しへのパーマリンク">¶</a></h3>
<p>ブラウザ画面で表示される画像は Kompira サーバ上の以下に配置されています。</p>
<ul class="simple">
<li><p>/var/opt/kompira/html/kompira/img/</p></li>
</ul>
<p>ここに配置されている画像ファイルは以下の通りです。画像ファイルを直接置き換えることで、画面の見た目を変更することができます。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ファイル名</p></th>
<th class="head"><p>用途</p></th>
<th class="head"><p>サイズ</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>favicon.svg</p></td>
<td><p>ファビコン (SVG形式)</p></td>
<td><p>16x16</p></td>
<td><p>ブラウザタブやお気に入り登録したときのアイコンに利用されます</p></td>
</tr>
<tr class="row-odd"><td><p>favicon.ico</p></td>
<td><p>ファビコン (ICO形式)</p></td>
<td><p>16x16</p></td>
<td><p>同上（SVG 形式に対応していないブラウザに利用されます）</p></td>
</tr>
<tr class="row-even"><td><p>brand-logo.svg</p></td>
<td><p>ブランドロゴ画像</p></td>
<td><p>40x40</p></td>
<td><p>メニューバー左上に表示されます</p></td>
</tr>
<tr class="row-odd"><td><p>login-logo.svg</p></td>
<td><p>ログインロゴ画像</p></td>
<td><p>128x128</p></td>
<td><p>ログイン画面およびログアウト画面の中央に表示されます</p></td>
</tr>
<tr class="row-even"><td><p>console-loading.gif</p></td>
<td><p>コンソールローディング画像</p></td>
<td><p>20x20</p></td>
<td><p>プロセス詳細画面でプロセスがアクティブな間コンソールに表示されます</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>サイズは一般的な解像度のディスプレイで表示される時のピクセル数を参考値として示しています。</p>
</div>
</section>
</section>
<section id="data">
<span id="id37"></span><h2><span class="section-number">1.6. </span>Kompiraのデータバックアップ<a class="headerlink" href="#data" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompira上に保存したデータのバックアップとリストアを行う方法について記述します。</p>
<p>Kompira上で作成したジョブフローや機器情報の定義は、データベースに格納されます。
これらのデータをjson形式でファイルにエクスポートしたり、インポートしたりすることが可能です。</p>
<section id="data-export">
<span id="id38"></span><h3><span class="section-number">1.6.1. </span>Kompiraオブジェクトのエクスポート<a class="headerlink" href="#data-export" title="この見出しへのパーマリンク">¶</a></h3>
<p>以下の形式のexport_dataコマンドを実行することで、
標準出力に引数で指定したKompiraファイルシステムのパス以下のデータがjson形式でダンプされます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/bin/manage.py export_data [options] &lt;path&gt;...
</pre></div>
</div>
<p>たとえば、Kompiraで作成した/home/guest以下の全てのデータをファイルに
エクスポートするには、以下のコマンドを実行します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py export_data /home/guest &gt; guest.json
</pre></div>
</div>
<p>または、export_dir コマンドを実行することで、引数で指定した Kompira ファイルシステムのパス以下のデータを、
オブジェクト毎に YAML ファイルとしてダンプします。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/bin/manage.py export_dir [options] &lt;path&gt;...
</pre></div>
</div>
<p>なお、以下の型を持つオブジェクトの場合は、代表するフィールドのデータのみがファイルとして出力され、
残りのフィールドは、.&lt;オブジェクト名&gt; という名前の YAML ファイルとして、プロパティ情報とともに出力されます。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>型名</p></th>
<th class="head"><p>代表フィールド</p></th>
<th class="head"><p>ファイル形式</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Jobflow(ジョブフロー)</p></td>
<td><p>source(ソース)</p></td>
<td><p>テキスト</p></td>
</tr>
<tr class="row-odd"><td><p>ScriptJob(スクリプトジョブ)</p></td>
<td><p>source(ソース)</p></td>
<td><p>テキスト</p></td>
</tr>
<tr class="row-even"><td><p>Library(ライブラリ)</p></td>
<td><p>sourceText(ソーステキスト)</p></td>
<td><p>テキスト</p></td>
</tr>
<tr class="row-odd"><td><p>Template(テンプレート)</p></td>
<td><p>template(テンプレート)</p></td>
<td><p>テキスト</p></td>
</tr>
<tr class="row-even"><td><p>Text(テキスト)</p></td>
<td><p>text(テキスト)</p></td>
<td><p>テキスト</p></td>
</tr>
<tr class="row-odd"><td><p>Wiki(Wikiページ)</p></td>
<td><p>wikitext(Wikiテキスト)</p></td>
<td><p>テキスト</p></td>
</tr>
<tr class="row-even"><td><p>Environment(環境変数)</p></td>
<td><p>environment(環境変数)</p></td>
<td><p>YAML</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.7 で追加: </span>export_dir で、添付ファイルフィールドのデータを別ファイルとして出力するように変更しました。</p>
</div>
</section>
<section id="data-import">
<span id="id39"></span><h3><span class="section-number">1.6.2. </span>Kompiraオブジェクトのインポート<a class="headerlink" href="#data-import" title="この見出しへのパーマリンク">¶</a></h3>
<p>import_dataコマンドを用いて、エクスポートしたファイルからデータを
取り込むことができます。import_dataコマンドの形式は以下のとおりです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/bin/manage.py import_data [options] &lt;filename&gt;...
</pre></div>
</div>
<p>たとえば、/home/guestディレクトリをエクスポートしたファイルguest.jsonを取り込むには、
以下のコマンドを実行します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py import_data guest.json
[2014-07-25 12:34:49,576] INFO: import data: start...
[2014-07-25 12:34:49,676] INFO: home/guest: import is skipped: &quot;/home/guest&quot; already exists.
[2014-07-25 12:34:49,710] INFO: home/guest/a: import is skipped: &quot;/home/guest/a&quot; already exists.
[2014-07-25 12:34:49,743] INFO: home/guest/b: import is skipped: &quot;/home/guest/b&quot; already exists.
[2014-07-25 12:34:49,743] INFO: import data: finished (created=0, updated=0, skipped=3, error=0)
</pre></div>
</div>
<p>インポートするjsonファイル中に既に存在するパスのオブジェクトが含まれていた場合、
そのオブジェクトのインポートはスキップされます。
上記例の場合は、インポートしようとしたファイル3つが全てスキップされた状態です。</p>
<p>overwrite-modeオプションを指定すれば、上書きインポートをすることが可能です。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py import_data --overwrite-mode guest.json
[2014-07-25 12:39:15,685] INFO: import data: start...
[2014-07-25 12:39:15,821] INFO: import object: imported &quot;home/guest&quot; to &quot;/home/guest&quot; (updated)
[2014-07-25 12:39:15,904] INFO: import object: imported &quot;home/guest/a&quot; to &quot;/home/guest/a&quot; (updated)
[2014-07-25 12:39:15,971] INFO: import object: imported &quot;home/guest/b&quot; to &quot;/home/guest/b&quot; (updated)
[2014-07-25 12:39:15,991] INFO: import fields: /home/guest: []
[2014-07-25 12:39:16,015] INFO: import fields: /home/guest/a: [&#39;wikitext&#39;]
[2014-07-25 12:39:16,046] INFO: import fields: /home/guest/b: [&#39;wikitext&#39;]
[2014-07-25 12:39:16,046] INFO: import data: finished (created=0, updated=3, skipped=0, error=0)
</pre></div>
</div>
<p>export_dir コマンドでダンプしたファイルについては、import_dir コマンドを用いて取り込むことが出来ます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/bin/manage.py import_dir [options] &lt;dirname&gt;...
</pre></div>
</div>
</section>
<section id="data-backup">
<span id="id40"></span><h3><span class="section-number">1.6.3. </span>バックアップ<a class="headerlink" href="#data-backup" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraの全てのデータをバックアップするための手順について説明します。</p>
<p>Kompiraはデータベース上以外に、サーバ上の <a class="reference internal" href="#file-hierarchy"><span class="std std-ref">Kompira標準ディレクトリ</span></a> に挙げられているパスのデータを使用します。
Kompiraのデータをバックアップする際は、export_dataコマンドによるKompiraオブジェクトのバックアップに
加えて、必要に応じてサーバ上のファイルバックアップも行う必要があります。</p>
<p>Kompiraオブジェクトとライセンスファイルのバックアップを行う場合の例を以下に示します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mkdir -p /tmp/kompira_backup
$ cd /tmp/kompira_backup
$ /opt/kompira/bin/manage.py export_data / --virtual-mode &gt; backup.json
$ cp /var/opt/kompira/kompira.lic ./
$ cd /tmp
$ tar zcf kompira_backup.tar.gz ./kompira_backup
</pre></div>
</div>
</section>
<section id="export-data">
<span id="data-export-data-option"></span><h3><span class="section-number">1.6.4. </span>export_dataのオプション<a class="headerlink" href="#export-data" title="この見出しへのパーマリンク">¶</a></h3>
<p>export_dataコマンドには以下のオプションがあります。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--directory=DIRECTORY</span></code></p></td>
<td><p>エクスポートするパスの起点となる
ディレクトリを指定します。
(デフォルトは'/')</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--virtual-mode</span></code></p></td>
<td><p>仮想ファイルシステムに含まれるデータも
出力します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--owner-mode</span></code></p></td>
<td><p>エクスポート対象となったオブジェクトの
所有者のユーザオブジェクトおよびそのユーザ
の所属グループオブジェクトも出力します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--zip-mode</span></code></p></td>
<td><p>ZIP 形式で出力します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--without-attachments</span></code></p></td>
<td><p>添付ファイルデータを出力しません。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-h,</span> <span class="pre">--help</span></code></p></td>
<td><p>ヘルプメッセージを表示します。</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.7 で追加: </span>--zip-mode, without-attachements オプションが追加されました。</p>
</div>
</section>
<section id="export-dir">
<span id="data-export-dir-option"></span><h3><span class="section-number">1.6.5. </span>export_dirのオプション<a class="headerlink" href="#export-dir" title="この見出しへのパーマリンク">¶</a></h3>
<p>export_dirコマンドには以下のオプションがあります。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--directory=DIRECTORY</span></code></p></td>
<td><p>エクスポートするパスの起点となる
ディレクトリを指定します。
(デフォルトは'/')</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--property-mode</span></code></p></td>
<td><p>表示名など属性も出力します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--datetime-mode</span></code></p></td>
<td><p>作成日時と更新日時も出力します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--current=CURRENT_DIR</span></code></p></td>
<td><p>出力先のディレクトリを指定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--without-attachments</span></code></p></td>
<td><p>添付ファイルデータを出力しません。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--inline-attachments</span></code></p></td>
<td><p>添付ファイルデータをYAMLファイルに含めて出力します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--linesep=LINESEP</span></code></p></td>
<td><p>代表フィールドを出力するときの改行コードを指定
します。 <code class="docutils literal notranslate"><span class="pre">LINESEP</span></code> には <code class="docutils literal notranslate"><span class="pre">os_linesep</span></code>、 <code class="docutils literal notranslate"><span class="pre">lf</span></code>、
<code class="docutils literal notranslate"><span class="pre">crlf</span></code>、 <code class="docutils literal notranslate"><span class="pre">no_change</span></code> のいずれかを指定できます。
<code class="docutils literal notranslate"><span class="pre">os_linesep</span></code> では OS 標準の改行コードに、 <code class="docutils literal notranslate"><span class="pre">lf</span></code>
では <code class="docutils literal notranslate"><span class="pre">\n</span></code> に、 <code class="docutils literal notranslate"><span class="pre">crlf</span></code> では <code class="docutils literal notranslate"><span class="pre">\r\n</span></code> に変換します
。 <code class="docutils literal notranslate"><span class="pre">no_change</span></code> を指定したときは改行コードを変更し
ません。デフォルトでは <code class="docutils literal notranslate"><span class="pre">os_linesep</span></code> です。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-h,</span> <span class="pre">--help</span></code></p></td>
<td><p>ヘルプメッセージを表示します。</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.7 で追加: </span>--without-attachements, --inline-attachments オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.9 で追加: </span>--linesep オプションが追加されました。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">--linesep</span></code> は <a class="reference internal" href="#data-export"><span class="std std-ref">テキスト形式</span></a> のファイルにのみ影響します。</p>
</div>
</section>
<section id="import-data">
<span id="data-import-data-option"></span><h3><span class="section-number">1.6.6. </span>import_dataのオプション<a class="headerlink" href="#import-data" title="この見出しへのパーマリンク">¶</a></h3>
<p>import_dataコマンドには以下のオプションがあります。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--user=USER</span></code></p></td>
<td><p>インポートするデータの所有者をUSER
(ユーザーIDを指定)に設定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--directory=ORIGIN-DIR</span></code></p></td>
<td><p>インポート先の起点となるディレクトリを指定します。
(デフォルトは'/')</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--overwrite-mode</span></code></p></td>
<td><p>既存のオブジェクトがある場合に上書きします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--owner-mode</span></code></p></td>
<td><p>インポートするデータの所有者を
エクスポート時の所有者情報に設定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--update-config-mode</span></code></p></td>
<td><p>Config型オブジェクトの設定データも上書きします。
(--overwrite-mode オプションも同時に指定する必要があります)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--now-updated-mode</span></code></p></td>
<td><p>現在時刻をオブジェクトの更新日時に設定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-h,</span> <span class="pre">--help</span></code></p></td>
<td><p>ヘルプメッセージを表示します。</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.7 で追加: </span>--update-config-mode オプションが追加されました。</p>
</div>
</section>
<section id="import-dir">
<span id="data-import-dir-option"></span><h3><span class="section-number">1.6.7. </span>import_dirのオプション<a class="headerlink" href="#import-dir" title="この見出しへのパーマリンク">¶</a></h3>
<p>import_dirコマンドには以下のオプションがあります。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--user=USER</span></code></p></td>
<td><p>インポートするデータの所有者をUSER
(ユーザーIDを指定)に設定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--directory=ORIGIN-DIR</span></code></p></td>
<td><p>インポート先の起点となるディレクトリを指定します。
(デフォルトは'/')</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--overwrite-mode</span></code></p></td>
<td><p>既存のオブジェクトがある場合に上書きします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--owner-mode</span></code></p></td>
<td><p>インポートするデータの所有者を
エクスポート時の所有者情報に設定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--update-config-mode</span></code></p></td>
<td><p>Config型オブジェクトの設定データも上書きします。
(--overwrite-mode オプションも同時に指定する必要があります)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--now-updated-mode</span></code></p></td>
<td><p>現在時刻をオブジェクトの更新日時に設定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--linesep=LINESEP</span></code></p></td>
<td><p>代表フィールドを読み込むときの改行コードを指定します。
<code class="docutils literal notranslate"><span class="pre">LINESEP</span></code> には <code class="docutils literal notranslate"><span class="pre">os_linesep</span></code>、 <code class="docutils literal notranslate"><span class="pre">lf</span></code>、 <code class="docutils literal notranslate"><span class="pre">crlf</span></code>、 <code class="docutils literal notranslate"><span class="pre">no_change</span></code>
のいずれかを指定できます。 <code class="docutils literal notranslate"><span class="pre">os_linesep</span></code> では OS 標準の改行コードに、
<code class="docutils literal notranslate"><span class="pre">lf</span></code> では <code class="docutils literal notranslate"><span class="pre">\n</span></code> に、 <code class="docutils literal notranslate"><span class="pre">crlf</span></code> では <code class="docutils literal notranslate"><span class="pre">\r\n</span></code> に変換します。 <code class="docutils literal notranslate"><span class="pre">no_change</span></code>
を指定したときは改行コードを変更しません。デフォルトでは <code class="docutils literal notranslate"><span class="pre">crlf</span></code> です。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-h,</span> <span class="pre">--help</span></code></p></td>
<td><p>ヘルプメッセージを表示します。</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.7 で追加: </span>--update-config-mode オプションが追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.9 で追加: </span>--linesep オプションが追加されました。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">--linesep</span></code> は <a class="reference internal" href="#data-export"><span class="std std-ref">テキスト形式</span></a> のファイルにのみ影響します。</p>
</div>
</section>
</section>
<section id="license">
<span id="id41"></span><h2><span class="section-number">1.7. </span>Kompiraライセンス<a class="headerlink" href="#license" title="この見出しへのパーマリンク">¶</a></h2>
<p>license_infoコマンドを用いて、Kompiraのライセンス状態を確認することができます。
license_infoコマンドの形式は以下のとおりです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/bin/manage.py license_info
</pre></div>
</div>
<p>以下はライセンスが登録されている場合の実行例です。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py license_info
*** Kompira License Information ***
License ID:     KP-REGLM0-0000000001
Edition:        REGL
Hardware ID:    NODE:000C29FB949E
Expire date:    2015-12-31
The number of registered nodes: 0 / 100
The number of registered jobflows:      2 / 100
The number of registered scripts:       0 / 100
Licensee:       fixpoint,inc.
Signature:      dwyWvG9eKbnGxcpWfVr1H0wSybLkGL7UqB2E6d5f0jYapfTx/AABJ66W3sRpK0byk+9Y724
                NuEZ9Rh90ySU8f2GRsIyujuVrgPloajokbdZrPFIqOlyvLkak8MAWcGJxiioPHPNd2Tv2BN
                Osq6bs5ZfJlCReEJhYyyngnXjeLBM=
</pre></div>
</div>
<p>ライセンスが登録されていない場合は、仮ライセンス情報が表示されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py license_info
*** Kompira License Information ***
License ID:     KP-TEMP-0000000000
Edition:        temporary
Hardware ID:    NODE:000C29FB949E
Expire date:    2015-01-22
The number of registered nodes: 0 / 100
The number of registered jobflows:      2 / 100
The number of registered scripts:       0 / 100
Licensee:
Signature:      None

Kompira is running with temporary license.
</pre></div>
</div>
<p>ライセンスファイルパスは/var/opt/kompira/kompira.licです。</p>
<p>license_updateコマンドを用いて、上記のパスにライセンスファイルを配置したり更新したりすることができます。</p>
<p>license_updateコマンドの形式は以下のとおりです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/bin/manage.py license_update &lt;LICENSE_FILE&gt;
</pre></div>
</div>
<p>license_updateコマンドには以下のオプションがあります。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--no-backup</span></code></p></td>
<td><p>ライセンスファイルのバックアップを行いません</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--force</span></code></p></td>
<td><p>ライセンスファイルの検証に失敗しても強制的に更新します</p></td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.2 で追加: </span>license_update コマンド</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<p><a class="reference internal" href="usage.html#settings-license"><span class="std std-ref">ライセンス管理</span></a>: ライセンスの確認と登録はブラウザ上からも行うことが可能です。</p>
</div>
</section>
<section id="misc">
<span id="id42"></span><h2><span class="section-number">1.8. </span>秘密鍵の管理<a class="headerlink" href="#misc" title="この見出しへのパーマリンク">¶</a></h2>
<section id="misc-keychange">
<span id="id43"></span><h3><span class="section-number">1.8.1. </span>秘密鍵の変更<a class="headerlink" href="#misc-keychange" title="この見出しへのパーマリンク">¶</a></h3>
<p>パスワードフィールドの暗号化に使用する秘密鍵を変更するには、change_secretkey コマンドをroot権限で実行します。
実行するとデータベースに暗号化されて保存されている全てのパスワードデータを新しい秘密鍵で再暗号化して保存し直します。</p>
<p>change_secretkeyは以下の形式です。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/manage.py change_secretkey [options] &lt;new_secretkey&gt;
</pre></div>
</div>
<p>オプションは以下のとおりです。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--no-backup</span></code></p></td>
<td><p>変更前の鍵をバックアップしません。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--force</span></code></p></td>
<td><p>途中で再暗号化に失敗したパスワードデータがあっても、
再暗号化を続行します。</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>秘密鍵の文字列は /var/opt/kompira/.secret_key に保存されています。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>change_secretkey を実行後は、 httpd サービスと kompirad サービスをリスタートしてください。
冗長構成の場合は、アクティブ側で change_secretkey を実行した後で、スタンバイ側への切り替えを行ってください。</p>
</div>
</section>
</section>
<section id="ha">
<span id="id44"></span><h2><span class="section-number">1.9. </span>冗長構成管理<a class="headerlink" href="#ha" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompira を2台のサーバで Pacemaker/corosync を用いた Active-Standby 型の冗長構成で動作させることができます。
ここでは、そのインストール方法や状態確認方法、フェイルオーバー等について記述します。</p>
<section id="ha-introduction">
<span id="id45"></span><h3><span class="section-number">1.9.1. </span>はじめに<a class="headerlink" href="#ha-introduction" title="この見出しへのパーマリンク">¶</a></h3>
<p>PacemakerはKompiraが動作する上で必要なリソース(アプリケーション)を監視し、エラーを検知した場合はフェイルオーバーを行なうことで冗長性を実現します。</p>
<p>Pacemakerで監視するリソースの一覧を以下に示します。</p>
<dl class="simple">
<dt><strong>httpd, kompirad, kompira_jobmngrd</strong></dt><dd><p>Kompiraの動作に必要なプロセスです。
アクティブ状態のサーバ上でのみ動作します。</p>
</dd>
<dt><strong>RabbitMQ</strong></dt><dd><p>Kompiraの動作に必要なRabbitMQプロセスです。
アクティブ状態のサーバのプロセスがMaster、スタンバイ状態のサーバのプロセスがSlaveとして動作します。</p>
</dd>
<dt><strong>IPaddr2</strong></dt><dd><p>仮想IPアドレスを管理するためのリソースです。</p>
</dd>
<dt><strong>PostgreSQL</strong></dt><dd><p>PostgreSQLデータベースプロセスです。
アクティブ状態のサーバのプロセスがMaster、スタンバイ状態のサーバのプロセスがSlaveとして動作します。
PostgreSQLはレプリケーションの設定がされており、プライマリ機とセカンダリ機のデータが同期されます。</p>
</dd>
</dl>
</section>
<section id="ha-install">
<span id="id46"></span><h3><span class="section-number">1.9.2. </span>インストール<a class="headerlink" href="#ha-install" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompiraの冗長構成を構築する場合、2台のサーバにそれぞれKompiraをインストールしてから、
プライマリ機、セカンダリ機の順に冗長構成のセットアップを実施する必要があります。</p>
<p>2台のサーバには2つのネットワークインタフェースが必要になります。
ネットワークインターフェース名は OS のバージョンや環境によって、eth0, eth1,... であったり、ens192, ens224,... であったりします。</p>
<p>以降の説明では、それぞれのサーバをプライマリ機(ha-kompira1)、セカンダリ機(ha-kompira2)と呼び、ネットワークインターフェースとしては eth0, eth1 を持っていることとします。
また、eth0 はサービス提供用のネットワークに接続され、eth1 はハートビート用インターフェースとして使用するため独立したネットワークで 2 台のサーバが接続されていることとします。</p>
<p>なお、冗長構成を構築した初期状態ではプライマリ機がアクティブ状態、セカンダリ機がスタンバイ状態となります。</p>
<p>Kompira の冗長構成を構築するにはパッケージに含まれる setup_cluster.sh を利用します。
以下ではOSインストール直後のサーバ2台に対して、冗長構成のKompiraをインストールする手順を記述します。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>setup_cluster.sh は、install.sh と同様に外部から必要な各種ミドルウェアをダウンロードします。
外部ネットワークに接続可能な環境で実行してください。</p>
</div>
<section id="ha-install-primary">
<span id="id47"></span><h4><span class="section-number">1.9.2.1. </span>プライマリ機の設定<a class="headerlink" href="#ha-install-primary" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompiraパッケージを通常インストール後、--primary オプションを指定して setup_cluster.sh を実行することでプライマリ機のセットアップを行います。</p>
<p>また setup_cluster.sh を実行するときに、以下の情報を引数で指定します。</p>
<ul class="simple">
<li><p>ハートビートネットワークデバイス名</p></li>
<li><p>クラスタに割り当てる仮想IPアドレス(VIP)とそのネットワークマスク長</p></li>
</ul>
<p>例えば、ハートビートネットワークデバイスとして eth1 を、仮想IPアドレスとして 192.168.0.100 とネットワークマスク長に 24 を指定する場合、以下のようにコマンドを実行します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh
# ./setup_cluster.sh --primary --heartbeat-device eth1 192.168.0.100/24
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>内部的には冗長構成の各ノードを名前解決できる必要があるため、<code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> に ha-kompira1 (プライマリ機)や ha-kompira2 (セカンダリ機)といった別名の登録を行なうようになっています。setup_cluster.sh ではサーバのホスト名は変更しません。</p>
</div>
</section>
<section id="ha-install-secondary">
<span id="id48"></span><h4><span class="section-number">1.9.2.2. </span>セカンダリ機の設定<a class="headerlink" href="#ha-install-secondary" title="この見出しへのパーマリンク">¶</a></h4>
<p>Kompiraパッケージを通常インストール後、--secondary オプションを指定して setup_cluster.sh を実行することでセカンダリ機のセットアップを行ないます。</p>
<p>また setup_cluster.sh を実行するときに、以下の情報を引数で指定します。仮想IPアドレスの指定は不要です。</p>
<ul class="simple">
<li><p>ハートビートネットワークデバイス名</p></li>
</ul>
<p>例えば、ハートビートネットワークデバイスとして eth1 を指定する場合、以下のようにコマンドを実行します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh
# ./setup_cluster.sh --secondary --heartbeat-device eth1
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>セカンダリ機でのsetup_cluster.shの実行時、プライマリ機からデータベースのスナップショットを取得します。
セットアップ済みのプライマリ機を立ち上げ、接続している状態でsetup_cluster.shを実行してください。</p>
</div>
</section>
<section id="ha-install-check">
<span id="id49"></span><h4><span class="section-number">1.9.2.3. </span>状態確認<a class="headerlink" href="#ha-install-check" title="この見出しへのパーマリンク">¶</a></h4>
<p>プライマリ機、セカンダリ機でインストール処理が完了したら、以下のURLに対してWebブラウザからアクセスし、
ログイン画面が表示されることを確認してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>http://192.168.0.100/
</pre></div>
</div>
<p>URLはプライマリ機インストール時に設定した仮想IPアドレスです。
このURLはプライマリ機に障害が発生し、フェイルオーバーが発生した場合でも維持されます。</p>
<p>また、冗長構成の各リソースの状態を確認するには、プライマリ機またはセカンダリ機でcrm_monコマンドを使用します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># crm_mon -A1
Cluster Summary:
  * Stack: corosync
  * Current DC: ha-kompira1 (version 2.1.0-8.el8-7c3f660707) - partition with quorum
  * Last updated: Wed Sep  8 22:21:02 2021
  * Last change:  Wed Sep  8 22:19:56 2021 by hacluster via crmd on ha-kompira1
  * 2 nodes configured
  * 9 resource instances configured

Node List:
  * Online: [ ha-kompira1 ha-kompira2 ]

Active Resources:
  * Resource Group: webserver:
    * res_memcached     (systemd:memcached):     Started ha-kompira1
    * res_kompirad      (systemd:kompirad):      Started ha-kompira1
    * res_kompira_jobmngrd      (systemd:kompira_jobmngrd):      Started ha-kompira1
    * res_httpd (ocf::heartbeat:apache):         Started ha-kompira1
    * res_vip   (ocf::heartbeat:IPaddr2):        Started ha-kompira1
  * Clone Set: res_pgsql-clone [res_pgsql] (promotable):
    * Masters: [ ha-kompira1 ]
    * Slaves: [ ha-kompira2 ]
  * Clone Set: res_rabbitmq-clone [res_rabbitmq]:
    * Started: [ ha-kompira1 ha-kompira2 ]

Node Attributes:
  * Node: ha-kompira1:
    * master-res_pgsql                  : 1001
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira1
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira1
  * Node: ha-kompira2:
    * master-res_pgsql                  : 1000
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira2
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira2
</pre></div>
</div>
<p>crm_monコマンドの出力において確認するべき点を示します。</p>
<ul>
<li><p><strong>Resource Group</strong></p>
<blockquote>
<div><p>アクティブ機のみで動作するリソースが表示されます。
「Started &lt;アクティブ機のホスト名&gt;」と表示されていれば正常です。</p>
</div></blockquote>
</li>
<li><p><strong>Clone Set</strong></p>
<blockquote>
<div><p>両方のサーバで動作するリソースが表示されます。
promotable リソースの場合、Mastersにアクティブ機側のホスト名、Slavesにスタンバイ機側のホスト名が表示されていれば正常です。</p>
</div></blockquote>
</li>
<li><p><strong>Node Attributes</strong></p>
<blockquote>
<div><p>PostgreSQLプロセスの詳細な状態が表示されています。
正しくレプリケーションが行われている場合、
master-res_pgsqlの行にアクティブ機側には 1001、スタンバイ機側には 1000 と表示されます。</p>
</div></blockquote>
</li>
</ul>
</section>
<section id="ha-license">
<span id="id50"></span><h4><span class="section-number">1.9.2.4. </span>ライセンス登録<a class="headerlink" href="#ha-license" title="この見出しへのパーマリンク">¶</a></h4>
<p>冗長構成の場合、アクティブ機とスタンバイ機、両方のサーバに対してそれぞれライセンスファイルを登録する必要があります。</p>
<p><a class="reference internal" href="#license"><span class="std std-ref">Kompiraライセンス</span></a> に記載された手順を実行し、各サーバに対してライセンスファイルを登録してください。</p>
</section>
</section>
<section id="ha-update">
<span id="id51"></span><h3><span class="section-number">1.9.3. </span>アップデート<a class="headerlink" href="#ha-update" title="この見出しへのパーマリンク">¶</a></h3>
<p>まず、冗長構成のアップデートに際しての注意点を示します。</p>
<ul class="simple">
<li><p>アップデート作業前にアクティブ系・スタンバイ系ともに正常に動作していることをご確認ください。片系しか正常に動作していないような環境では、アップデートできない可能性もあります。</p></li>
<li><p>各ステップで異常が発生していないか、アップデートに失敗していないかなど確認しながら作業するようにしてください。</p></li>
<li><p>いずれのアップデート手順でも、アクティブ系で実行中であったジョブは強制終了されます。アップデート後の起動および系切り替えで、強制終了されたジョブの動作が再開するわけではありませんのでご注意ください。</p></li>
<li><p>アップデート手順について、バージョンに特有の注意事項がある場合があります。事前にリリースノート等をご確認ください。</p></li>
<li><p>古い erlang / rabbitmq-server を利用していた環境では、以下に示す片系停止アップデート手順が行なえない場合があります。</p></li>
<li><p>rabbitmq-server は互換性のためマイナーバージョンを +1 づつしかアップデートしません。最新版まで更新するには複数回アップデートする必要がある場合があります。</p></li>
<li><p>rabbitmq-server はマイナーバージョンが上がると機能が追加されている場合があります。有効でない機能があると次回アップデートできない場合がありますので、アップデート後は <code class="docutils literal notranslate"><span class="pre">rabbitmqctl</span> <span class="pre">enable_feature_flag</span> <span class="pre">all</span></code> コマンドで全ての機能を有効にするようにしてください。</p></li>
<li><p>PostgreSQL のアップグレードを実施する場合は、両系停止アップデート手順を基本とした専用の手順になりますのでご注意ください。</p></li>
</ul>
<p>冗長構成をアップデートする場合、大きく2通りのアップデート手順があります。その手順によって、Master/Slave の切り替えを伴う方式と、切り替えを伴わない方式を選ぶことができます。以下に、簡単な手順を示しますので参考にしてください。</p>
<section id="id52">
<h4><span class="section-number">1.9.3.1. </span>両系停止アップデート手順（切り替えを伴わない）<a class="headerlink" href="#id52" title="この見出しへのパーマリンク">¶</a></h4>
<ol class="arabic simple">
<li><p>スタンバイ系を停止 (pcs cluster stop)</p></li>
<li><p>アクティブ系を停止 (pcs cluster stop --force) ※ここで動作中のジョブが強制終了します</p></li>
<li><p>アクティブ系をアップデート (./install.sh) ※ここで自動起動ジョブが開始します</p></li>
<li><p>スタンバイ系をアップデート (./install.sh)</p></li>
<li><p>rabbitmq-server の機能有効化 (rabbitmqctl enable_feature_flag all) ※ rabbitmq-server がマイナーアップデートした場合</p></li>
</ol>
<p>系切り替えが発生しない代わりに両系を停止するため、ジョブが停止する期間が長めになります。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>両系停止アップデートの手順3、および、片系停止アップデートの手順2で install.sh の --skip-cluster-start オプションを指定すると、冗長構成の設定が正しく更新されないことがあるのでご注意ください。</p>
</div>
</section>
<section id="id53">
<h4><span class="section-number">1.9.3.2. </span>片系停止アップデート手順（切り替えを伴う）<a class="headerlink" href="#id53" title="この見出しへのパーマリンク">¶</a></h4>
<ol class="arabic simple">
<li><p>スタンバイ系を停止 (pcs cluster stop)</p></li>
<li><p>スタンバイ系をアップデート (./install.sh)</p></li>
<li><p>アクティブ系を停止 (pcs cluster stop) ※ここで系切り替えが発生して、アップデート済みのスタンバイ系がアクティブになります。旧アクティブ系で動作中であったジョブは強制終了して、新アクティブ系で自動起動ジョブが開始します。</p></li>
<li><p>旧アクティブ系をアップデート (./install.sh)</p></li>
<li><p>rabbitmq-server の機能有効化 (rabbitmqctl enable_feature_flag all) ※ rabbitmq-server がマイナーアップデートした場合</p></li>
</ol>
<p>系切り替えを伴いますが、片系は動作しているため、ジョブが停止する期間が短めになります。</p>
<p>ただし、古い erlang / rabbitmq-server からアップデートする場合など互換性に問題がある場合は、片系停止アップデートは行なえません。
このとき、install.sh の最後に以下のような警告が表示され、クラスタの自動再開処理もスキップされます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2023-02-03 12:00:00] WARN: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-02-03 12:00:00] WARN:
[2023-02-03 12:00:00] WARN: FULL STOP UPGRADES ARE REQUIRED! (For version compatibility)
[2023-02-03 12:00:00] WARN:
[2023-02-03 12:00:00] WARN:   erlang: R16B -&gt; 23.3.4.11
[2023-02-03 12:00:00] WARN:   rabbitmq-server: 3.3.5 -&gt; 3.10.0
[2023-02-03 12:00:00] WARN:
[2023-02-03 12:00:00] WARN:  - Automatic cluster start was skipped.
[2023-02-03 12:00:00] WARN:  - Please stop both systems and upgrade each one.
[2023-02-03 12:00:00] WARN:  - Then start the clusters in order with the following command.
[2023-02-03 12:00:00] WARN:
[2023-02-03 12:00:00] WARN:      # pcs cluster start
[2023-02-03 12:00:00] WARN:
[2023-02-03 12:00:00] WARN:  - At that time, start the cluster first on the node that was active before the upgrade.
[2023-02-03 12:00:00] WARN:
[2023-02-03 12:00:00] WARN: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</pre></div>
</div>
<p>この場合は、両系停止アップデート手順に切り替えてください。
アップデート後は pcs cluster start コマンドで冗長構成をアクティブ系から順次再開してください。</p>
</section>
<section id="ha-update-with-pg-upgrade">
<span id="id54"></span><h4><span class="section-number">1.9.3.3. </span>PostgreSQL アップグレードを伴う両系停止アップデート手順<a class="headerlink" href="#ha-update-with-pg-upgrade" title="この見出しへのパーマリンク">¶</a></h4>
<p>冗長構成で PostgreSQL のアップグレードを実施する場合は、両系停止アップデートを基本とした専用の手順となります。
以下のように手順 3 および手順 4 で、アップグレードしたい PostgreSQL のバージョンを指定してください。</p>
<ol class="arabic simple">
<li><p>スタンバイ系を停止 (pcs cluster stop)</p></li>
<li><p>アクティブ系を停止 (pcs cluster stop --force) ※ここで動作中のジョブが強制終了します</p></li>
<li><p>アクティブ系をアップデート (./install.sh --postgresql-version=17)</p></li>
<li><p>スタンバイ系をアップデート (./install.sh --postgresql-version=17)</p></li>
<li><p>アクティブ系を再開 (pcs cluster start)</p></li>
<li><p>スタンバイ系を sync_master.sh で再開 (/opt/kompira/bin/sync_master.sh --force)</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>手順 3 および手順 4 で、必ず同じメジャーバージョンを指定するようにしてください。</p>
</div>
<p>手順 3 および手順 4 における install.sh の最後に以下のような警告が表示され、クラスタの自動再開処理もスキップされます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2024-10-29 12:00:00] WARN: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN: FULL STOP UPGRADES ARE REQUIRED! (For version compatibility)
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN:   postgresql: 12.17 -&gt; 17.0
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN:  - Automatic cluster start was skipped.
[2024-10-29 12:00:00] WARN:  - Please stop both systems and upgrade each one.
[2024-10-29 12:00:00] WARN:  - First, start the cluster with the following command on the node that was active before the upgrade.
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN:      # pcs cluster start
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN:  - Next, start the cluster with the following command on the node that was standby before the upgrade.
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN:      # /opt/kompira/bin/sync_master.sh --force
[2024-10-29 12:00:00] WARN:
[2024-10-29 12:00:00] WARN: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</pre></div>
</div>
<p>このあと手順 5 として、アクティブ系を基本の手順同様に pcs cluster start でクラスタを再開させてください。このとき pcs status や crm_mon コマンドで、アクティブ系のすべてのリソースが正常に起動することを確認してください。</p>
<p>最後に手順 6 として、スタンバイ系を sync_master.sh で再開させてください。このとき <code class="docutils literal notranslate"><span class="pre">--force</span></code> オプションを付けて、強制的にアクティブ系のデータを同期するようにしてください。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.6 で変更: </span>冗長構成時の install.sh 実行後に自動で pcs cluster start を実行するようになりました。
これにともない冗長構成のアップデート手順が変更されました。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8 で変更: </span>片系停止アップデートが行なえない場合、警告を表示して pcs cluster start をスキップするようになりました。</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.8.post2 で変更: </span>冗長構成では rabbitmq-server はマイナーバージョンが +1 づつしか上がらないようになりました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.8.post2 で追加: </span>rabbitmq-server の機能を有効化する手順が追加されました。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">バージョン 1.6.10 で追加: </span>PostgreSQL アップグレードを伴う両系停止アップデート手順を追加しました。</p>
</div>
</section>
</section>
<section id="ha-stop-start">
<span id="id55"></span><h3><span class="section-number">1.9.4. </span>冗長構成の停止・起動<a class="headerlink" href="#ha-stop-start" title="この見出しへのパーマリンク">¶</a></h3>
<p>冗長構成で動作しているKompiraの停止・起動方法について記述します。</p>
<p>はじめに、crm_monコマンドを使用して2台のサーバのどちらがアクティブ状態として動作しているかを確認します。
crm_monコマンド中のリソース部分の表示で、「Started」および「Masters」と表示されているのがアクティブ状態のサーバとなります。</p>
<p>以降の説明では、ha-kompira1がアクティブ状態であると仮定して手順を記述します。</p>
<p>原則として、停止する場合はスタンバイ機を停止してからアクティブ機を停止、
起動する場合はアクティブ機を起動してからスタンバイ機を起動という順序で行います。</p>
<p>これは、アクティブ機を先に停止するとスタンバイ機がアクティブ機に異常が起こったと判断してフェイルオーバー処理が行われてしまうためです。
誤ってフェイルオーバーがされてしまった場合は、<a class="reference internal" href="#ha-recovery"><span class="std std-ref">フェイルオーバー時の動作とフェイルバック</span></a> の手順を参照してください。</p>
<section id="id56">
<h4><span class="section-number">1.9.4.1. </span>冗長構成の停止<a class="headerlink" href="#id56" title="この見出しへのパーマリンク">¶</a></h4>
<p>まず、セカンダリ(ha-kompira2)のPacemakerプロセスを停止します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># pcs cluster stop
Stopping Cluster (pacemaker)...
Stopping Cluster (corosync)...
</pre></div>
</div>
<p>サービスが停止したのを確認してから、プライマリ(ha-kompira1)で同様の処理を行います。冗長構成の最後の一台を停止させるときは --force オプションが必要になります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># pcs cluster stop --force
Stopping Cluster (pacemaker)...
Stopping Cluster (corosync)...
</pre></div>
</div>
<p>これでPacemaker/corosyncによるリソースの監視が停止します。
なお、pacemakerプロセスが停止している場合、crm_monコマンドは実行できないことに注意してください。</p>
<p>プロセスだけでなくサーバーOSのシャットダウンを行う場合、上記処理は必要ありません。
ただし、シャットダウンの場合もスタンバイ機のシャットダウンが完了してからアクティブ機のシャットダウンを行ってください。</p>
</section>
<section id="id57">
<h4><span class="section-number">1.9.4.2. </span>冗長構成の起動<a class="headerlink" href="#id57" title="この見出しへのパーマリンク">¶</a></h4>
<p>起動を行う場合は、停止とは反対の手順を実行します。
はじめに、プライマリ(ha-kompira1)のPacemakerプロセスを起動します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># pcs cluster start
Starting Cluster...
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>RHEL7 系など Pacemaker (1.x) 環境では、pcs cluster start 実行時には以下のように表示されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># pcs cluster start
Starting Cluster (corosync)...
Starting Cluster (pacemaker)...
</pre></div>
</div>
</div>
<p>pacemakerプロセスが起動すると、pacemakerに登録されているリソースが順次起動します。
crm_monコマンドを実行し、全てのリソースが起動するまで待機してください。</p>
<p>リソースが起動したら、セカンダリ(ha-kompira2)のPacemakerプロセスを起動します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># pcs cluster start
Starting Cluster...
</pre></div>
</div>
<p>以上で冗長構成の起動が完了します。</p>
<p>プロセスだけでなくサーバーOSの起動から行う場合、上記処理は必要ありません。
Pacemakerサービスは自動起動されるように設定されています。</p>
<p>アクティブ機を起動し、起動が完了したことを確認してからスタンバイ機の起動を行ってください。</p>
</section>
</section>
<section id="ha-recovery">
<span id="id58"></span><h3><span class="section-number">1.9.5. </span>フェイルオーバー時の動作とフェイルバック<a class="headerlink" href="#ha-recovery" title="この見出しへのパーマリンク">¶</a></h3>
<p>アクティブ機で何らかの障害が発生すると、自動的にフェイルオーバーが実行されてスタンバイ機がアクティブ状態に昇格します。</p>
<p>以下はアクティブ状態であったha-kompira1がシャットダウンした後にha-kompira2でcrm_monコマンドを実行した場合の表示です。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># crm_mon -A1
Cluster Summary:
  * Stack: corosync
  * Current DC: ha-kompira2 (version 2.1.0-8.el8-7c3f660707) - partition with quorum
  * Last updated: Wed Sep  8 22:27:37 2021
  * Last change:  Wed Sep  8 22:27:09 2021 by root via crm_attribute on ha-kompira2
  * 2 nodes configured
  * 9 resource instances configured

Node List:
  * Online: [ ha-kompira2 ]
  * OFFLINE: [ ha-kompira1 ]

Active Resources:
  * Resource Group: webserver:
    * res_memcached     (systemd:memcached):     Started ha-kompira2
    * res_kompirad      (systemd:kompirad):      Started ha-kompira2
    * res_kompira_jobmngrd      (systemd:kompira_jobmngrd):      Started ha-kompira2
    * res_httpd (ocf::heartbeat:apache):         Started ha-kompira2
    * res_vip   (ocf::heartbeat:IPaddr2):        Started ha-kompira2
  * Clone Set: res_pgsql-clone [res_pgsql] (promotable):
    * Masters: [ ha-kompira2 ]
  * Clone Set: res_rabbitmq-clone [res_rabbitmq]:
    * Started: [ ha-kompira2 ]

Node Attributes:
  * Node: ha-kompira2:
    * master-res_pgsql                  : 1001
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira2
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira2
</pre></div>
</div>
<p>ha-kompira1がOFFLINEと表示されており、各リソースはha-kompira2上で動作していることが確認できます。</p>
<p>以降では、ha-kompira1が復旧可能だった場合、復旧不能だった場合に分けて手順を記述します。</p>
<section id="id59">
<h4><span class="section-number">1.9.5.1. </span>サーバーが復旧可能だった場合<a class="headerlink" href="#id59" title="この見出しへのパーマリンク">¶</a></h4>
<p>シャットダウンしたha-kompira1を正常に起動できた場合の手順です。</p>
<p>ha-kompira1を起動すると、状態は以下のようになります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># crm_mon -A1
Cluster Summary:
  * Stack: corosync
  * Current DC: ha-kompira2 (version 2.1.0-8.el8-7c3f660707) - partition with quorum
  * Last updated: Wed Sep  8 22:35:16 2021
  * Last change:  Wed Sep  8 22:34:57 2021 by root via crm_attribute on ha-kompira2
  * 2 nodes configured
  * 9 resource instances configured

Node List:
  * Online: [ ha-kompira1 ha-kompira2 ]

Active Resources:
  * Resource Group: webserver:
    * res_memcached     (systemd:memcached):     Started ha-kompira2
    * res_kompirad      (systemd:kompirad):      Started ha-kompira2
    * res_kompira_jobmngrd      (systemd:kompira_jobmngrd):      Started ha-kompira2
    * res_httpd (ocf::heartbeat:apache):         Started ha-kompira2
    * res_vip   (ocf::heartbeat:IPaddr2):        Started ha-kompira2
  * Clone Set: res_pgsql-clone [res_pgsql] (promotable):
    * Masters: [ ha-kompira2 ]
    * Slaves: [ ha-kompira1 ]
  * Clone Set: res_rabbitmq-clone [res_rabbitmq]:
    * Started: [ ha-kompira1 ha-kompira2 ]

Node Attributes:
  * Node: ha-kompira1:
    * master-res_pgsql                  : -1
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira1
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira1
  * Node: ha-kompira2:
    * master-res_pgsql                  : 1001
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira2
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira2
</pre></div>
</div>
<p>ha-kompira1ではデータベースが正しく同期されておらず、スタンバイ機として正常な状態にはなっていません。</p>
<p>スタンバイ機としてのセットアップを完了するためには、スタンバイ機でkompiraパッケージに付属しているsync_master.shを使用します。
sync_master.shはアクティブ機のデータベースをスタンバイ機にコピーし、レプリケーションの設定を行った上でデータベースプロセスを起動します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/sync_master.sh
[2023-08-03 18:19:46] ****: ****************************************************************
[2023-08-03 18:19:46] ****: Kompira-1.6.8.post3:
[2023-08-03 18:19:46] ****: Start: Sync with the Master
...
[2023-08-03 18:19:49] INFO: Waiting for the resources to stabilize.
[2023-08-03 18:19:49] INFO: nodes[2]: ha-kompira1 ha-kompira2 (local=ha-kompira1)
[2023-08-03 18:19:49] INFO: webserver resources[5]: res_memcached res_kompirad res_kompira_jobmngrd res_httpd res_vip
---------------------------------+------------------------------------------------------------+------------------------------------------------------
    postgres[0],     postgres[1] |                  rabbitmq[0],                  rabbitmq[1] | memcached,  kompirad,  jobmngrd,     httpd,       vip
---------------------------------+------------------------------------------------------------+------------------------------------------------------
    Slave(1000),    Master(1001) |                           (),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                   Starting(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |                    Started(),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
    Slave(1000),    Master(1001) |  Started(rabbit@ha-kompira1),  Started(rabbit@ha-kompira2) |   Started,   Started,   Started,   Started,   Started
---------------------------------+------------------------------------------------------------+------------------------------------------------------
...
[2023-08-03 18:19:51] INFO: Display state of resources.
  * Resource Group: webserver:
    * res_memcached     (systemd:memcached):     Started ha-kompira2
    * res_kompirad      (systemd:kompirad):      Started ha-kompira2
    * res_kompira_jobmngrd      (systemd:kompira_jobmngrd):      Started ha-kompira2
    * res_httpd (ocf::heartbeat:apache):         Started ha-kompira2
    * res_vip   (ocf::heartbeat:IPaddr2):        Started ha-kompira2
  * Clone Set: res_pgsql-clone [res_pgsql] (promotable):
    * Masters: [ ha-kompira2 ]
    * Slaves: [ ha-kompira1 ]
  * Clone Set: res_rabbitmq-clone [res_rabbitmq]:
    * Started: [ ha-kompira1 ha-kompira2 ]
[2023-08-03 18:19:51] ****:
[2023-08-03 18:19:51] ****: Finish: Sync with the Master (status=0)
[2023-08-03 18:19:51] ****: ****************************************************************
</pre></div>
</div>
<p>sync_master.shを実行後にcrm_monコマンドを呼び出すと、ha-kompira1 の master-res_pgsql が 1000 となったことが確認できます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># crm_mon -A1
Cluster Summary:
  * Stack: corosync
  * Current DC: ha-kompira2 (version 2.1.0-8.el8-7c3f660707) - partition with quorum
  * Last updated: Thu Sep  9 00:35:55 2021
  * Last change:  Thu Sep  9 00:30:55 2021 by root via crm_attribute on ha-kompira2
  * 2 nodes configured
  * 9 resource instances configured

Node List:
  * Online: [ ha-kompira1 ha-kompira2 ]

Active Resources:
  * Resource Group: webserver:
    * res_memcached     (systemd:memcached):     Started ha-kompira2
    * res_kompirad      (systemd:kompirad):      Started ha-kompira2
    * res_kompira_jobmngrd      (systemd:kompira_jobmngrd):      Started ha-kompira2
    * res_httpd (ocf::heartbeat:apache):         Started ha-kompira2
    * res_vip   (ocf::heartbeat:IPaddr2):        Started ha-kompira2
  * Clone Set: res_pgsql-clone [res_pgsql] (promotable):
    * Masters: [ ha-kompira2 ]
    * Slaves: [ ha-kompira1 ]
  * Clone Set: res_rabbitmq-clone [res_rabbitmq]:
    * Started: [ ha-kompira1 ha-kompira2 ]

Node Attributes:
  * Node: ha-kompira1:
    * master-res_pgsql                  : 1000
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira1
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira1
  * Node: ha-kompira2:
    * master-res_pgsql                  : 1001
    * rmq-node-attr-last-known-res_rabbitmq     : rabbit@ha-kompira2
    * rmq-node-attr-res_rabbitmq        : rabbit@ha-kompira2
</pre></div>
</div>
</section>
<section id="id60">
<h4><span class="section-number">1.9.5.2. </span>サーバーが復旧不能だった場合<a class="headerlink" href="#id60" title="この見出しへのパーマリンク">¶</a></h4>
<p>ハードウェア障害などによって、シャットダウンした機器を交換する必要がある場合の手順です。
この場合、OSインストール直後のサーバを用意し、スタンバイ状態として導入します。</p>
<p>冗長構成環境ではアクティブ機とスタンバイ機それぞれにライセンスファイルを登録する必要があります。
install.sh を実行後、license_infoコマンドを使用してハードウェアIDの確認およびライセンスファイルの登録を行ってください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar zxf kompira-&lt;version&gt;-bin.tar.gz
$ cd kompira-&lt;version&gt;-bin
# ./install.sh

$ cp kompira_KP-EVALM100-0000000001.lic /var/opt/kompira/kompira.lic
$ cd /var/opt/kompira
$ chown apache:apache kompira.lic
$ /opt/kompira/bin/manage.py license_info

# ./setup_cluster.sh --primary --slave-mode
</pre></div>
</div>
<p>上記コマンドは、ha-kompira1をスタンバイ状態としてセットアップする場合の例です。</p>
<p>冗長構成環境ではアクティブ機とスタンバイ機それぞれにライセンスファイルを登録する必要があるため、setup_cluster.shを実行する前にライセンスファイルの登録手順を行う必要があります。</p>
<p>setup_cluster.shの実行においてha-kompira1ではなくha-kompira2を追加する場合は、--primaryオプションの代わりに--secondaryオプションを使用します。</p>
<p>setup_cluster.shの処理が完了したら、<a class="reference internal" href="#ha-install-check"><span class="std std-ref">状態確認</span></a> を参考に動作確認を行ってください。</p>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<p><a class="reference internal" href="#license"><span class="std std-ref">Kompiraライセンス</span></a></p>
</div>
</section>
</section>
<section id="setup-cluster-sh">
<span id="ha-setup-cluster-option"></span><h3><span class="section-number">1.9.6. </span>setup_cluster.shのオプション<a class="headerlink" href="#setup-cluster-sh" title="この見出しへのパーマリンク">¶</a></h3>
<p>setup_cluster.shの動作オプションを以下に示します。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>デフォルト値</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--primary</span></code></p></td>
<td><p>true(指定あり)</p></td>
<td><p>プライマリとしてセットアップを開始します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--secondary</span></code></p></td>
<td><p>false(指定なし)</p></td>
<td><p>セカンダリとしてセットアップを開始します。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">--heartbeat-device=</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DEVICE</span></code></div>
</div>
</div>
</td>
<td></td>
<td><p>ハートビート用ネットワークデバイスを指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--master-mode</span></code></p></td>
<td></td>
<td><p>アクティブ状態としてセットアップします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--slave-mode</span></code></p></td>
<td></td>
<td><p>スタンバイ状態としてセットアップします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--without-vip</span></code></p></td>
<td></td>
<td><p>VIP無しの構成でセットアップします。
(別途ロードバランサ等による ACT/SBY 監視と
アクセス振り分けの設定が必要です)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--without-jobmanager</span></code></p></td>
<td></td>
<td><p>ジョブマネージャ無しの構成でセットアップします。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">--hostname-prefix=</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PREFIX_NAME</span></code></div>
</div>
</div>
</td>
<td><p>ha-kompira</p></td>
<td><p>設定するホスト名のプレフィックスを指定します。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">--heartbeat-netaddr=</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">NETWORK_ADDRESS</span></code></div>
</div>
</div>
</td>
<td><p>192.168.99.0</p></td>
<td><p>ハートビート用インタフェースに設定する
ネットワークアドレスを指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--manual</span></code></p></td>
<td></td>
<td><p>パラメータの自動設定を行いません。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--manual-heartbeat</span></code></p></td>
<td></td>
<td><p>ハートビート用ネットワークを手動設定します。
<code class="docutils literal notranslate"><span class="pre">--heartbeat-primary</span></code> および
<code class="docutils literal notranslate"><span class="pre">--heartbeat-secondary</span></code> の指定が必要です。
<code class="docutils literal notranslate"><span class="pre">--heartbeat-netaddr</span></code> の指定は無視します。
ハートビートはユニキャストモードで動作します。</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">--heartbeat-primary=</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">NETWORK_ADDRESS</span></code></div>
</div>
</div>
</td>
<td></td>
<td><p>プライマリのIPアドレスを指定します。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">--heartbeat-secondary=</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">NETWORK_ADDRESS</span></code></div>
</div>
</div>
</td>
<td></td>
<td><p>セカンダリのIPアドレスを指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--cluster-name=NAME</span></code></p></td>
<td></td>
<td><p>クラスタ名を指定します (15文字まで)。</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">--cluster-device=</span></code></div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DEVICE</span></code></div>
</div>
</div>
</td>
<td></td>
<td><p>VIP を割り当てるネットワークデバイスを
指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--token=TOKEN</span></code></p></td>
<td><p>30000</p></td>
<td><p>トークンタイムアウト (ミリ秒) を指定します。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--consensus=CONSENSUS</span></code></p></td>
<td></td>
<td><p>コンセンサスタイムアウト (ミリ秒) を指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--proxy=PROXY</span></code></p></td>
<td></td>
<td><p>プロキシサーバを以下の形式で指定します。
<code class="docutils literal notranslate"><span class="pre">[user:passwd&#64;]proxy.server:port</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--noproxy=HOSTS</span></code></p></td>
<td></td>
<td><p>プロキシの対象外となるホストをコンマ区切りのリス
トで指定します。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--offline</span></code></p></td>
<td></td>
<td><p>オフラインモードでセットアップします。</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--dry-run</span></code></p></td>
<td></td>
<td><p>ドライランモードで実行します。パラメータチェック
のみで、実際のセットアップは行いません。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--help</span></code></p></td>
<td></td>
<td><p>ヘルプメッセージを表示します。</p></td>
</tr>
</tbody>
</table>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.7 で変更: </span>--token オプションのデフォルト値を 30000 に変更しました。</p>
</div>
</section>
<section id="sync-master-sh">
<span id="ha-sync-master-option"></span><h3><span class="section-number">1.9.7. </span>sync_master.sh のオプション<a class="headerlink" href="#sync-master-sh" title="この見出しへのパーマリンク">¶</a></h3>
<p>sync_master.sh はアクティブ系とデータ同期を取りたいノードで実行してください。
sync_master.sh を実行するとアクティブ系のデータベースを自ノードにコピーして、スタンバイ系としてクラスタを再開させます。
sync_master.sh は何らかの理由でダウンしていたスタンバイ系の回復に用いるため、クラスタを再開できるように pacemaker が記録している失敗履歴をクリアします。</p>
<p>sync_master.sh は以下の形式です。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/sync_master.sh [options]
</pre></div>
</div>
<p>オプションは以下のとおりです。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>オプション</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--force</span></code></p></td>
<td><p>データが残っていても強制的にアクティブ系のデータをコピーします。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--no-save-datadir</span></code></p></td>
<td><p>アクティブ系とのデータ同期する前のデータディレクトリの退避を行なわず削除します。</p></td>
</tr>
</tbody>
</table>
<p>sync_master.sh は実行したノードに適正なデータが残っていれば、それを用いてアクティブ系とのデータ同期を試みます。
アクティブ系とのデータ同期がとれれば、データをコピーする必要なくスタンバイ系としてクラスタを再開できることになります。
データ同期が確認できない場合は、自動的にアクティブ系からデータコピーを開始して、その後にスタンバイ系としてクラスタを再開することになります。</p>
<p>sync_master.sh に <code class="docutils literal notranslate"><span class="pre">--force</span></code> オプションを付けて実行すると、データが残っていても強制的にアクティブ系のデータをコピーをします。
データ同期の判定が正しく行なわれないような場合に、動作が改善する可能性があります。</p>
<p>sync_master.sh はアクティブ系からデータコピーを開始する前に既存のデータベースクラスタを退避します。
具体的にはデータディレクトリ、例えば <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/&lt;pgver&gt;/data</span></code> を <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/&lt;pgver&gt;/data.old</span></code> という名前に変更します。
データコピーに成功すると退避していた <code class="docutils literal notranslate"><span class="pre">data.old</span></code> は自動的に削除されます。
データコピーに失敗した場合は、退避した <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/&lt;pgver&gt;/data.old</span></code> は元の名前 <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/&lt;pgver&gt;/data</span></code> に戻されます。</p>
<p>このような処理のため、データコピー中は退避データと同期データを合わせた容量が必要になることに注意してください。
sync_master.sh を <code class="docutils literal notranslate"><span class="pre">--no-save-datadir</span></code> オプションを付けて実行すると、この退避を行なわずに削除してからデータ同期を開始するため、必要な空き容量を削減することができます。
ただし、同期失敗時に元に戻すことができなくなるので注意してください。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">バージョン 1.6.10 で変更: </span>--force および --no-save-datadir オプションが追加されました。</p>
</div>
</section>
</section>
<section id="audit">
<span id="id61"></span><h2><span class="section-number">1.10. </span>監査ログ管理<a class="headerlink" href="#audit" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id62">
<h3><span class="section-number">1.10.1. </span>はじめに<a class="headerlink" href="#id62" title="この見出しへのパーマリンク">¶</a></h3>
<p>ユーザが Kompira に対して各種操作をしたときに、その操作の種類や、認可されたかどうか、また成功したかどうか、といった情報をログに記録します。</p>
<section id="id63">
<h4><span class="section-number">1.10.1.1. </span>監査ログの対象となる操作<a class="headerlink" href="#id63" title="この見出しへのパーマリンク">¶</a></h4>
<p>ブラウザでの操作や API を用いた連携操作、サーバ上の管理コマンドによる操作などが監査ログの記録対象となります。</p>
<p>一方で、以下については、監査ログの記録対象となりません。</p>
<ul class="simple">
<li><p>ジョブフロー動作によるデータ操作やプロセス操作</p></li>
<li><p>Kompira システム外部での操作（DB管理コマンドを用いた直接的なデータ操作など）</p></li>
<li><p>static コンテンツへのアクセス</p></li>
</ul>
</section>
<section id="id64">
<h4><span class="section-number">1.10.1.2. </span>操作レベルと記録レベル<a class="headerlink" href="#id64" title="この見出しへのパーマリンク">¶</a></h4>
<p>ある記録対象の操作が監査ログに実際に記録されるかどうかは、その操作の種類や結果から算出される「操作レベル値」と、設定項目である「記録レベル値」によって決まります。算出された操作レベル値が設定項目の記録レベル値以上のとき、監査ログに当該エントリが出力されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>監査ログの記録条件： 操作レベル値 ≧ 記録レベル値
</pre></div>
</div>
<p>操作レベル値は操作における複数の項目から算出します。いくつかの項目ごとに設定された操作レベルの基準値が決まり、その最大値が最終的な操作レベル値となります。通常この値は 1 から 3 の間の数値となります。各項目の操作レベル基準値のデフォルトについては <a class="reference internal" href="#audit-spec"><span class="std std-ref">監査ログの項目詳細</span></a> を参照してください。</p>
<p>たとえば、「ブラウザ上で既存のジョブフローオブジェクトを編集した（許可され、成功した）」という場合、以下のような項目ごとの操作レベル基準値が適用されて、最終的な操作レベル値は 2 となります。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>値</p></th>
<th class="head"><p>操作レベル(基準値)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">interface</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;web&quot;</span></code></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">class</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;object&quot;</span></code></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">type</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;update&quot;</span></code></p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">permit</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;allowed&quot;</span></code></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">result</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;succeeded&quot;</span></code></p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>記録レベル値のデフォルトは 2 です。詳細については <a class="reference internal" href="#audit-config"><span class="std std-ref">設定ファイル</span></a> を参照してください。</p>
</section>
</section>
<section id="audit-logfile">
<span id="id65"></span><h3><span class="section-number">1.10.2. </span>監査ログファイル<a class="headerlink" href="#audit-logfile" title="この見出しへのパーマリンク">¶</a></h3>
<section id="id66">
<h4><span class="section-number">1.10.2.1. </span>監査ログの記録先<a class="headerlink" href="#id66" title="この見出しへのパーマリンク">¶</a></h4>
<p>監査ログファイルは以下のディレクトリに作成されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/log/kompira/
</pre></div>
</div>
<p>作成されるログファイル名は以下のようになります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>audit-${USERNAME}.log
</pre></div>
</div>
<p>ここで <code class="docutils literal notranslate"><span class="pre">${USERNAME}</span></code> の部分は、その操作を処理したプロセスを実行したOS上のユーザ名となります。たとえばブラウザで操作を行った場合、サーバ上の Apache サービスが実際の処理をしており、<code class="docutils literal notranslate"><span class="pre">{$USERNAME}</span></code> 部分は <code class="docutils literal notranslate"><span class="pre">apache</span></code> となります。ブラウザ上で Kompira にログインしているユーザ名とは異なることに注意してください。</p>
<p>監査ログファイルは Kompira 自身によるローテートは行わず、OS 標準のサービスによりローテートされるようにインストール時に設定されます。</p>
<p>監査ログファイルは作成時に umask 値として <code class="docutils literal notranslate"><span class="pre">027</span></code> が適用されます。ログファイルの所有者は <code class="docutils literal notranslate"><span class="pre">${USERNAME}</span></code> と同じになり、グループには書き込み権限がマスクされ、他ユーザには全アクセス権限がマスクされます。</p>
</section>
<section id="id67">
<h4><span class="section-number">1.10.2.2. </span>監査ログのファイル形式<a class="headerlink" href="#id67" title="この見出しへのパーマリンク">¶</a></h4>
<p>監査ログは UTF-8 でエンコードされたテキストファイルで、1エントリを1行の JSON 形式で出力します。</p>
</section>
<section id="id68">
<h4><span class="section-number">1.10.2.3. </span>監査ログの記録項目<a class="headerlink" href="#id68" title="この見出しへのパーマリンク">¶</a></h4>
<p>監査ログの1エントリに記録される項目を以下に示します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>名称</p></th>
<th class="head"><p>形式</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>操作レベル</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level</span></code></p></td>
<td><p>整数</p></td>
<td><p>操作レベル値</p></td>
</tr>
<tr class="row-odd"><td><p>操作開始日時</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">started</span></code></p></td>
<td><p>日時</p></td>
<td><p>操作を開始した日時</p></td>
</tr>
<tr class="row-even"><td><p>操作終了日時</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">finished</span></code></p></td>
<td><p>日時</p></td>
<td><p>操作が終了した日時</p></td>
</tr>
<tr class="row-odd"><td><p>操作元情報</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exec</span></code></p></td>
<td><p>辞書</p></td>
<td><p>操作元 Linux プロセスの情報（辞書形式）</p></td>
</tr>
<tr class="row-even"><td><p>操作ユーザ</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">user</span></code></p></td>
<td><p>文字列</p></td>
<td><p>操作した Kompira ユーザ名</p></td>
</tr>
<tr class="row-odd"><td><p>操作方式</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">interface</span></code></p></td>
<td><p>文字列</p></td>
<td><p>ブラウザによる操作か管理コマンドによる操作かなどの区別</p></td>
</tr>
<tr class="row-even"><td><p>操作分類</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">class</span></code></p></td>
<td><p>文字列</p></td>
<td><p>セッション操作やオブジェクト操作などの区分</p></td>
</tr>
<tr class="row-odd"><td><p>操作対象</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">target_path</span></code></p></td>
<td><p>文字列</p></td>
<td><p>オブジェクトパス（セッション操作以外の時）</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">target_type</span></code></p></td>
<td><p>文字列</p></td>
<td><p>型オブジェクト（オブジェクト操作時）</p></td>
</tr>
<tr class="row-odd"><td><p>操作種別</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">type</span></code></p></td>
<td><p>文字列</p></td>
<td><p>「参照」や「削除」など操作の種類を示す区分</p></td>
</tr>
<tr class="row-even"><td><p>操作認否</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">permit</span></code></p></td>
<td><p>文字列</p></td>
<td><p>操作が「許可」または「拒否」されたかを示す区分</p></td>
</tr>
<tr class="row-odd"><td><p>操作成否</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">result</span></code></p></td>
<td><p>文字列</p></td>
<td><p>操作が「成功」または「失敗」したかの記録</p></td>
</tr>
<tr class="row-even"><td><p>結果理由</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">reason</span></code></p></td>
<td><p>文字列</p></td>
<td><p>失敗の場合の原因（原因が分かる場合）</p></td>
</tr>
<tr class="row-odd"><td><p>詳細情報</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">detail</span></code></p></td>
<td><p>辞書</p></td>
<td><p>操作に関する詳細情報（操作ごとに異なる辞書形式）</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id69">
<h4><span class="section-number">1.10.2.4. </span>監査ログのサンプル<a class="headerlink" href="#id69" title="この見出しへのパーマリンク">¶</a></h4>
<p>以下にブラウザで操作したときの監査ログファイル <code class="docutils literal notranslate"><span class="pre">/var/log/kompira/audit-apache.log</span></code> のサンプルを示します。ログは1エントリ1行で出力されていますが、ここでは分かりやすく整形して表示しています。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
  &quot;level&quot;: 3,
  &quot;started&quot;: &quot;2021-10-05T15:51:31.403016+09:00&quot;,
  &quot;finished&quot;: &quot;2021-10-05T15:51:31.452097+09:00&quot;,
  &quot;exec&quot;: {
    &quot;pid&quot;: 1286192,
    &quot;name&quot;: &quot;/usr/sbin/httpd&quot;,
    &quot;user&quot;: &quot;apache&quot;,
    &quot;remote&quot;: &quot;10.10.0.110&quot;
  },
  &quot;user&quot;: &quot;root&quot;,
  &quot;interface&quot;: &quot;web&quot;,
  &quot;class&quot;: &quot;session&quot;,
  &quot;target_path&quot;: null,
  &quot;target_type&quot;: null,
  &quot;type&quot;: &quot;login&quot;,
  &quot;permit&quot;: &quot;allowed&quot;,
  &quot;result&quot;: &quot;succeeded&quot;,
  &quot;reason&quot;: null,
  &quot;detail&quot;: {
    &quot;next_page&quot;: &quot;/&quot;
  }
}
{
  &quot;level&quot;: 2,
  &quot;started&quot;: &quot;2021-10-05T15:51:43.447941+09:00&quot;,
  &quot;finished&quot;: &quot;2021-10-05T15:51:43.486984+09:00&quot;,
  &quot;exec&quot;: {
    &quot;pid&quot;: 1285426,
    &quot;name&quot;: &quot;/usr/sbin/httpd&quot;,
    &quot;user&quot;: &quot;apache&quot;,
    &quot;remote&quot;: &quot;10.10.0.110&quot;
  },
  &quot;user&quot;: &quot;root&quot;,
  &quot;interface&quot;: &quot;web&quot;,
  &quot;class&quot;: &quot;object&quot;,
  &quot;target_path&quot;: &quot;/config/license&quot;,
  &quot;target_type&quot;: &quot;/system/types/License&quot;,
  &quot;type&quot;: &quot;read&quot;,
  &quot;permit&quot;: &quot;allowed&quot;,
  &quot;result&quot;: &quot;succeeded&quot;,
  &quot;reason&quot;: null,
  &quot;detail&quot;: {
    &quot;http_method&quot;: &quot;GET&quot;,
    &quot;http_status&quot;: 200
  }
}
</pre></div>
</div>
</section>
</section>
<section id="audit-spec">
<span id="id70"></span><h3><span class="section-number">1.10.3. </span>監査ログの項目詳細<a class="headerlink" href="#audit-spec" title="この見出しへのパーマリンク">¶</a></h3>
<p>監査ログに記録される項目についての詳細を示します。
以下の節におけるテーブルで「操作レベル」は、操作レベル基準値のデフォルトを示しています。</p>
<section id="level">
<h4><span class="section-number">1.10.3.1. </span>操作レベル (level)<a class="headerlink" href="#level" title="この見出しへのパーマリンク">¶</a></h4>
<p>操作の内容や結果によって算出された操作レベルを数値で示します。この操作レベル値が設定項目の記録レベル値以上のとき、監査ログに当該エントリが出力されます。</p>
</section>
<section id="started-finished">
<h4><span class="section-number">1.10.3.2. </span>操作日時 (started, finished)<a class="headerlink" href="#started-finished" title="この見出しへのパーマリンク">¶</a></h4>
<p>項目 <code class="docutils literal notranslate"><span class="pre">started</span></code> は操作の開始日時を、項目 <code class="docutils literal notranslate"><span class="pre">finished</span></code> は操作の終了日時を示します。
これらは以下のように、ローカルタイムで ISO8601 形式で記録されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;2021-10-01T11:45:08.977356+09:00&quot;
</pre></div>
</div>
</section>
<section id="exec">
<h4><span class="section-number">1.10.3.3. </span>操作元情報 (exec)<a class="headerlink" href="#exec" title="この見出しへのパーマリンク">¶</a></h4>
<p>操作元を示す辞書には以下のような情報が記録されます。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>名称</p></th>
<th class="head"><p>形式</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>操作元プロセスID</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exec[&quot;pid&quot;]</span></code></p></td>
<td><p>整数</p></td>
<td><p>Kompiraサーバ上の処理プロセスID</p></td>
</tr>
<tr class="row-odd"><td><p>操作元プロセス名</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exec[&quot;name&quot;]</span></code></p></td>
<td><p>文字列</p></td>
<td><p>Kompiraサーバ上の処理プロセス名</p></td>
</tr>
<tr class="row-even"><td><p>操作元ユーザ名</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exec[&quot;user&quot;]</span></code></p></td>
<td><p>文字列</p></td>
<td><p>Kompiraサーバ上の処理プロセスの実行ユーザ名</p></td>
</tr>
<tr class="row-odd"><td><p>操作元アドレス</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exec[&quot;remote&quot;]</span></code></p></td>
<td><p>文字列</p></td>
<td><p>操作元のIPアドレス（ブラウザ操作の場合）</p></td>
</tr>
</tbody>
</table>
</section>
<section id="user">
<h4><span class="section-number">1.10.3.4. </span>操作ユーザ (user)<a class="headerlink" href="#user" title="この見出しへのパーマリンク">¶</a></h4>
<p>操作を行った Kompira ユーザ名を記録します。ブラウザ上で Kompira にログインして操作をした場合は、そのログインユーザ名となります。サーバのコンソール上で管理コマンドによる操作を行なった場合などでは、Kompira の認証を伴っていないため空文字列になります。</p>
</section>
<section id="interface">
<h4><span class="section-number">1.10.3.5. </span>操作方式 (interface)<a class="headerlink" href="#interface" title="この見出しへのパーマリンク">¶</a></h4>
<p>どのような方式を用いて操作したのかの区分を記録します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>値</p></th>
<th class="head"><p>操作レベル</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;web&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>Webブラウザによる操作</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;api&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>REST-API による操作</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;mng&quot;</span></code></p></td>
<td><p>2</p></td>
<td><p>管理コマンド（manage.py など）による操作</p></td>
</tr>
</tbody>
</table>
</section>
<section id="class">
<h4><span class="section-number">1.10.3.6. </span>操作分類 (class)<a class="headerlink" href="#class" title="この見出しへのパーマリンク">¶</a></h4>
<p>何を操作したのか、その分類を示します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>値</p></th>
<th class="head"><p>操作レベル</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;session&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>セッション操作（ログイン・ログアウト）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;user&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>ユーザ情報操作（ユーザ追加・削除、パスワード変更など）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;group&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>グループ情報操作</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;object&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>オブジェクト操作</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;task&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>タスク操作</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;incident&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>インシデント操作</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;process&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>プロセス操作</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;schedule&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>スケジュール操作</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;packages&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>システムパッケージ情報操作</p></td>
</tr>
</tbody>
</table>
</section>
<section id="target-path-target-type">
<h4><span class="section-number">1.10.3.7. </span>操作対象 (target_path, target_type)<a class="headerlink" href="#target-path-target-type" title="この見出しへのパーマリンク">¶</a></h4>
<p>何を操作したのか、その具体的な対象を示します。</p>
<p>操作分類が <code class="docutils literal notranslate"><span class="pre">session</span></code> 以外のときは、操作対象をそのパスで識別することができます。以下のようにパスを項目 <code class="docutils literal notranslate"><span class="pre">target_path</span></code> として記録します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;/system/user/id_1&quot;
</pre></div>
</div>
<p>さらに、オブジェクト操作の場合では、その型オブジェクトのパスを項目 <code class="docutils literal notranslate"><span class="pre">target_type</span></code> に記録します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;/system/types/Directory&quot;
</pre></div>
</div>
</section>
<section id="type">
<h4><span class="section-number">1.10.3.8. </span>操作種別 (type)<a class="headerlink" href="#type" title="この見出しへのパーマリンク">¶</a></h4>
<p>どのような操作をしたのかという種類を記録します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>値</p></th>
<th class="head"><p>操作レベル</p></th>
<th class="head"><p>操作例</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;login&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>ログイン</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;logout&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>ログアウト</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;create&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>オブジェクトの新規作成</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;rename&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>オブジェクトの名称変更</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;copy&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>オブジェクトのコピー</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;move&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>オブジェクトの移動</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;export&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>エクスポート</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;import&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>インポート</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;execute&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>ジョブフローやスクリプトジョブの実行</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;suspend&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>プロセスの停止</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;resume&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>プロセスの続行</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;terminate&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>プロセスの中止</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;read&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>オブジェクトの参照</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;list&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>オブジェクトの一覧</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;search&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>オブジェクトの検索</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;new&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>新規オブジェクトの編集（作成前）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;edit&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>既存オブジェクトの編集（更新前）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;confirm&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>オブジェクト操作の確認（削除前）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;update&quot;</span></code></p></td>
<td><p>2</p></td>
<td><p>オブジェクトの更新</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;clear&quot;</span></code></p></td>
<td><p>2</p></td>
<td><p>チャネルのメッセージクリアや管理領域のクリア</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;recv&quot;</span></code></p></td>
<td><p>2</p></td>
<td><p>チャネルからのメッセージ受信</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;send&quot;</span></code></p></td>
<td><p>2</p></td>
<td><p>チャネルへのメッセージ送信</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;delete&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>オブジェクトの削除</p></td>
</tr>
</tbody>
</table>
<p>いくつかの操作種別は特定の操作分類でのみ利用されます。たとえばログインやログアウトは操作分類が <code class="docutils literal notranslate"><span class="pre">session</span></code> のときだけです。</p>
<p>ある操作種別が複数の操作分類で利用される場合はありますが、操作分類ごとに異なる操作レベル基準値を設定することはできません。</p>
</section>
<section id="permit-result">
<h4><span class="section-number">1.10.3.9. </span>操作の結果 (permit, result)<a class="headerlink" href="#permit-result" title="この見出しへのパーマリンク">¶</a></h4>
<p>操作の結果としてその認否と成否が記録されます。</p>
<p>項目 <code class="docutils literal notranslate"><span class="pre">permit</span></code> は操作が許可されたかどうかを示します。例えばオブジェクト操作では設定されたパーミッションによって、操作が許可されたり拒否されたりします。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>値</p></th>
<th class="head"><p>操作レベル</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;allowed&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>操作が許可された</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;denied&quot;</span></code></p></td>
<td><p>3</p></td>
<td><p>操作が拒否された</p></td>
</tr>
</tbody>
</table>
<p>項目 <code class="docutils literal notranslate"><span class="pre">result</span></code> は操作に成功したかどうかを示します。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>値</p></th>
<th class="head"><p>操作レベル</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;succeeded&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>操作に成功した</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;failed&quot;</span></code></p></td>
<td><p>1</p></td>
<td><p>操作に失敗した</p></td>
</tr>
</tbody>
</table>
</section>
<section id="detail">
<h4><span class="section-number">1.10.3.10. </span>詳細情報 (detail)<a class="headerlink" href="#detail" title="この見出しへのパーマリンク">¶</a></h4>
<p>操作ごとに追加の詳細情報を辞書形式で記録します。</p>
<p>※ 詳細情報については、監査ログ機能がリリースされた後も仕様が調整される可能性がありますのでご注意ください。</p>
<p><strong>ログイン</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">next_page</span></code></p></td>
<td><p>ログイン後に遷移するページ</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">invalid_password</span></code></p></td>
<td><p>不正パスワード（認証エラー時）</p></td>
</tr>
</tbody>
</table>
<p><strong>REST-API</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">invalid_token</span></code></p></td>
<td><p>不正APIトークン（認証エラー時）</p></td>
</tr>
</tbody>
</table>
<p><strong>エクスポート</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">export_format</span></code></p></td>
<td><p>エクスポート形式（'json' or 'dir'）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">export_options</span></code></p></td>
<td><p>エクスポート時に指定したオプション</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">export_paths</span></code></p></td>
<td><p>エクスポート対象のパス</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">export_counters</span></code></p></td>
<td><p>エクスポート結果のカウンタ情報</p></td>
</tr>
</tbody>
</table>
<p><strong>インポート</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">import_format</span></code></p></td>
<td><p>インポート形式（'json' or 'dir'）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">import_options</span></code></p></td>
<td><p>インポート時に指定したオプション</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">import_sources</span></code></p></td>
<td><p>インポートしたファイル名</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">import_counters</span></code></p></td>
<td><p>インポート結果のカウンタ情報</p></td>
</tr>
</tbody>
</table>
<p><strong>オブジェクトの検索</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">search_params</span></code></p></td>
<td><p>検索パラメータ</p></td>
</tr>
</tbody>
</table>
<p><strong>オブジェクトの新規作成</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">create_name</span></code></p></td>
<td><p>新規作成するオブジェクトの名称</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">create_type</span></code></p></td>
<td><p>新規作成するオブジェクトの型オブジェクトのパス</p></td>
</tr>
</tbody>
</table>
<p><strong>ジョブフローやスクリプトジョブの実行</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">execute_pid</span></code></p></td>
<td><p>実行したプロセスID</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">execute_params</span></code></p></td>
<td><p>実行時に指定したパラメータ</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">execute_form</span></code></p></td>
<td><p>実行に利用したフォームのパス（フォームから実行した場合）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">execute_table</span></code></p></td>
<td><p>実行に利用したテーブルのパス（テーブルから実行した場合）</p></td>
</tr>
</tbody>
</table>
<p><strong>オブジェクトの名称変更</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rename_to</span></code></p></td>
<td><p>変更する名前</p></td>
</tr>
</tbody>
</table>
<p><strong>オブジェクトのコピー</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">copy_objects</span></code></p></td>
<td><p>コピー元オブジェクトのリスト</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">copy_rename</span></code></p></td>
<td><p>コピー時に指定したオブジェクトの名称</p></td>
</tr>
</tbody>
</table>
<p><strong>オブジェクトの移動</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">move_objects</span></code></p></td>
<td><p>移動元オブジェクトのリスト</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">move_rename</span></code></p></td>
<td><p>移動時に指定したオブジェクトの名称</p></td>
</tr>
</tbody>
</table>
<p><strong>オブジェクトの削除</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">delete_objects</span></code></p></td>
<td><p>削除したパスまたはオブジェクトIDのリスト</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">delete_file</span></code></p></td>
<td><p>削除した添付ファイルのファイル名</p></td>
</tr>
</tbody>
</table>
<p><strong>チャネルへのメッセージ送信</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">send_form</span></code></p></td>
<td><p>送信に利用したフォームのパス（フォームから送信した場合）</p></td>
</tr>
</tbody>
</table>
<p><strong>管理コマンド: compile_jobflow / compile_library</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">compile_paths</span></code></p></td>
<td><p>コンパイル対象として指定したパスのリスト</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">compile_result</span></code></p></td>
<td><p>コンパイル結果（個数情報）</p></td>
</tr>
</tbody>
</table>
<p><strong>管理コマンド: license_info / license_update</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">license_id</span></code></p></td>
<td><p>ライセンスID</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">license_path</span></code></p></td>
<td><p>導入したライセンスファイル名（license_update した場合）</p></td>
</tr>
</tbody>
</table>
<p><strong>管理コマンド: process</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">process_query</span></code></p></td>
<td><p>プロセスオブジェクトの検索クエリ</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">process_count</span></code></p></td>
<td><p>検索されたプロセスの個数</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">process_listed</span></code></p></td>
<td><p>表示したプロセスの個数</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">process_deleted</span></code></p></td>
<td><p>削除したプロセスの個数</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">process_terminated</span></code></p></td>
<td><p>終了させたプロセスの個数</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">process_suspended</span></code></p></td>
<td><p>停止させたプロセスの個数</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">process_resumed</span></code></p></td>
<td><p>続行させたプロセスの個数</p></td>
</tr>
</tbody>
</table>
<p><strong>その他の詳細情報</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>項目</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">http_method</span></code></p></td>
<td><p>HTTP 操作時のメソッド名</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">http_status</span></code></p></td>
<td><p>HTTP 操作時のステータスコード</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">target_attr</span></code></p></td>
<td><p>操作対象の属性名</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">target_index</span></code></p></td>
<td><p>操作対象のインデックス値</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">bulk_deleted</span></code></p></td>
<td><p>一括削除時の詳細情報</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="audit-config">
<span id="id71"></span><h3><span class="section-number">1.10.4. </span>設定ファイル<a class="headerlink" href="#audit-config" title="この見出しへのパーマリンク">¶</a></h3>
<p>監査ログに関する設定を以下のファイルで行うことができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/opt/kompira/kompira_audit.yaml
</pre></div>
</div>
<section id="id72">
<h4><span class="section-number">1.10.4.1. </span>設定ファイルの形式<a class="headerlink" href="#id72" title="この見出しへのパーマリンク">¶</a></h4>
<p>設定ファイルは <code class="docutils literal notranslate"><span class="pre">kompira_audit.yaml</span></code> は YAML 形式で記述します。全体としては辞書構造で、以下の設定項目が必要になります。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>名称</p></th>
<th class="head"><p>形式</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">logging_level</span></code></p></td>
<td><p>整数</p></td>
<td><p>監査ログの記録レベル値</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">operation_levels</span></code></p></td>
<td><p>辞書</p></td>
<td><p>操作ごとの操作レベル基準値テーブル</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">target_levels</span></code></p></td>
<td><p>配列</p></td>
<td><p>オブジェクト操作等における操作対象ごとの操作レベル基準値テーブル</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id73">
<h4><span class="section-number">1.10.4.2. </span>設定ファイルの自動再読み込み<a class="headerlink" href="#id73" title="この見出しへのパーマリンク">¶</a></h4>
<p>監査ログの設定ファイルをサーバー上で更新すると、次の監査ログ記録のタイミングで自動的に再読み込みされます。サービスの再起動などは不要です。</p>
</section>
<section id="id74">
<h4><span class="section-number">1.10.4.3. </span>デフォルトの設定ファイル<a class="headerlink" href="#id74" title="この見出しへのパーマリンク">¶</a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#--------------------------------------------------------------------
# kompira_audit.yaml
#
# Configuration file to control audit log output.
#--------------------------------------------------------------------
#
# logging_level: recording level value
#
# If the calculated operation level value is less than the recording
# level value, no audit log will be recorded.
#
logging_level: 2

#
# operation_levels: basic operation level table
#
# Table of operation level reference values for each operation.
# The operation level value for an operation is the maximum of
# several operation level criteria values.
#
operation_levels:
interface:
    web: 1
    api: 1
    mng: 2
class:
    session: 3
    user: 3
    group: 3
    object: 1
    task: 1
    incident: 1
    process: 1
    schedule: 1
    packages: 1
type:
    login: 3
    logout: 3
    create: 3
    rename: 3
    copy: 3
    move: 3
    export: 3
    import: 3
    execute: 3
    suspend: 3
    resume: 3
    terminate: 3
    read: 1
    list: 1
    search: 1
    edit: 1
    confirm: 1
    update: 2
    clear: 2
    recv: 2
    send: 2
    delete: 3
permit:
    allowed: 1
    denied: 3
result:
    succeeded: 1
    failed: 1

#
# target_levels: operation level table for object operation
#
# Operation level reference value to be applied to each target
# during object manipulation.
#
target_levels:
  - {path: &#39;/config/*&#39;, type: null, level: 2}
  - {path: &#39;/system/*&#39;, type: &#39;/system/types/Config&#39;, level: 2}
</pre></div>
</div>
</section>
</section>
</section>
<section id="system-packages">
<span id="id75"></span><h2><span class="section-number">1.11. </span>システムパッケージ管理<a class="headerlink" href="#system-packages" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompira 環境にインストールされている Python や Web 用のパッケージの情報が以下で閲覧できます。
各パッケージ種別ごとにインストールされているパッケージのバージョンやライセンスに関する情報を確認することができます。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>パス</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/system/packages/PIP</span></code></p></td>
<td><p>Kompira 環境で PIP で管理されている Python パッケージ情報</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/system/packages/Web</span></code></p></td>
<td><p>Kompira 環境で static コンテンツとして管理されている Web 用パッケージ情報</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>システムパッケージ情報は Kompira をインストールまたはアップデートした後に kompirad が起動したタイミングで自動的に収集および更新されます。</p>
</div>
<section id="id76">
<h3><span class="section-number">1.11.1. </span>パッケージ情報の管理コマンド<a class="headerlink" href="#id76" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompira サーバ上で以下のコマンドを利用することでパッケージ情報を管理することができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py packages_info [options...]
</pre></div>
</div>
<section id="id77">
<h4><span class="section-number">1.11.1.1. </span>パッケージ情報の表示<a class="headerlink" href="#id77" title="この見出しへのパーマリンク">¶</a></h4>
<p>オプションを省略または <code class="docutils literal notranslate"><span class="pre">--show</span></code> オプションを指定した場合、すでに収集されているパッケージ情報をコンソールに一覧表示します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py packages_info --show
</pre></div>
</div>
<p>パッケージ情報の一覧表示の例を以下に示します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------+----------------------+-----------+----------+-----------------+
| Type | Name                 | Installed | Latest   | License         |
+------+----------------------+-----------+----------+-----------------+
| pip  | APScheduler          | 3.6.3     | 3.8.1    | MIT License     |
| pip  | Creoleparser         | 0.7.5     | None     | MIT License     |
| pip  | Django               | 3.0.5     | 3.2.8    | BSD License     |
| pip  | Genshi               | 0.7.5     | None     | BSD License     |
| pip  | GitPython            | 3.1.18    | None     | BSD License     |
   :         :                    :           :            :
</pre></div>
</div>
</section>
<section id="id78">
<h4><span class="section-number">1.11.1.2. </span>パッケージ情報の収集<a class="headerlink" href="#id78" title="この見出しへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">--collect</span></code> オプションを指定した場合、インストールされているパッケージ情報を収集します。
ただし、Kompira サーバ上の <code class="docutils literal notranslate"><span class="pre">root</span></code> または <code class="docutils literal notranslate"><span class="pre">kompira</span></code> ユーザのみが実行できます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py packages_info --collect
</pre></div>
</div>
<p>このとき、各パッケージの最新バージョン情報を収集するためにインターネット接続が必要になります。
プロキシ接続が必要な場合は <code class="docutils literal notranslate"><span class="pre">--proxy</span></code> オプション（または <code class="docutils literal notranslate"><span class="pre">https_proxy</span></code> 環境変数）で指定してください。</p>
<p>インターネットに接続できないなど、最新バージョン情報の収集を行わない場合は <code class="docutils literal notranslate"><span class="pre">--no-collect-latest</span></code> オプションを追加で指定してください。
あるいは、明示的に最新バージョン情報の収集を行なうことを指定したい場合は <code class="docutils literal notranslate"><span class="pre">--collect-latest</span></code> オプションを追加で指定してください。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>なお、収集されたパッケージ情報はサーバ上の <code class="docutils literal notranslate"><span class="pre">/var/opt/kompira/packages/</span></code> 配下に保存されます。</p>
</div>
</section>
<section id="id79">
<h4><span class="section-number">1.11.1.3. </span>パッケージ情報の更新<a class="headerlink" href="#id79" title="この見出しへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">--update</span></code> オプションを指定した場合、収集済みパッケージ情報をもとに Kompira 上のシステムパッケージ情報オブジェクト（Wiki 型）を更新します。
ただし、Kompira サーバ上の <code class="docutils literal notranslate"><span class="pre">root</span></code> または <code class="docutils literal notranslate"><span class="pre">kompira</span></code> ユーザのみが実行できます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ /opt/kompira/bin/manage.py packages_info --update
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">--update</span></code> オプションと <code class="docutils literal notranslate"><span class="pre">--collect</span></code> オプションを併用した場合は、パッケージ情報の収集に続けてシステムパッケージ情報オブジェクトの更新を行ないます。</p>
</section>
</section>
</section>
<section id="ssl">
<span id="ssl-certs"></span><h2><span class="section-number">1.12. </span>SSL 証明書管理<a class="headerlink" href="#ssl" title="この見出しへのパーマリンク">¶</a></h2>
<p>Kompira では SSL 接続のために次の証明書を利用します。</p>
<ul class="simple">
<li><p>以下の SSL 証明書に署名するための CA 証明書</p></li>
<li><p>AMQPS 接続用のサーバ証明書 (rabbitmq-server が利用します)</p></li>
<li><p>AMQPS 接続用のクライアント証明書 (kompira_jobmngrd, kompira_sendevt が利用します)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>この節の説明は Kompira サーバを SSL 証明書による検証を行なうように構成した場合のためにあります。
たとえばインストール時に install.sh に --amqps-verify オプションを付けた場合などが該当します。
SSL 証明書の検証が有効になっていない場合は、この節の説明で登場する「SSL 証明書の検証」は行なわれません。</p>
</div>
<section id="id80">
<h3><span class="section-number">1.12.1. </span>証明書ファイルの配置<a class="headerlink" href="#id80" title="この見出しへのパーマリンク">¶</a></h3>
<p>Kompira が利用する SSL 証明書は以下のディレクトリに配置します。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>パス</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/opt/kompira/ssl/ca-source/</span></code></p></td>
<td><p>SSL 証明書に署名するための CA 証明書ファイルを配置するディレクトリ</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/opt/kompira/ssl/certs/</span></code></p></td>
<td><p>SSL 接続で用いる SSL 証明書ファイル、SSL 証明書の検証に用いる CA 証明書ファイルを配置するディレクトリ</p></td>
</tr>
</tbody>
</table>
<p>これらのディレクトリに配置する証明書ファイルについて以下で説明します。
なお、各証明書ファイルには拡張子が .csr および .key となる、CSR ファイルと秘密鍵ファイルも同じ場所に配置されています。</p>
</section>
<section id="opt-kompira-ssl-ca-source">
<h3><span class="section-number">1.12.2. </span>/opt/kompira/ssl/ca-source/<a class="headerlink" href="#opt-kompira-ssl-ca-source" title="この見出しへのパーマリンク">¶</a></h3>
<p>SSL 証明書に署名するための CA 証明書ファイルを <code class="docutils literal notranslate"><span class="pre">/opt/kompira/ssl/ca-source/</span></code> に配置します。</p>
<section id="kompira-local-ca-crt">
<h4><span class="section-number">1.12.2.1. </span>kompira-local-ca.crt<a class="headerlink" href="#kompira-local-ca-crt" title="この見出しへのパーマリンク">¶</a></h4>
<p>この Kompira サーバで作成した SSL 証明書に署名する CA 証明書です。</p>
<p>この CA 証明書は Kompira をインストールした時に自動的に作成されます。</p>
</section>
<section id="kompira-other-ca-crt">
<h4><span class="section-number">1.12.2.2. </span>kompira-other-ca.crt<a class="headerlink" href="#kompira-other-ca-crt" title="この見出しへのパーマリンク">¶</a></h4>
<p>冗長構成において対向 Kompira サーバの kompira-local-ca.crt をコピーしたものです。
後述の <code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">get-other-ca</span></code> コマンドで対向 Kompira サーバから scp でコピーするか、別の手段を用いてコピーしてください。</p>
<p>Kompira はこの CA 証明書を直接利用することはなく、後述する CA 証明書をまとめた kompira-bundle-ca.crt を利用して SSL の検証を行ないます。</p>
</section>
</section>
<section id="opt-kompira-ssl-certs">
<h3><span class="section-number">1.12.3. </span>/opt/kompira/ssl/certs/<a class="headerlink" href="#opt-kompira-ssl-certs" title="この見出しへのパーマリンク">¶</a></h3>
<p>SSL 接続で用いる SSL 証明書ファイルおよび検証に用いる CA 証明書ファイルを <code class="docutils literal notranslate"><span class="pre">/opt/kompira/ssl/certs/</span></code> に配置します。</p>
<section id="kompira-bundle-ca-crt">
<h4><span class="section-number">1.12.3.1. </span>kompira-bundle-ca.crt<a class="headerlink" href="#kompira-bundle-ca-crt" title="この見出しへのパーマリンク">¶</a></h4>
<p>/opt/kompira/ssl/ca-source/ に配置された CA 証明書を1つにまとめたファイルです。
通常は自動的に作成されますが、後述する <code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">update-bundle-ca</span></code> コマンドで更新することもできます。</p>
<p>Kompira サーバ上の rabbitmq-server は、この CA 証明書をクライアント SSL 証明書の検証に用いるように設定されます。
すなわち、これに含まれるいずれかの CA 証明書によって署名された SSL 証明書を持ったクライアントだけが SSL 接続できるようになります。
他の Kompira サーバが生成した CA 証明書によって署名された SSL 証明書を持つクライアントは、この Kompira サーバには SSL 接続できないことに注意してください。</p>
<p>kompira_jobmngrd および kompira_sendevt は、この CA 証明書をサーバ SSL 証明書の検証に用いるように設定されます (kompira.conf で指定することもできます)。
すなわち、これに含まれるいずれかの CA 証明書によって署名された SSL 証明書を持ったサーバにのみ SSL 接続できるようになります。
単独で kompira_jobmngrd または kompira_sendevt をインストールしたノードでは、この CA 証明書を事前にコピーする必要があることに注意してください。
手順については <code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">client-setup</span></code> コマンドを参考にしてください。</p>
<p>kompira-bundle-ca.crt は、Kompira をインストールした時点ではそのサーバの kompira-local-ca.crt のみを含んでいます。</p>
<p>冗長構成をセットアップしたときは、2台のサーバで相互に対向の kompira-local-ca.crt を取得して kompira-bundle-ca.crt を更新しておくことを推奨します。
それにより、いずれかの CA 証明書で署名された SSL 証明書を持つクライアントが、どちらのサーバにも SSL 接続できるようになります。
たとえば、VIP アドレスに対して kompira_sendevt でイベントを送信する場合、実際にどちらのサーバに接続するかは事前に分からないため、2つの CA 証明書をまとめた kompira-bundle-ca.crt をクライアント側で持っておく必要があることに注意してください。
詳細については <a class="reference internal" href="#ssl-certs-admin-ca-in-cluster"><span class="std std-ref">冗長構成での CA 証明書管理</span></a> を参考にしてください。</p>
</section>
<section id="amqp-server-crt">
<h4><span class="section-number">1.12.3.2. </span>amqp-server.crt<a class="headerlink" href="#amqp-server-crt" title="この見出しへのパーマリンク">¶</a></h4>
<p>AMQP サーバ側 (rabbitmq-server) が利用する SSL 証明書です。
kompira-local-ca.crt によって署名されています。
この証明書は Kompira をインストールした時に自動的に作成されます。</p>
</section>
<section id="amqp-client-kompira-crt">
<h4><span class="section-number">1.12.3.3. </span>amqp-client-kompira.crt<a class="headerlink" href="#amqp-client-kompira-crt" title="この見出しへのパーマリンク">¶</a></h4>
<p>AMQP クライアント側 (kompira_jobmngrd, kompira_sendevt) が利用する SSL 証明書です。
kompira-local-ca.crt によって署名されています。
この証明書は Kompira をインストールした時に自動的に作成されます。</p>
<p>単独で kompira_jobmngrd または kompira_sendevt をインストールしたノードでは、この SSL 証明書を事前にコピーする必要があることに注意してください。
手順については <code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">client-setup</span></code> コマンドを参考にしてください。</p>
</section>
</section>
<section id="id81">
<h3><span class="section-number">1.12.4. </span>SSL 証明書管理スクリプト<a class="headerlink" href="#id81" title="この見出しへのパーマリンク">¶</a></h3>
<p>ssl_utils.sh スクリプトを用いることで、SSL 証明書作成などの管理を行なうことができます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh command [options]
</pre></div>
</div>
<p>ssl_utils.sh スクリプトは root 権限で実行する必要があります。</p>
<section id="id82">
<h4><span class="section-number">1.12.4.1. </span>サーバ側 SSL 環境のセットアップ<a class="headerlink" href="#id82" title="この見出しへのパーマリンク">¶</a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh server-setup
</pre></div>
</div>
<p>Kompira サーバ上で利用する CA 証明書および SSL 証明書を作成します。
内部的には以下の処理を行なっています。</p>
<ul class="simple">
<li><p>ローカルCA証明書の作成</p></li>
<li><p>バンドルCA証明書の更新</p></li>
<li><p>SSL証明書の作成 (AMQPサーバ用)</p></li>
<li><p>SSL証明書の作成 (AMQPクライアント用)</p></li>
</ul>
<p>すべての証明書は有効期限 10000 日で作成されます。</p>
<p>この処理は intall.sh で Kompira をインストールするときに自動的に実行されるため、通常は利用することはありません。</p>
</section>
<section id="id83">
<h4><span class="section-number">1.12.4.2. </span>クライアント側 SSL 環境のセットアップ<a class="headerlink" href="#id83" title="この見出しへのパーマリンク">¶</a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh client-setup kompira-server
</pre></div>
</div>
<p>Kompira サーバとは別のノードにインストールした kompira_jobmngrd または kompira_sendevt が SSL 接続するには、Kompira サーバから CA 証明書および SSL 証明書を取得しておく必要があります。
このコマンドはコマンドライン引数 kompira-server で指定した Kompira サーバから scp コマンドを用いて必要な証明書を取得します。
install.sh に --jobmngr または --sendevt オプションを付けたときは自動的に実行されますので、通常は利用することはありません。</p>
<p>このコマンドを実行すると、内部で scp コマンドを用いてファイル転送するため、Kompira サーバの root アカウントのパスワードを入力する必要があります。
以下のような表示がありますので、パスワードを入力してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: Start copying the SSL/CA certificates from the kompira server with scp.
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: PLEASE ENTER THE PASSWORD OF THE REMOTE KOMPIRA SERVER (&lt;kompira-server&gt;) FOR SCP.
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] VERBOSE: run: scp -q -p -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@&lt;kompira-server&gt;:/opt/kompira/ssl/certs/{kompira-bundle-ca.crt,amqp-client-kompira{.crt,.key}} /opt/kompira/ssl/certs/
root@&lt;kompira-server&gt;&#39;s password:
</pre></div>
</div>
<p>何らかの理由で scp コマンドでファイル転送ができない場合は、他の実施可能な手段で Kompira サーバ上の以下のファイルを同じディレクトリにコピーしてください。</p>
<ul class="simple">
<li><p>/opt/kompira/ssl/certs/kompira-bundle-ca.crt</p></li>
<li><p>/opt/kompira/ssl/certs/amqp-client-kompira.crt</p></li>
<li><p>/opt/kompira/ssl/certs/amqp-client-kompira.key</p></li>
</ul>
<p>手動でコピーした場合はこれらのファイルのグループを kompira に設定して kompira_jobmngrd からアクセスできるようにしてください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># chown :kompira /opt/kompira/ssl/certs/*
</pre></div>
</div>
<p>また、kompira_sendevt を SSL 接続で利用する場合は、実行するユーザがこれらのファイルにアクセスできる必要があることにも注意してください。
必要に応じて実行ユーザを調整するか、これらのファイルのパーミッションを調整してください。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>Windows 環境に kompira_sendevt をインストールした場合は、Kompira サーバから取得した証明書ファイルを <code class="docutils literal notranslate"><span class="pre">C:\Kompira\SSL\Certs</span></code> ディレクトリに配置してください。詳細は <a class="reference internal" href="#package-sendevt-install-windows"><span class="std std-ref">Windowsへのインストール</span></a> を参照してください。</p>
</div>
</section>
<section id="ca">
<h4><span class="section-number">1.12.4.3. </span>CA 証明書の管理<a class="headerlink" href="#ca" title="この見出しへのパーマリンク">¶</a></h4>
<p><strong>バンドルCA証明書の更新</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh update-bundle-ca
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/opt/kompira/ssl/ca-source/</span></code> に配置された CA 証明書を、一つの CA 証明書 kompira-bundle-ca.crt としてまとめます。
<code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">server-setup</span></code> または <code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">get-other-ca</span></code> コマンドを実行したときは内部で処理されますので、通常は利用することはありません。</p>
<p><strong>ローカルCA証明書の作成</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh create-local-ca
</pre></div>
</div>
<p>ローカルCA証明書 kompira-local-ca.crt を作成します。
ディレクトリ /opt/kompira/ssl/ca-source/ に以下のファイルが作成されます。</p>
<ul class="simple">
<li><p>kompira-local-ca.key : 秘密鍵ファイル (RSA-key 2048 bit)</p></li>
<li><p>kompira-local-ca.crt : CA 証明書ファイル</p></li>
</ul>
<p>CA 証明書の有効期限は 10000 日となります。</p>
<p><code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">server-setup</span></code> コマンドを実行したときは内部で処理されますので、通常は利用することはありません。</p>
</section>
<section id="ssl-certs-admin-ca-in-cluster">
<span id="id84"></span><h4><span class="section-number">1.12.4.4. </span>冗長構成での CA 証明書管理<a class="headerlink" href="#ssl-certs-admin-ca-in-cluster" title="この見出しへのパーマリンク">¶</a></h4>
<p><strong>他ノードのCA証明書の取得(scp)</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh get-other-ca [other-server]
</pre></div>
</div>
<p>コマンドライン引数 other-server で指定した Kompira サーバから CA 証明書 kompira-local-ca.crt を取得します。
取得した CA 証明書を kompira-other-ca.crt として保存したのち、バンドルCA証明書を更新します。</p>
<p>このコマンドを実行すると、内部で scp コマンドを用いてファイル転送するため、Kompira サーバの root アカウントのパスワードを入力する必要があります。
以下のような表示がありますので、パスワードを入力してください。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: Start copying the SSL/CA certificates from the other kompira server with scp..
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: PLEASE ENTER THE PASSWORD OF THE OTHER KOMPIRA SERVER (&lt;other-server&gt;) FOR SCP..
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] INFO: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[2023-01-16 18:34:12] INFO:
[2023-01-16 18:34:12] VERBOSE: run: scp -q -p -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@&lt;other-server&gt;:/opt/kompira/ssl/ca-source/kompira-local-ca.crt /opt/kompira/ssl/ca-source/kompira-other-ca.crt
root@&lt;other-server&gt;&#39;s password:
</pre></div>
</div>
<p>何らかの理由で scp コマンドでファイル転送ができない場合は、他の実施可能な手段で対向 Kompira サーバ上の /opt/kompira/ssl/ca-source/kompira-local-ca.crt を自サーバの /opt/kompira/ssl/ca-source/kompira-other-ca.crt としてコピーしてください。その後 <code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">update-bundle-ca</span></code> コマンドでバンドルCA証明書を更新してください。</p>
</section>
<section id="id85">
<h4><span class="section-number">1.12.4.5. </span>SSL証明書の作成<a class="headerlink" href="#id85" title="この見出しへのパーマリンク">¶</a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /opt/kompira/bin/ssl_utils.sh create-cert certname subject
</pre></div>
</div>
<p>新しい SSL 証明書を作成します。
オプション certname で指定した名前をもとに、ディレクトリ /opt/kompira/ssl/certs/ に以下のファイルが作成されます。</p>
<ul class="simple">
<li><p>&lt;certname&gt;.key : 秘密鍵ファイル (RSA-key 2048 bit)</p></li>
<li><p>&lt;certname&gt;.csr : CSRファイル</p></li>
<li><p>&lt;certname&gt;.crt : SSL 証明書ファイル</p></li>
</ul>
<p>証明書のサブジェクトにはオプション subject で指定した値が設定され、また有効期限は 10000 日となります。
SSL 証明書ファイルは kompira-local-ca.crt で署名されています。</p>
<p><code class="docutils literal notranslate"><span class="pre">ssl_utils.sh</span> <span class="pre">server-setup</span></code> コマンドを実行したときに、AMQP サーバ用および AMQP クライアント用の証明書は自動的に作成されます。</p>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">1. 管理ガイド</a><ul>
<li><a class="reference internal" href="#admin-introduction">1.1. はじめに</a></li>
<li><a class="reference internal" href="#kompira">1.2. Kompiraパッケージ管理</a><ul>
<li><a class="reference internal" href="#package-kind">1.2.1. インストールパッケージの種類</a></li>
<li><a class="reference internal" href="#package-install-sh">1.2.2. インストールスクリプト</a><ul>
<li><a class="reference internal" href="#id5">1.2.2.1. 制限</a></li>
<li><a class="reference internal" href="#id6">1.2.2.2. コマンドラインオプション</a></li>
</ul>
</li>
<li><a class="reference internal" href="#package-kompira">1.2.3. Kompiraパッケージ</a><ul>
<li><a class="reference internal" href="#package-kompira-install">1.2.3.1. インストール</a></li>
<li><a class="reference internal" href="#package-kompira-update">1.2.3.2. アップデート</a></li>
<li><a class="reference internal" href="#postgresql">1.2.3.3. PostgreSQL のアップグレード</a></li>
</ul>
</li>
<li><a class="reference internal" href="#package-jobmngr">1.2.4. ジョブマネージャパッケージ</a><ul>
<li><a class="reference internal" href="#package-jobmngr-install">1.2.4.1. インストール</a></li>
<li><a class="reference internal" href="#package-jobmngr-update">1.2.4.2. アップデート</a></li>
</ul>
</li>
<li><a class="reference internal" href="#package-sendevt">1.2.5. イベント送信パッケージ</a><ul>
<li><a class="reference internal" href="#rhel-centos">1.2.5.1. RHEL/CentOS へのインストール</a></li>
<li><a class="reference internal" href="#windows">1.2.5.2. Windowsへのインストール</a></li>
<li><a class="reference internal" href="#package-sendevt-update">1.2.5.3. アップデート</a></li>
</ul>
</li>
<li><a class="reference internal" href="#offline-install">1.2.6. オフラインインストール</a><ul>
<li><a class="reference internal" href="#kompira-extra">1.2.6.1. インターネット接続環境での kompira-extra パッケージの作成</a></li>
<li><a class="reference internal" href="#id16">1.2.6.2. kompira-extra パッケージを利用したオフラインインストール</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#process">1.3. Kompiraプロセス管理</a><ul>
<li><a class="reference internal" href="#process-architecture">1.3.1. Kompiraのプロセス構成</a></li>
<li><a class="reference internal" href="#process-daemon">1.3.2. Kompiraデーモンの起動・停止・状態確認</a><ul>
<li><a class="reference internal" href="#rhel-centos-7-8">1.3.2.1. RHEL/CentOS 7/8 系の場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#process-jobmngr">1.3.3. Kompiraジョブマネージャの起動・停止・状態確認</a><ul>
<li><a class="reference internal" href="#id21">1.3.3.1. RHEL/CentOS 7/8 系の場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#process-port">1.3.4. Kompira使用ポート一覧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#node">1.4. ノードの設定</a><ul>
<li><a class="reference internal" href="#node-local">1.4.1. ローカルノードの設定</a></li>
<li><a class="reference internal" href="#ssh">1.4.2. SSH ノードの設定</a></li>
<li><a class="reference internal" href="#node-winrs">1.4.3. Windows ノードの設定</a><ul>
<li><a class="reference internal" href="#winrm">1.4.3.1. WinRM のリモート管理を有効にする</a></li>
<li><a class="reference internal" href="#id26">1.4.3.2. WinRM の接続設定を変更する</a></li>
<li><a class="reference internal" href="#id27">1.4.3.3. ジョブフローでの動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#node-device">1.4.4. ネットワーク機器ノードの設定</a><ul>
<li><a class="reference internal" href="#id29">1.4.4.1. 対応機種一覧</a></li>
<li><a class="reference internal" href="#id30">1.4.4.2. ネットワーク機器連携での制限事項</a></li>
<li><a class="reference internal" href="#id31">1.4.4.3. 動作確認を行なった機種情報</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#file">1.5. Kompiraの設定とログファイル</a><ul>
<li><a class="reference internal" href="#file-hierarchy">1.5.1. Kompira標準ディレクトリ</a></li>
<li><a class="reference internal" href="#file-log">1.5.2. Kompiraログ</a></li>
<li><a class="reference internal" href="#file-settings">1.5.3. Kompira設定ファイル</a></li>
<li><a class="reference internal" href="#id36">1.5.4. Kompira画像ファイル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data">1.6. Kompiraのデータバックアップ</a><ul>
<li><a class="reference internal" href="#data-export">1.6.1. Kompiraオブジェクトのエクスポート</a></li>
<li><a class="reference internal" href="#data-import">1.6.2. Kompiraオブジェクトのインポート</a></li>
<li><a class="reference internal" href="#data-backup">1.6.3. バックアップ</a></li>
<li><a class="reference internal" href="#export-data">1.6.4. export_dataのオプション</a></li>
<li><a class="reference internal" href="#export-dir">1.6.5. export_dirのオプション</a></li>
<li><a class="reference internal" href="#import-data">1.6.6. import_dataのオプション</a></li>
<li><a class="reference internal" href="#import-dir">1.6.7. import_dirのオプション</a></li>
</ul>
</li>
<li><a class="reference internal" href="#license">1.7. Kompiraライセンス</a></li>
<li><a class="reference internal" href="#misc">1.8. 秘密鍵の管理</a><ul>
<li><a class="reference internal" href="#misc-keychange">1.8.1. 秘密鍵の変更</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ha">1.9. 冗長構成管理</a><ul>
<li><a class="reference internal" href="#ha-introduction">1.9.1. はじめに</a></li>
<li><a class="reference internal" href="#ha-install">1.9.2. インストール</a><ul>
<li><a class="reference internal" href="#ha-install-primary">1.9.2.1. プライマリ機の設定</a></li>
<li><a class="reference internal" href="#ha-install-secondary">1.9.2.2. セカンダリ機の設定</a></li>
<li><a class="reference internal" href="#ha-install-check">1.9.2.3. 状態確認</a></li>
<li><a class="reference internal" href="#ha-license">1.9.2.4. ライセンス登録</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ha-update">1.9.3. アップデート</a><ul>
<li><a class="reference internal" href="#id52">1.9.3.1. 両系停止アップデート手順（切り替えを伴わない）</a></li>
<li><a class="reference internal" href="#id53">1.9.3.2. 片系停止アップデート手順（切り替えを伴う）</a></li>
<li><a class="reference internal" href="#ha-update-with-pg-upgrade">1.9.3.3. PostgreSQL アップグレードを伴う両系停止アップデート手順</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ha-stop-start">1.9.4. 冗長構成の停止・起動</a><ul>
<li><a class="reference internal" href="#id56">1.9.4.1. 冗長構成の停止</a></li>
<li><a class="reference internal" href="#id57">1.9.4.2. 冗長構成の起動</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ha-recovery">1.9.5. フェイルオーバー時の動作とフェイルバック</a><ul>
<li><a class="reference internal" href="#id59">1.9.5.1. サーバーが復旧可能だった場合</a></li>
<li><a class="reference internal" href="#id60">1.9.5.2. サーバーが復旧不能だった場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setup-cluster-sh">1.9.6. setup_cluster.shのオプション</a></li>
<li><a class="reference internal" href="#sync-master-sh">1.9.7. sync_master.sh のオプション</a></li>
</ul>
</li>
<li><a class="reference internal" href="#audit">1.10. 監査ログ管理</a><ul>
<li><a class="reference internal" href="#id62">1.10.1. はじめに</a><ul>
<li><a class="reference internal" href="#id63">1.10.1.1. 監査ログの対象となる操作</a></li>
<li><a class="reference internal" href="#id64">1.10.1.2. 操作レベルと記録レベル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#audit-logfile">1.10.2. 監査ログファイル</a><ul>
<li><a class="reference internal" href="#id66">1.10.2.1. 監査ログの記録先</a></li>
<li><a class="reference internal" href="#id67">1.10.2.2. 監査ログのファイル形式</a></li>
<li><a class="reference internal" href="#id68">1.10.2.3. 監査ログの記録項目</a></li>
<li><a class="reference internal" href="#id69">1.10.2.4. 監査ログのサンプル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#audit-spec">1.10.3. 監査ログの項目詳細</a><ul>
<li><a class="reference internal" href="#level">1.10.3.1. 操作レベル (level)</a></li>
<li><a class="reference internal" href="#started-finished">1.10.3.2. 操作日時 (started, finished)</a></li>
<li><a class="reference internal" href="#exec">1.10.3.3. 操作元情報 (exec)</a></li>
<li><a class="reference internal" href="#user">1.10.3.4. 操作ユーザ (user)</a></li>
<li><a class="reference internal" href="#interface">1.10.3.5. 操作方式 (interface)</a></li>
<li><a class="reference internal" href="#class">1.10.3.6. 操作分類 (class)</a></li>
<li><a class="reference internal" href="#target-path-target-type">1.10.3.7. 操作対象 (target_path, target_type)</a></li>
<li><a class="reference internal" href="#type">1.10.3.8. 操作種別 (type)</a></li>
<li><a class="reference internal" href="#permit-result">1.10.3.9. 操作の結果 (permit, result)</a></li>
<li><a class="reference internal" href="#detail">1.10.3.10. 詳細情報 (detail)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#audit-config">1.10.4. 設定ファイル</a><ul>
<li><a class="reference internal" href="#id72">1.10.4.1. 設定ファイルの形式</a></li>
<li><a class="reference internal" href="#id73">1.10.4.2. 設定ファイルの自動再読み込み</a></li>
<li><a class="reference internal" href="#id74">1.10.4.3. デフォルトの設定ファイル</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#system-packages">1.11. システムパッケージ管理</a><ul>
<li><a class="reference internal" href="#id76">1.11.1. パッケージ情報の管理コマンド</a><ul>
<li><a class="reference internal" href="#id77">1.11.1.1. パッケージ情報の表示</a></li>
<li><a class="reference internal" href="#id78">1.11.1.2. パッケージ情報の収集</a></li>
<li><a class="reference internal" href="#id79">1.11.1.3. パッケージ情報の更新</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#ssl">1.12. SSL 証明書管理</a><ul>
<li><a class="reference internal" href="#id80">1.12.1. 証明書ファイルの配置</a></li>
<li><a class="reference internal" href="#opt-kompira-ssl-ca-source">1.12.2. /opt/kompira/ssl/ca-source/</a><ul>
<li><a class="reference internal" href="#kompira-local-ca-crt">1.12.2.1. kompira-local-ca.crt</a></li>
<li><a class="reference internal" href="#kompira-other-ca-crt">1.12.2.2. kompira-other-ca.crt</a></li>
</ul>
</li>
<li><a class="reference internal" href="#opt-kompira-ssl-certs">1.12.3. /opt/kompira/ssl/certs/</a><ul>
<li><a class="reference internal" href="#kompira-bundle-ca-crt">1.12.3.1. kompira-bundle-ca.crt</a></li>
<li><a class="reference internal" href="#amqp-server-crt">1.12.3.2. amqp-server.crt</a></li>
<li><a class="reference internal" href="#amqp-client-kompira-crt">1.12.3.3. amqp-client-kompira.crt</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id81">1.12.4. SSL 証明書管理スクリプト</a><ul>
<li><a class="reference internal" href="#id82">1.12.4.1. サーバ側 SSL 環境のセットアップ</a></li>
<li><a class="reference internal" href="#id83">1.12.4.2. クライアント側 SSL 環境のセットアップ</a></li>
<li><a class="reference internal" href="#ca">1.12.4.3. CA 証明書の管理</a></li>
<li><a class="reference internal" href="#ssl-certs-admin-ca-in-cluster">1.12.4.4. 冗長構成での CA 証明書管理</a></li>
<li><a class="reference internal" href="#id85">1.12.4.5. SSL証明書の作成</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="index.html"
                          title="前の章へ">Kompira 1.6.11 ドキュメント</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="usage.html"
                          title="次の章へ"><span class="section-number">2. </span>操作ガイド</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/admin.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="usage.html" title="2. 操作ガイド"
             >次へ</a> |</li>
        <li class="right" >
          <a href="index.html" title="Kompira 1.6.11 ドキュメント"
             >前へ</a> |</li>
<li class="nav-item nav-item-0"><a href="index.html">Kompira 1.6.11 ドキュメント</a> [<a href="../en/admin.html">en</a>|<a href="./kompira.pdf" target="_blank">pdf</a>] &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">1. </span>管理ガイド</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012, Kompira development team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>